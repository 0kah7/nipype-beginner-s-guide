

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nipype Beginner&#39;s Guide &mdash; Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation" href="index.html" />
    <link rel="next" title="Under construction" href="underConstruction.html" />
    <link rel="prev" title="Example of a first level analysis pipeline" href="firstLevelExample.html" />
 
<meta name="keywords" content="nipype, python, guide">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24958678-1']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="index.html">
  <img src="_static/nipype-beginners-guide-banner-bg.png" alt="NIPY logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="underConstruction.html" title="Under construction"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="firstLevelExample.html" title="Example of a first level analysis pipeline"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to create slice figures</a><ul>
<li><a class="reference internal" href="#title1">Title1</a></li>
<li><a class="reference internal" href="#write-pipeline-script">Write pipeline script</a><ul>
<li><a class="reference internal" href="#import-modules">Import modules</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="firstLevelExample.html"
                        title="previous chapter">Example of a first level analysis pipeline</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="underConstruction.html"
                        title="next chapter">Under construction</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/secondLevelExample.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-create-slice-figures">
<h1>How to create slice figures<a class="headerlink" href="#how-to-create-slice-figures" title="Permalink to this headline">¶</a></h1>
<p>TEXT wasi meine</p>
<div class="section" id="title1">
<h2>Title1<a class="headerlink" href="#title1" title="Permalink to this headline">¶</a></h2>
<p>Text</p>
<ul>
<li><dl class="first docutils">
<dt><strong>All consuming pipeline:</strong></dt>
<dd><ul class="first last">
<li><p class="first">Infosource</p>
</li>
<li><p class="first">Datagrabber</p>
</li>
<li><dl class="first docutils">
<dt><strong>Metaworkflow:</strong></dt>
<dd><ul class="first last">
<li><p class="first">Inputnode (func, subject_id, session_info, contrasts)</p>
</li>
<li><dl class="first docutils">
<dt><strong>Preprocess pipeline:</strong></dt>
<dd><ul class="first last simple">
<li>SliceTiming</li>
<li>Realign</li>
<li>ArtifactDetect</li>
<li>BBRegister</li>
<li>Smooth</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>Volume analysis pipeline:</strong></dt>
<dd><ul class="first last simple">
<li>SpecifyModel</li>
<li>Level1Design</li>
<li>EstimateModel</li>
<li>EstimateContrast</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>Normalization pipeline:</strong></dt>
<dd><ul class="first last simple">
<li>MRIConvert</li>
<li>FreeSurferSource</li>
<li>Segment</li>
<li>ApplyVolTransform</li>
<li>Normalize</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">Datasink</p>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Below I&#8217;ve visualized the structure of our pipeline and most of the connections
between the nodes.</p>
<img alt="workflow.png" src="workflow.png" style="width: 600px;" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Some may ask  why we haven&#8217;t included the infosource, datagrabber and datasink
nodes into the metaworkflow.</p>
<p class="last">Because those nodes dependent highly on the paradigma specific parameters and
will change for every model we want to separat them from the metaworkflow which
will stay more or less the same for similar experiments. This does also give us
the opportunity to just import this metaworkflow from this script into a new
pipeline script and reuse it.</p>
</div>
</div>
<div class="section" id="write-pipeline-script">
<h2>Write pipeline script<a class="headerlink" href="#write-pipeline-script" title="Permalink to this headline">¶</a></h2>
<p>Now that we have defined how the structure of our pipeline and the connections
should be we can start with writing the pipeline script.</p>
<div class="section" id="import-modules">
<h3>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this headline">¶</a></h3>
<p>First we have to import all necessary modules.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">##################################</span>
<span class="sd">&quot;&quot;&quot;Setup level 2 vol pipeline&quot;&quot;&quot;</span> <span class="c">#</span>
<span class="c">##################################</span>

<span class="c"># collect all the con images for each contrast.</span>
<span class="n">contrast_ids</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrasts</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">l2source</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;con&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;l2source&quot;</span><span class="p">)</span>
<span class="n">l2source</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span><span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/asens_normbrains_diff/asens_*/normcons/con_</span><span class="si">%04d</span><span class="s">_ants.nii&#39;</span>
<span class="n">l2source</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;con&#39;</span><span class="p">,</span><span class="n">contrast_ids</span><span class="p">)]</span> <span class="c"># iterate over all contrast images</span>

<span class="c">#Node: OneSampleTTest - to perform a simple statistical analysis of the contrasts from the group of subjects</span>
<span class="n">onesamplettestdes</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">OneSampleTTestDesign</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;onesampttestdes&quot;</span><span class="p">)</span>

<span class="c">#Node: MultipleRegressionDesign - to perform a simple statistical analysis of the contrasts from the group of subjects</span>
<span class="c">#multipleRegDes = pe.Node(interface=spm.MultipleRegressionDesign(), name=&quot;multipleRegDes&quot;)</span>
<span class="c">#multipleRegDes.inputs.covariates = [dict(vector=[-0.301,0.521,1.759,0.097,1.388,0.445,0.304,2.421,1.595,-0.276,0.361,0.301,1.506,0.985,-1.039],</span>
<span class="c">#                                         name=&#39;metric_dprime_diff&#39;),</span>
<span class="c">#                                    dict(vector=[1.555,1.806,0.767,1.5,1.878,0.582,0.99,0.574,2.12,3.423,0.909,0.783,-0.33,2.549,1.857],</span>
<span class="c">#                                         name=&#39;diff_dprime_diff&#39;)]</span>

<span class="c">#Node: EstimateModel</span>
<span class="n">l2estimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">EstimateModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;level2estimate&quot;</span><span class="p">)</span>
<span class="n">l2estimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">estimation_method</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Classical&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="c">#Node: EstimateContrast</span>
<span class="n">l2conestimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">spm</span><span class="o">.</span><span class="n">EstimateContrast</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;level2conestimate&quot;</span><span class="p">)</span>
<span class="n">cont1</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Group&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;mean&#39;</span><span class="p">],[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">l2conestimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">cont1</span><span class="p">]</span>
<span class="n">l2conestimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">group_contrast</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c">#Node: Threshold</span>
<span class="n">level2thresh</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">spm</span><span class="o">.</span><span class="n">Threshold</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;level2thresh&quot;</span><span class="p">)</span>
<span class="n">level2thresh</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrast_index</span> <span class="o">=</span> <span class="mi">1</span>      <span class="c">#mandatory - contrast_index : (an integer) which contrast in the SPM.mat to use</span>
<span class="n">level2thresh</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">extent_fdr_p_threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">level2thresh</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">height_threshold</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">level2thresh</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">extent_threshold</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">level2thresh</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">use_fwe_correction</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">level2thresh</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">use_topo_fdr</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c">#Create 2-level pipeline and connect up all components</span>
<span class="n">level2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;level2&quot;</span><span class="p">)</span>
<span class="n">level2</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="n">nameOflevel2Out</span>
<span class="n">level2</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">l2source</span><span class="p">,</span><span class="n">onesamplettestdes</span><span class="p">,[(</span><span class="s">&#39;outfiles&#39;</span><span class="p">,</span><span class="s">&#39;in_files&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">onesamplettestdes</span><span class="p">,</span><span class="n">l2estimate</span><span class="p">,[(</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">,</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">l2estimate</span><span class="p">,</span><span class="n">l2conestimate</span><span class="p">,[(</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">,</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">),</span>
                                           <span class="p">(</span><span class="s">&#39;beta_images&#39;</span><span class="p">,</span><span class="s">&#39;beta_images&#39;</span><span class="p">),</span>
                                           <span class="p">(</span><span class="s">&#39;residual_image&#39;</span><span class="p">,</span><span class="s">&#39;residual_image&#39;</span><span class="p">)]),</span>
                <span class="p">(</span><span class="n">l2conestimate</span><span class="p">,</span> <span class="n">level2thresh</span><span class="p">,[(</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">,</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">),</span>
                                              <span class="p">(</span><span class="s">&#39;spmT_images&#39;</span><span class="p">,</span><span class="s">&#39;stat_image&#39;</span><span class="p">),</span>
                                              <span class="p">]),</span>

                <span class="p">])</span>


<span class="c">###################################</span>
<span class="sd">&quot;&quot;&quot;Setup level 2 surf pipeline&quot;&quot;&quot;</span> <span class="c">#</span>
<span class="c">###################################</span>

<span class="n">l2flow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;l2_surf&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>l2flow.base_dir = experiment_dir + nameOflevel2Out + &#8216;_surf&#8217;</p>
<p>#Setup a dummy node to iterate over contrasts and hemispheres
l2inputnode = pe.Node(interface=util.IdentityInterface(fields=[&#8216;contrasts&#8217;,&#8217;hemi&#8217;]),</p>
<blockquote>
name=&#8217;inputnode&#8217;)</blockquote>
<dl class="docutils">
<dt>l2inputnode.iterables = [(&#8216;contrasts&#8217;, range(1,len(contrasts)+1)),</dt>
<dd>(&#8216;hemi&#8217;, [&#8216;lh&#8217;,&#8217;rh&#8217;])]</dd>
</dl>
<p>#Use a datagrabber node to collect contrast images and registration files
l2source_surf = pe.Node(interface=nio.DataGrabber(infields=[&#8216;con_id&#8217;],</p>
<blockquote>
<blockquote>
outfields=[&#8216;con&#8217;,&#8217;reg&#8217;]),</blockquote>
<p>name=&#8217;l2source_surf&#8217;)</p>
</blockquote>
<p>l2source_surf.inputs.base_directory = experiment_dir + &#8216;/&#8217; + nameOflevel1Out + &#8216;/&#8217;
l2source_surf.inputs.template = &#8216;*&#8217;
l2source_surf.inputs.field_template = dict(con=&#8217;surf_contrasts/_subject_id_*/con_%04d.img&#8217;,</p>
<blockquote>
reg=&#8217;bbregister/_subject_id_*/<a href="#id1"><span class="problematic" id="id2">*</span></a>.dat&#8217;)</blockquote>
<p>l2source_surf.inputs.template_args = dict(con=[[&#8216;con_id&#8217;]],reg=[[]])</p>
<p>#Merge contrast images and registration files
mergenode = pe.Node(interface=util.Merge(2, axis=&#8217;hstack&#8217;),name=&#8217;merge&#8217;)</p>
<dl class="docutils">
<dt>def ordersubjects(files, subj_list):</dt>
<dd><blockquote class="first">
<p>outlist = []
for s in subj_list:</p>
<blockquote>
<dl class="docutils">
<dt>for f in files:</dt>
<dd><dl class="first last docutils">
<dt>if &#8216;/_subject_id_%s/&#8217;%s in f:</dt>
<dd>outlist.append(f)
continue</dd>
</dl>
</dd>
</dl>
</blockquote>
<p>print outlist
return outlist</p>
</blockquote>
<p>#Concatenate contrast images projected to fsaverage
l2concat = pe.Node(interface=fs.MRISPreproc(), name=&#8217;concat&#8217;)
l2concat.inputs.target = &#8216;fsaverage&#8217;
l2concat.inputs.fwhm = 5</p>
<dl class="docutils">
<dt>def list2tuple(listoflist):</dt>
<dd>return [tuple(x) for x in listoflist]</dd>
</dl>
<p>#Node: OneSampleTTest - Perform a one sample t-test
l2ttest = pe.Node(interface=fs.OneSampleTTest(), name=&#8217;onesample&#8217;)</p>
<p>#Node: Datasink - Create a datasink node to store important outputs
datasink_2l = pe.Node(interface=nio.DataSink(), name=&#8221;datasink_2l&#8221;)
datasink_2l.inputs.base_directory = experiment_dir
datasink_2l.inputs.container = nameOflevel2Out[1:] + &#8216;_surf&#8217;</p>
<p>#Create 2-level surf pipeline and connect up all components
l2flow.connect([(l2inputnode,l2source_surf,[(&#8216;contrasts&#8217;,&#8217;con_id&#8217;)]),</p>
<blockquote>
<p>(l2inputnode,l2concat,[(&#8216;hemi&#8217;,&#8217;hemi&#8217;)]),
(l2source_surf,mergenode,[((&#8216;con&#8217;, ordersubjects, subjects),&#8217;in1&#8217;),</p>
<blockquote>
((&#8216;reg&#8217;, ordersubjects, subjects),&#8217;in2&#8217;)]),</blockquote>
<p>(mergenode,l2concat,[((&#8216;out&#8217;, list2tuple),&#8217;vol_measure_file&#8217;)]),
(l2concat,l2ttest,[(&#8216;out_file&#8217;,&#8217;in_file&#8217;)]),
(l2ttest,datasink_2l,[(&#8216;sig_file&#8217;,&#8217;sig_file&#8217;)]),
])</p>
</blockquote>
<p>level2.write_graph(graph2use=&#8217;flat&#8217;)
level2.run(plugin=&#8217;MultiProc&#8217;, plugin_args={&#8216;n_procs&#8217; : 2})</p>
<p class="last">#l2flow.write_graph(graph2use=&#8217;flat&#8217;)
#l2flow.run(plugin=&#8217;MultiProc&#8217;, plugin_args={&#8216;n_procs&#8217; : 2})</p>
</dd>
</dl>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="underConstruction.html" title="Under construction"
             >next</a> |</li>
        <li class="right" >
          <a href="firstLevelExample.html" title="Example of a first level analysis pipeline"
             >previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Michael Notter.
      Last updated on August 05, 2011.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
</div>

  </body>
</html>