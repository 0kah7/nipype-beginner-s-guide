

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nipype Beginner&#39;s Guide &mdash; Beginner&#39;s Guide to Nipype v0.4 v0.5 documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Beginner&#39;s Guide to Nipype v0.4 v0.5 documentation" href="index.html" />
    <link rel="next" title="Ideas For Future Chapters" href="futureChapters.html" />
    <link rel="prev" title="How To Build A Second Level Pipeline" href="secondLevelExample.html" />
 
<meta name="keywords" content="nipype, python, guide">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24958678-1']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="index.html">
  <img src="_static/nipype-beginners-guide-banner-bg.png" alt="NIPY logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="futureChapters.html" title="Ideas For Future Chapters"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="secondLevelExample.html" title="How To Build A Second Level Pipeline"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How To Extract Regions Of Interest (ROIs)</a><ul>
<li><a class="reference internal" href="#anatomical-and-functional-roi">Anatomical and Functional ROI</a><ul>
<li><a class="reference internal" href="#anatomical-roi">Anatomical ROI</a></li>
<li><a class="reference internal" href="#functional-roi">Functional ROI</a></li>
</ul>
</li>
<li><a class="reference internal" href="#anatomical-roi-pipeline">Anatomical ROI Pipeline</a><ul>
<li><a class="reference internal" href="#import-modules">Import modules</a></li>
<li><a class="reference internal" href="#define-experiment-specific-parameters">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#define-aroi-specific-parameters">Define aROI specific parameters</a></li>
<li><a class="reference internal" href="#define-nodes">Define nodes</a></li>
<li><a class="reference internal" href="#definition-of-anatomical-roi-workflow">Definition of anatomical ROI workflow</a></li>
<li><a class="reference internal" href="#run-pipeline-and-generate-graph">Run pipeline and generate graph</a></li>
<li><a class="reference internal" href="#visualization-of-the-anatomical-roi-pipeline">Visualization of the anatomical ROI pipeline</a></li>
<li><a class="reference internal" href="#summarizing-the-output-in-a-cvs-file">Summarizing the output in a cvs-file</a></li>
<li><a class="reference internal" href="#folder-structure-after-aroiflow">Folder structure after <tt class="docutils literal"><span class="pre">aROIflow</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#functional-roi-pipeline">Functional ROI Pipeline</a><ul>
<li><a class="reference internal" href="#id2">Import modules</a></li>
<li><a class="reference internal" href="#id3">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#define-froi-specific-parameters">Define fROI specific parameters</a></li>
<li><a class="reference internal" href="#definition-of-nodes">Definition of Nodes</a></li>
<li><a class="reference internal" href="#definition-of-functional-roi-workflow">Definition of functional ROI workflow</a></li>
<li><a class="reference internal" href="#run-the-pipeline-and-generate-the-graph">Run the pipeline and generate the graph</a></li>
<li><a class="reference internal" href="#visualization-of-the-functional-roi-pipeline">Visualization of the functional ROI pipeline</a></li>
<li><a class="reference internal" href="#id4">Summarizing the output in a cvs-file</a></li>
<li><a class="reference internal" href="#folder-structure-after-froiflow">Folder structure after <tt class="docutils literal"><span class="pre">fROIflow</span></tt></a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="secondLevelExample.html"
                        title="previous chapter">How To Build A Second Level Pipeline</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="futureChapters.html"
                        title="next chapter">Ideas For Future Chapters</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/regionOfInterest.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-extract-regions-of-interest-rois">
<h1>How To Extract Regions Of Interest (ROIs)<a class="headerlink" href="#how-to-extract-regions-of-interest-rois" title="Permalink to this headline">¶</a></h1>
<p>In this part we will learn how to extract statistical data from a strictly specified region or in other words a <strong>region of interest (ROI)</strong>.</p>
<div class="section" id="anatomical-and-functional-roi">
<h2>Anatomical and Functional ROI<a class="headerlink" href="#anatomical-and-functional-roi" title="Permalink to this headline">¶</a></h2>
<p>We will learn how to extract anatomical and functional ROIs, two ways of extraction which differ mostly by the way how they define a region of interest.</p>
<div class="section" id="anatomical-roi">
<h3>Anatomical ROI<a class="headerlink" href="#anatomical-roi" title="Permalink to this headline">¶</a></h3>
<p>The region of an anatomical ROI is as the name implies defined by the anatomical structure of the brain (e.g. Thalamus, Putamen, Ventricle, Amygdala etc.). Such definitions of anatomical regions and there segmentations is stored in so called <strong>atlas</strong>. A well known atlas which is used by <strong>Nipype</strong> by default is the <a class="reference external" href="http://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT">FreeSurfer Color Table</a>.</p>
<p>This color table subdivides the brain in over 1000 different anatomical regions. The <strong>FreeSurfer Color Table</strong> enables to differentiate between gray and white matter areas. The table is divided into different sections. For the extraction of anatomical ROIs we are interested in the <strong>original Segmentation</strong> and in the <strong>2009 Segmentation</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that this separation between original and 2009 version of segmentation is defined by me and how I would subdivide the color table and by no means represent the structure that FreeSurfer intended.</p>
</div>
<p>The following list shows a part of the <strong>FreeSurfer Color Table</strong>. Import for us is the segmentation <strong>id</strong> and segmentation <strong>name</strong>, shown in the first two columns.</p>
<div class="highlight-none"><div class="highlight"><pre>#No. Label Name:                            R   G   B   A
[...]
9   Left-Thalamus                           0   118 14  0
10  Left-Thalamus-Proper                    0   118 14  0
11  Left-Caudate                            122 186 220 0
12  Left-Putamen                            236 13  176 0
13  Left-Pallidum                           12  48  255 0
14  3rd-Ventricle                           204 182 142 0
15  4th-Ventricle                           42  204 164 0
16  Brain-Stem                              119 159 176 0
17  Left-Hippocampus                        220 216 20  0
18  Left-Amygdala                           103 255 255 0
19  Left-Insula                             80  196 98  0
20  Left-Operculum                          60  58  210 0
[...]
48  Right-Thalamus                          0   118 14  0
49  Right-Thalamus-Proper                   0   118 14  0
50  Right-Caudate                           122 186 220 0
51  Right-Putamen                           236 13  176 0
52  Right-Pallidum                          13  48  255 0
53  Right-Hippocampus                       220 216 20  0
54  Right-Amygdala                          103 255 255 0
55  Right-Insula                            80  196 98  0
56  Right-Operculum                         60  58  210 0
[...]
</pre></div>
</div>
<p>The ids from <em>1 to 999</em> can be found in the original as well as in the 2009 version of segmentation. The ids <em>1000 to 8014</em> can only be found in the <strong>original version</strong> and the ids <em>11100 to 14175</em> can only be found in the <strong>2009 version</strong> of segmentation.</p>
<p><strong>Visualization of original Segmentation</strong>: The following picture shows you the labels of the original segmentation. The annotation of which color belongs to which region is stored in <tt class="docutils literal"><span class="pre">~SOMEPATH/experiment/freesurfer_data/fsaverage/label/lh.aparc.annot</span></tt> (if you&#8217;re interested in the left hemisphere)</p>
<img alt="_images/segorig.png" src="_images/segorig.png" style="width: 810px;" />
<p><strong>Visualization of 2009 Segmentation</strong>: The following picture shows you the labels of the 2009 segmentation. The annotation of which color belongs to which region is stored in <tt class="docutils literal"><span class="pre">~SOMEPATH/experiment/freesurfer_data/fsaverage/label/rh.aparc.a2009s.annot</span></tt> (if you&#8217;re interested in the right hemisphere)</p>
<img alt="_images/seg2009.png" src="_images/seg2009.png" style="width: 810px;" />
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">If you want to explore those regions by ourself I recommend to open a <strong>FreeSurfer</strong> capable viewing tool and overlay the annotation file from the <tt class="docutils literal"><span class="pre">fsaverage/label</span></tt> folder.</p>
</div>
</div>
<div class="section" id="functional-roi">
<h3>Functional ROI<a class="headerlink" href="#functional-roi" title="Permalink to this headline">¶</a></h3>
<p>The region of functional ROIs is solely defined by what point in &#8220;brain&#8221;-space you are interested in. You&#8217;re region of interest is most likely where there is a peak or interesting activation in your functional data, hence its name. The specification of the region can be done in different ways. Some may want to look at a cubic region with the point of interest as its center. Others want to extract a spherical region around a point of interest. And this is exactly what we will be doing in this chapter.</p>
<p><strong>Visualization of a functional ROI</strong>: The following picture shows a spherical region with radius 10 voxel around the point of interest [110, 128, 142] in MNI-space.</p>
<img alt="_images/fROI3.png" src="_images/fROI3.png" style="width: 810px;" />
</div>
</div>
<div class="section" id="anatomical-roi-pipeline">
<h2>Anatomical ROI Pipeline<a class="headerlink" href="#anatomical-roi-pipeline" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s now begin with the creation of an <strong>anatomical ROI pipeline</strong>.</p>
<div class="section" id="import-modules">
<h3>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>                                    <span class="c"># system functions</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.freesurfer</span> <span class="kn">as</span> <span class="nn">fs</span>    <span class="c"># freesurfer</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">as</span> <span class="nn">nio</span>           <span class="c"># i/o routines</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">as</span> <span class="nn">util</span>     <span class="c"># utility</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">as</span> <span class="nn">pe</span>          <span class="c"># pypeline engine</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-experiment-specific-parameters">
<h3>Define experiment specific parameters<a class="headerlink" href="#define-experiment-specific-parameters" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#to better access the parent folder of the experiment</span>
<span class="n">experiment_dir</span> <span class="o">=</span> <span class="s">&#39;~SOMEPATH/experiment&#39;</span>

<span class="c"># Tell freesurfer what subjects directory to use</span>
<span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/freesurfer_data&#39;</span>
<span class="n">fs</span><span class="o">.</span><span class="n">FSCommand</span><span class="o">.</span><span class="n">set_default_subjects_dir</span><span class="p">(</span><span class="n">subjects_dir</span><span class="p">)</span>

<span class="c">#dirnames for anatomical ROI pipeline</span>
<span class="n">aROIOutput</span> <span class="o">=</span> <span class="s">&#39;aROI_output&#39;</span>      <span class="c">#location and name of aROI datasink</span>
<span class="n">l1contrastDir</span> <span class="o">=</span> <span class="s">&#39;level1_output&#39;</span> <span class="c">#name of first level datasink</span>

<span class="c">#list of subjectnames</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;subject1&#39;</span><span class="p">,</span> <span class="s">&#39;subject2&#39;</span><span class="p">,</span> <span class="s">&#39;subject3&#39;</span><span class="p">]</span>

<span class="c">#list of contrastnumbers the pipeline should consider</span>
<span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;01&#39;</span><span class="p">,</span><span class="s">&#39;02&#39;</span><span class="p">,</span><span class="s">&#39;03&#39;</span><span class="p">,</span><span class="s">&#39;04&#39;</span><span class="p">,</span><span class="s">&#39;05&#39;</span><span class="p">]</span>

<span class="c">#name of the first session from the first level pipeline</span>
<span class="n">nameOfFirstSession</span> <span class="o">=</span> <span class="s">&#39;func1&#39;</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <strong>name of the first session</strong> is necessary, because the bbregister file from the first level pipeline contains the name of the first session in its name. E.g. if the first condition is <tt class="docutils literal"><span class="pre">func1</span></tt>, than the name of the bbregister file for the second subject is <tt class="docutils literal"><span class="pre">meanafunc1_bbreg_subject2.dat</span></tt>.</p>
</div>
</div>
<div class="section" id="define-aroi-specific-parameters">
<h3>Define aROI specific parameters<a class="headerlink" href="#define-aroi-specific-parameters" title="Permalink to this headline">¶</a></h3>
<p>As mentioned above we are using the <a class="reference external" href="http://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT">FreeSurfer Color Table</a> to define the anatomical regions. Let&#8217;s assume that we want to extract the following regions:</p>
<ul class="simple">
<li>id <tt class="docutils literal"><span class="pre">11</span></tt> ; <tt class="docutils literal"><span class="pre">Left-Caudate</span></tt> ; from <strong>both</strong> segmentations</li>
<li>id <tt class="docutils literal"><span class="pre">50</span></tt> ; <tt class="docutils literal"><span class="pre">Right-Caudate</span></tt> ; from <strong>both</strong> segmentations</li>
<li>id <tt class="docutils literal"><span class="pre">12</span></tt> ; <tt class="docutils literal"><span class="pre">Left-Putamen</span></tt> ; from <strong>both</strong> segmentations</li>
<li>id <tt class="docutils literal"><span class="pre">51</span></tt> ; <tt class="docutils literal"><span class="pre">Right-Putamen</span></tt> ; from <strong>both</strong> segmentations</li>
<li>id <tt class="docutils literal"><span class="pre">1007</span></tt> ; <tt class="docutils literal"><span class="pre">ctx-lh-fusiform</span></tt> ; from the <strong>original</strong> segmentation</li>
<li>id <tt class="docutils literal"><span class="pre">2007</span></tt> ; <tt class="docutils literal"><span class="pre">ctx-rh-fusiform</span></tt> ; from the <strong>original</strong> segmentation</li>
<li>id <tt class="docutils literal"><span class="pre">1022</span></tt> ; <tt class="docutils literal"><span class="pre">ctx-lh-postcentral</span></tt> ; from the <strong>original</strong> segmentation</li>
<li>id <tt class="docutils literal"><span class="pre">2022</span></tt> ; <tt class="docutils literal"><span class="pre">ctx-rh-postcentral</span></tt> ; from the <strong>original</strong> segmentation</li>
<li>id <tt class="docutils literal"><span class="pre">11134</span></tt> ; <tt class="docutils literal"><span class="pre">ctx_lh_G_temp_sup-Lateral</span></tt> ; from the <strong>2009</strong> segmentation</li>
<li>id <tt class="docutils literal"><span class="pre">12134</span></tt> ; <tt class="docutils literal"><span class="pre">ctx_rh_G_temp_sup-Lateral</span></tt> ; from the <strong>2009</strong> segmentation</li>
</ul>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Specification of the regions from the original and</span>
<span class="c">#the 2009 segmentation version of the FreeSurfer Color Table</span>
<span class="n">ROIregionsorig</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;11&#39;</span><span class="p">,</span><span class="s">&#39;50&#39;</span><span class="p">,</span><span class="s">&#39;12&#39;</span><span class="p">,</span><span class="s">&#39;51&#39;</span><span class="p">,</span><span class="s">&#39;1007&#39;</span><span class="p">,</span><span class="s">&#39;2007&#39;</span><span class="p">,</span><span class="s">&#39;1022&#39;</span><span class="p">,</span><span class="s">&#39;2022&#39;</span><span class="p">]</span>
<span class="n">ROIregions2009</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;11134&#39;</span><span class="p">,</span><span class="s">&#39;12134&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no harm by defining a segmentation id in the wrong segmentation version, but if you specify an id between 1000 to 9999 in the <tt class="docutils literal"><span class="pre">ROIregions2009</span></tt> list, you just won&#8217;t extract any other value than 0 from your data.</p>
</div>
</div>
<div class="section" id="define-nodes">
<h3>Define nodes<a class="headerlink" href="#define-nodes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: IdentityInterface - to iterate over subjects and contrasts</span>
<span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">]),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">&#39;inputnode&#39;</span><span class="p">)</span>
<span class="n">inputnode</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjects</span><span class="p">),</span>
                       <span class="p">(</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">)]</span>
</pre></div>
</td></tr></table></div>
<p>As always when we define the <tt class="docutils literal"><span class="pre">DataGrabber</span></tt> node, it is important to be aware of the structure and the files that we want to grab. In this case we want to grab the subject specific contrasts and bbregister file from the first level pipeline.</p>
<p>In our version the <strong>second contrast</strong> for the <strong>third subject</strong> can be found at: <tt class="docutils literal"><span class="pre">~SOMEPATH/experiment/results/level1_output/vol_contrast/_subject_id_subject3/</span>
<span class="pre">con0002.img</span></tt> and the <strong>bbregister file</strong> for the <strong>first subject</strong> can be found at: <tt class="docutils literal"><span class="pre">~SOMEPATH/experiment/results/level1_output/bbregister/_subject_id_subject1/</span>
<span class="pre">meanafunc1_bbreg_subject1.dat</span></tt>. Knowing this, we can build our <tt class="docutils literal"><span class="pre">datagrabber</span></tt> node as follows:</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: DataGrabber - to grab the input data</span>
<span class="n">datasource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">],</span>
                                               <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;contrast&#39;</span><span class="p">,</span><span class="s">&#39;bb_id&#39;</span><span class="p">]),</span>
                     <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;datasource&#39;</span><span class="p">)</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/results/&#39;</span> <span class="o">+</span> <span class="n">l1contrastDir</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/_subject_id_</span><span class="si">%s</span><span class="s">/</span><span class="si">%s%s%s</span><span class="s">&#39;</span>

<span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">contrast</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;vol_contrasts&#39;</span><span class="p">,</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;con_00&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span><span class="s">&#39;.img&#39;</span><span class="p">]],</span>
            <span class="n">bb_id</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;bbregister&#39;</span><span class="p">,</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;meana&#39;</span><span class="o">+</span><span class="n">nameOfFirstSession</span><span class="o">+</span><span class="s">&#39;_bbreg_&#39;</span><span class="p">,</span>
                      <span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;.dat&#39;</span><span class="p">]])</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="n">info</span>
</pre></div>
</td></tr></table></div>
<p>Let&#8217;s now continue with the implementation of the other nodes that we need for our <strong>anatomical ROI pipeline</strong>.</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: FreeSurferSource - to grab FreeSurfer files from the recon-all process</span>
<span class="n">fssource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">FreeSurferSource</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fssource&#39;</span><span class="p">)</span>
<span class="n">fssource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">subjects_dir</span>

<span class="c">#Node: MRIConvert - to convert files from FreeSurfer format into nifti format</span>
<span class="n">MRIconversion</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">MRIConvert</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;MRIconversion&#39;</span><span class="p">)</span>
<span class="n">MRIconversion</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_type</span> <span class="o">=</span> <span class="s">&#39;nii&#39;</span>

<span class="c">#Node: ApplyVolTransform - to transform contrasts into anatomical space</span>
<span class="c">#                          creates &#39;con_*.anat.bb.mgh&#39; files</span>
<span class="n">transformation</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">ApplyVolTransform</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;transformation&#39;</span><span class="p">)</span>
<span class="n">transformation</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fs_target</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">transformation</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s">&#39;nearest&#39;</span>

<span class="c">#Node: SegStatsorig - to extract specified regions of the original segmentation</span>
<span class="n">segmentationorig</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">SegStats</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;segmentationorig&#39;</span><span class="p">)</span>
<span class="n">segmentationorig</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">segment_id</span> <span class="o">=</span> <span class="n">ROIregionsorig</span>

<span class="c">#Node: SegStats2009 - to extract specified regions of the 2009 segmentation</span>
<span class="n">segmentation2009</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">SegStats</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;segmentation2009&#39;</span><span class="p">)</span>
<span class="n">segmentation2009</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">segment_id</span> <span class="o">=</span> <span class="n">ROIregions2009</span>

<span class="c">#Node: Datasink - Creates a datasink node to store important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;datasink&quot;</span><span class="p">)</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/results&#39;</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">aROIOutput</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>We implement two <tt class="docutils literal"><span class="pre">SegStats</span></tt> nodes because we have two lists of segmentation, the <tt class="docutils literal"><span class="pre">original</span></tt> and the <tt class="docutils literal"><span class="pre">2009</span></tt> one. It might be possible two feed those values into one node with an iterable, but I prefere this way.</p>
<p class="last">If you don&#8217;t specify a value for <tt class="docutils literal"><span class="pre">segment_id</span></tt> the pipeline will extract all regions of your atlas. This is not bad but can take a long time.</p>
</div>
</div>
<div class="section" id="definition-of-anatomical-roi-workflow">
<h3>Definition of anatomical ROI workflow<a class="headerlink" href="#definition-of-anatomical-roi-workflow" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Initiation of the ROI extraction workflow</span>
<span class="n">aROIflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;aROIflow&#39;</span><span class="p">)</span>
<span class="n">aROIflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/results/workingdir_aROI&#39;</span>
</pre></div>
</td></tr></table></div>
<p>Before we can start with the integration of the nodes into <tt class="docutils literal"><span class="pre">aROIflow</span></tt> we have to be aware about something. If we would try to simply connect <tt class="docutils literal"><span class="pre">fssource</span></tt> with <tt class="docutils literal"><span class="pre">segmentationorig</span></tt> like this...</p>
<div class="highlight-py"><div class="highlight"><pre><span class="o">...</span><span class="p">(</span><span class="n">fssource</span><span class="p">,</span> <span class="n">segmentationorig</span><span class="p">,[(</span><span class="s">&#39;aparc_aseg&#39;</span><span class="p">,</span><span class="s">&#39;segmentation_file&#39;</span><span class="p">)]),</span>
</pre></div>
</div>
<p>... we would get the following error:</p>
<div class="highlight-py"><pre>Node: segmentationorig
input: segmentation_file
TraitError: The 'segmentation_file' trait of a SegStatsInputSpec instance must be an
existing file name, but a value of ['~SOMEPATH/experimentfreesurfer_data/
subject1/mri/aparc+aseg.mgz', '~SOMEPATH/experiment/freesurfer_data/subject1/mri
/aparc.a2009s+aseg.mgz'] &lt;type 'list'&gt; was specified.</pre>
</div>
<p>This means that the output of the <tt class="docutils literal"><span class="pre">fssource</span></tt> node has the value: <tt class="docutils literal"><span class="pre">['~SOMEPATH/experiment/freesurfer_data/subject1/mri/aparc+aseg.mgz',</span> <span class="pre">'~SOMEPATH/experiment/freesurfer_data/subject1/mri/aparc.a2009s+aseg.mgz']</span></tt>. That means we have to guide the output of this node so that <tt class="docutils literal"><span class="pre">segmentationorig</span></tt> receives the path to <tt class="docutils literal"><span class="pre">aparc+aseg.mgz</span></tt> and that <tt class="docutils literal"><span class="pre">segmentation2009</span></tt> receives the path to <tt class="docutils literal"><span class="pre">aparc.a2009s+aseg.mgz</span></tt>.</p>
<p>This can be achieved with a simple function:</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getVersion</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">in_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">in_file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Now we are ready to build our <strong>anatomical ROI pipeline</strong>.</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Connect up all components</span>
<span class="n">aROIflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;subject_id&#39;</span><span class="p">),</span>
                                          <span class="p">(</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">),</span>
                                          <span class="p">]),</span>
                  <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">fssource</span><span class="p">,[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">fssource</span><span class="p">,</span> <span class="n">segmentationorig</span><span class="p">,[((</span><span class="s">&#39;aparc_aseg&#39;</span><span class="p">,</span><span class="n">getVersion</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                                 <span class="s">&#39;segmentation_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">fssource</span><span class="p">,</span> <span class="n">segmentation2009</span><span class="p">,[((</span><span class="s">&#39;aparc_aseg&#39;</span><span class="p">,</span><span class="n">getVersion</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                                 <span class="s">&#39;segmentation_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">MRIconversion</span><span class="p">,[(</span><span class="s">&#39;contrast&#39;</span><span class="p">,</span><span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">MRIconversion</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,[(</span><span class="s">&#39;out_file&#39;</span><span class="p">,</span><span class="s">&#39;source_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,[(</span><span class="s">&#39;bb_id&#39;</span><span class="p">,</span><span class="s">&#39;reg_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">transformation</span><span class="p">,</span> <span class="n">segmentationorig</span><span class="p">,[(</span><span class="s">&#39;transformed_file&#39;</span><span class="p">,</span>
                                                      <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">transformation</span><span class="p">,</span> <span class="n">segmentation2009</span><span class="p">,[(</span><span class="s">&#39;transformed_file&#39;</span><span class="p">,</span>
                                                      <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">segmentationorig</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,[(</span><span class="s">&#39;summary_file&#39;</span><span class="p">,</span> <span class="s">&#39;segstatorig&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">segmentation2009</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,[(</span><span class="s">&#39;summary_file&#39;</span><span class="p">,</span> <span class="s">&#39;segstat2009&#39;</span><span class="p">)]),</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="run-pipeline-and-generate-graph">
<h3>Run pipeline and generate graph<a class="headerlink" href="#run-pipeline-and-generate-graph" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">aROIflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s">&#39;flat&#39;</span><span class="p">)</span>
<span class="n">aROIflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;n_procs&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="visualization-of-the-anatomical-roi-pipeline">
<h3>Visualization of the anatomical ROI pipeline<a class="headerlink" href="#visualization-of-the-anatomical-roi-pipeline" title="Permalink to this headline">¶</a></h3>
<p>This graph of the <tt class="docutils literal"><span class="pre">hierarchical</span></tt> version shows the <tt class="docutils literal"><span class="pre">aROIflow</span></tt>:</p>
<img alt="_images/aROI_hierachical.png" src="_images/aROI_hierachical.png" style="width: 810px;" />
<p>This detailed graph of the <tt class="docutils literal"><span class="pre">flat</span></tt> version shows the <tt class="docutils literal"><span class="pre">aROIflow</span></tt>:</p>
<img alt="_images/aROI_detailed.png" src="_images/aROI_detailed.png" style="width: 1080px;" />
</div>
<div class="section" id="summarizing-the-output-in-a-cvs-file">
<h3>Summarizing the output in a cvs-file<a class="headerlink" href="#summarizing-the-output-in-a-cvs-file" title="Permalink to this headline">¶</a></h3>
<p>This part is optional and shows only one of many ways how you can summarize the output of <tt class="docutils literal"><span class="pre">aROIflow</span></tt> into a common cvs-file. In essence it does the following steps for each contrast:</p>
<ul class="simple">
<li>grab contrast and subject specific <tt class="docutils literal"><span class="pre">summary.stats</span></tt> file</li>
<li>extract values from this file and store it into a list</li>
<li>add the list of each subject into a bigger list</li>
<li>store this big list into a csv-file</li>
</ul>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#iterate over contrasts and create a cvs-file for each</span>
<span class="k">for</span> <span class="n">contrast</span> <span class="ow">in</span> <span class="n">contrasts</span><span class="p">:</span>

    <span class="c">#creates a list with an empty entry for each segmentation id</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15000</span><span class="p">):</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span>

    <span class="c">#to keep track of added subjects</span>
    <span class="n">subjectNumber</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">path2aROIOut</span> <span class="o">=</span> <span class="n">experiment_dir</span><span class="o">+</span><span class="s">&#39;/results/&#39;</span><span class="o">+</span><span class="n">aROIOutput</span>

    <span class="c">#iterate over subjects and entering values into output</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>

        <span class="c">#specify path to aROI datasink for each variaton of segmentation</span>
        <span class="n">path2Sumfile</span> <span class="o">=</span> <span class="s">&#39;_contrast_id_&#39;</span><span class="o">+</span><span class="n">contrast</span><span class="o">+</span><span class="s">&#39;_subject_id_&#39;</span><span class="o">+</span><span class="n">subject</span><span class="o">+</span><span class="s">&#39;/summary.stats&#39;</span>
        <span class="n">statsFileorig</span> <span class="o">=</span> <span class="n">path2aROIOut</span><span class="o">+</span><span class="s">&#39;/segstatorig/&#39;</span><span class="o">+</span><span class="n">path2Sumfile</span>
        <span class="n">statsFile2009</span> <span class="o">=</span> <span class="n">path2aROIOut</span><span class="o">+</span><span class="s">&#39;/segstat2009/&#39;</span><span class="o">+</span><span class="n">path2Sumfile</span>

        <span class="c">#extract the data from the output summary files</span>
        <span class="n">dataFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">statsFileorig</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">dataorig</span> <span class="o">=</span> <span class="n">dataFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">dataFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">dataFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">statsFile2009</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">data2009</span> <span class="o">=</span> <span class="n">dataFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">dataFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c">#function to check where the data starts</span>
        <span class="k">def</span> <span class="nf">findStartOfData</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">datafile</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                   <span class="k">return</span> <span class="n">line</span>

        <span class="c">#get data and store it in tempresult</span>
        <span class="n">tempresult</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataorig</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">findStartOfData</span><span class="p">(</span><span class="n">dataorig</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">dataorig</span><span class="p">[</span><span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">tempresult</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="nb">float</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">5</span><span class="p">])])</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data2009</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">findStartOfData</span><span class="p">(</span><span class="n">data2009</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">data2009</span><span class="p">[</span><span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">tempresult</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="nb">float</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">5</span><span class="p">])])</span>

        <span class="n">tempresult</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tempresult</span><span class="p">)):</span>
            <span class="c">#pass if region has already been added</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tempresult</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">==</span> <span class="n">tempresult</span><span class="p">[</span><span class="n">line</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempresult</span><span class="p">[</span><span class="n">line</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="c">#if id wasn&#39;t extracted before, adds name of id to row</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">output</span><span class="p">[</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c">#adds value of id into row</span>
            <span class="n">output</span><span class="p">[</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c">#if no value for an id was entered for a subject</span>
        <span class="c">#   the value 0.0 gets added</span>
        <span class="k">for</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ROI</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">subjectNumber</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span>
               <span class="n">ROI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">subjectNumber</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c">#adds labels to the first row of the output</span>
    <span class="n">output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,[</span><span class="s">&#39;SegId&#39;</span><span class="p">,</span><span class="s">&#39;StructName&#39;</span><span class="p">])</span>
    <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>

    <span class="c">#adds segment if it was extracted</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">ROI</span> <span class="k">for</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">if</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">]</span>

    <span class="c">#define name of the output csv-file</span>
    <span class="n">summaryFileName</span> <span class="o">=</span> <span class="s">&#39;aROI_&#39;</span><span class="o">+</span><span class="n">contrast</span><span class="o">+</span><span class="s">&#39;.csv&#39;</span>

    <span class="c">#store output into a cvs-file</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path2aROIOut</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">summaryFileName</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">csv</span>
    <span class="n">outputFile</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">outputFile</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The code for this anatomical ROI pipeline can be found here: <a class="reference external" href="http://github.com/miykael/nipype-beginner-s-guide/blob/master/aROIpipeline.py.py">aROIpipeline.py</a></p>
</div>
</div>
<div class="section" id="folder-structure-after-aroiflow">
<h3>Folder structure after <tt class="docutils literal"><span class="pre">aROIflow</span></tt><a class="headerlink" href="#folder-structure-after-aroiflow" title="Permalink to this headline">¶</a></h3>
<p>After we&#8217;ve run the <strong>anatomical ROI pipeline</strong> our folder structure should look like this:</p>
<img alt="_images/aROI.png" src="_images/aROI.png" style="width: 810px;" />
<p>Additionally to the <tt class="docutils literal"><span class="pre">level2_output</span></tt> folder in <tt class="docutils literal"><span class="pre">~SOMEPATH/experiment/results/</span></tt> we now have the new folders:</p>
<ul>
<li><p class="first"><strong>workingdir_aROI</strong> folder that contains all the data that gets created from the <tt class="docutils literal"><span class="pre">aROIflow</span></tt> pipeline. As with all working directories, it  is <strong>highly recommended</strong> to delete this folder as soon as possible.</p>
</li>
<li><p class="first"><strong>aROI_output</strong> folder which is the datasink of the <strong>anatomical ROI pipeline</strong>. It contains:</p>
<blockquote>
<ul class="simple">
<li><strong>segstatorig</strong> folder with the <tt class="docutils literal"><span class="pre">summary.stats</span></tt> file from the original segmentation for each contrast and subject</li>
<li><strong>segstat2009</strong> folder with the <tt class="docutils literal"><span class="pre">summary.stats</span></tt> file from the 2009 segmentation for each contrast and subject</li>
</ul>
</blockquote>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you run the additonal python code that is at the end of the script, the summarization files that get created will be stored in <tt class="docutils literal"><span class="pre">~SOMEPATH/experiment/results/aROI_output</span></tt>.</p>
</div>
</div>
</div>
<div class="section" id="functional-roi-pipeline">
<h2>Functional ROI Pipeline<a class="headerlink" href="#functional-roi-pipeline" title="Permalink to this headline">¶</a></h2>
<p>As said before, the most important difference to the extraction of an antomical ROI is that the region of interest isn&#8217;t predifined by some atlas. In this example we define the region we are interested in solely by a point in &#8220;brain&#8221;-space and by a the radius of a sphere around this point. The procedure to this is quite simple:</p>
<ol class="arabic simple">
<li>define a point of interest and create a sphere around it</li>
<li>overlay this sphere on the functional data of a subject</li>
<li>extract only the data from this region</li>
</ol>
<p>Our <strong>functional ROI pipeline</strong> does almost exactly this. The only difference is that we have to divide the first step into smaller substeps:</p>
<ol class="loweralpha simple">
<li>find the coordination of a point you are interested in</li>
<li>create a cube around this point of interest so that the region you want to cover is covered</li>
<li>transform the cube into a sphere by smoothing it</li>
<li>mask the sphere with the subject specific T-maps so that only the voxels are taken into acount which were actually active</li>
</ol>
<p>Let&#8217;s take a closer look at those steps:</p>
<p><strong>Step A: Define a point of interest</strong></p>
<img alt="_images/fROI1.png" src="_images/fROI1.png" style="width: 810px;" />
<p>In this image that shows a thresholded contrast from our second level volume pipeline we know that the point with coordinations [110,128,142] seems to be very active and therefore interesting.</p>
<p><strong>Step B: Create a cube</strong></p>
<img alt="_images/fROI2.png" src="_images/fROI2.png" style="width: 810px;" />
<p>To create this cube around the point of interesting some not so obvious steps have to be done. First, take a subject specific contrast multiply all voxel by 0 and add the value 1 to each. Second, define a cubic area around your point of interest by specifying the lowest corners of the cube and the length of its sides, which in this example is 10. Now you have a cubic region where all voxel inside the cube have value 1 and all voxel outside the cube have value 0.</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#this is the command line that fsl.ImageMaths() would create for this step</span>
fslmaths ~SOMEPATH/experiment/results/level1_output/normcons/subject1/con_0004_ants.nii
-mul 0 -add 1 -roi 100 20 118 20 132 20 0 1 ~SOMEPATH/experiment/blabla/
con_0004_ants_maths.nii.gz -odt float
</pre></div>
</div>
<p><strong>Step C: Smooth cube to a sphere</strong></p>
<img alt="_images/fROI3.png" src="_images/fROI3.png" style="width: 810px;" />
<p>To achive this you have to take the cube and smooth it to a sphere. If you&#8217;re using <tt class="docutils literal"><span class="pre">fsl.ImageMaths()</span></tt> you have to threshold the sphere with 0.5 and binarize it afterwards. Now you have sphere with the same diameter as the side of the cube was.</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#this is the command line that fsl.ImageMaths() would create for this step</span>
fslmaths ~SOMEPATH/experiment/blabla/con_0004_ants_maths.nii.gz -kernel sphere 10 -fmean
-thr 0.5 -bin ~SOMEPATH/experiment/blabla/con_0004_ants_maths_maths.nii.gz -odt float
</pre></div>
</div>
<p><strong>Step D: Mask ROI with subject specific T-map</strong></p>
<img alt="_images/fROI4.png" src="_images/fROI4.png" style="width: 810px;" />
<p>The final step of creating a functional is to mask your functional ROI for each subject and each contrast with the corresponding T-map. This leads to the picture above. With this way we take into account that only the values from the T-map in the specified region get counted.</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#this is the command line that fsl.ImageMaths() would create for this step</span>
fslmaths ~SOMEPATH/experiment/blabla/con_0004_ants_maths_maths.nii.gz
-mas ~SOMEPATH/experiment/results/level1_output/normtmaps/subject1/spmT_0004_ants.nii
~SOMEPATH/experiment/blabla/con_0010_ants_maths_maths_maths.nii.gz -odt float
</pre></div>
</div>
<p>Let&#8217;s now begin with the creation of our <strong>functional ROI pipeline</strong>.</p>
<div class="section" id="id2">
<h3>Import modules<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>                                    <span class="c"># system functions</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.freesurfer</span> <span class="kn">as</span> <span class="nn">fs</span>    <span class="c"># freesurfer</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">as</span> <span class="nn">nio</span>           <span class="c"># i/o routines</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">as</span> <span class="nn">util</span>     <span class="c"># utility</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">as</span> <span class="nn">pe</span>          <span class="c"># pypeline engine</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.fsl</span> <span class="kn">as</span> <span class="nn">fsl</span>          <span class="c"># fsl module</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id3">
<h3>Define experiment specific parameters<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#to better access the parent folder of the experiment</span>
<span class="n">experiment_dir</span> <span class="o">=</span> <span class="s">&#39;~SOMEPATH/experiment&#39;</span>

<span class="c">#dirnames for functional ROI pipeline</span>
<span class="n">fROIWorkingdir</span> <span class="o">=</span> <span class="s">&#39;/result/fROI_workingdir&#39;</span> <span class="c">#location and name of workingdir</span>
<span class="n">fROIOutput</span> <span class="o">=</span> <span class="s">&#39;result/fROI_output&#39;</span>          <span class="c">#location and name of fROI datasink</span>

<span class="c">#list of subjectnames</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;subject1&#39;</span><span class="p">,</span> <span class="s">&#39;subject2&#39;</span><span class="p">,</span> <span class="s">&#39;subject3&#39;</span><span class="p">]</span>

<span class="c">#list of contrastnumbers the pipeline should consider</span>
<span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;01&#39;</span><span class="p">,</span><span class="s">&#39;02&#39;</span><span class="p">,</span><span class="s">&#39;03&#39;</span><span class="p">,</span><span class="s">&#39;04&#39;</span><span class="p">,</span><span class="s">&#39;05&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-froi-specific-parameters">
<h3>Define fROI specific parameters<a class="headerlink" href="#define-froi-specific-parameters" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#define the coordination of point of interest</span>
<span class="n">centerOfROI</span> <span class="o">=</span> <span class="p">[</span><span class="mi">110</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">142</span><span class="p">]</span>

<span class="c">#define the radius of the sphere of interest</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c">#calculates the beginning corner of the cubic ROI</span>
<span class="n">corner</span> <span class="o">=</span> <span class="p">[</span><span class="n">centerOfROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span>
          <span class="n">centerOfROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span>
          <span class="n">centerOfROI</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">radius</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="definition-of-nodes">
<h3>Definition of Nodes<a class="headerlink" href="#definition-of-nodes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: IdentityInterface - to iterate over subjects and contrasts</span>
<span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">]),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">&#39;inputnode&#39;</span><span class="p">)</span>
<span class="n">inputnode</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjects</span><span class="p">),</span>
                       <span class="p">(</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">)]</span>


<span class="c">#Node: DataGrabber - To grab the input data</span>
<span class="n">datasource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">],</span>
                                               <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;contrast&#39;</span><span class="p">]),</span>
                     <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;datasource&#39;</span><span class="p">)</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;result/&#39;</span> <span class="o">+</span> <span class="n">l1contrastDir</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s">&#39;/</span><span class="si">%s</span><span class="s">/norm</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">_</span><span class="si">%04d</span><span class="s">_ants.nii&#39;</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">contrast</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;cons&#39;</span><span class="p">,</span><span class="s">&#39;con&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">]],</span>
                                       <span class="n">tmaps</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;tmaps&#39;</span><span class="p">,</span><span class="s">&#39;spmT&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">]])</span>


<span class="c">#Node: ImageMaths - to create the cubic ROI with value 1</span>
<span class="n">cubemask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cubemask&quot;</span><span class="p">)</span>
<span class="n">cubemask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s">&#39;-mul 0 -add 1 -roi </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> 0 1&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">radius</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">radius</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">corner</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">radius</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">cubemask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_data_type</span> <span class="o">=</span> <span class="s">&#39;float&#39;</span>
<span class="n">cubemask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">&#39;~SOMEPATH/experiment/normcons/</span><span class="si">%s</span><span class="s">/con_</span><span class="si">%04d</span><span class="s">_ants.nii&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">contrasts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c">#Node: ImageMaths - to smooth the cubic ROI to a sphere</span>
<span class="n">spheremask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;spheremask&quot;</span><span class="p">)</span>
<span class="n">spheremask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s">&#39;-kernel sphere </span><span class="si">%d</span><span class="s"> -fmean -thr 0.5 -bin&#39;</span><span class="o">%</span><span class="n">radius</span>
<span class="n">spheremask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_data_type</span> <span class="o">=</span> <span class="s">&#39;float&#39;</span>

<span class="c">#Node: ImageMaths - to mask the spherical ROI with a subject specific tmap</span>
<span class="n">tmapmask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;tmapmask&quot;</span><span class="p">)</span>
<span class="n">tmapmask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_data_type</span> <span class="o">=</span> <span class="s">&#39;float&#39;</span>

<span class="c">#Node: SegStats - to extract the statistic from a given segmentation</span>
<span class="n">segstat</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">SegStats</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;segstat&#39;</span><span class="p">)</span>

<span class="c">#Node: Datasink - Create a datasink node to store important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;datasink&quot;</span><span class="p">)</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">fROIOutput</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are interested in what command actually will be executed by the <tt class="docutils literal"><span class="pre">cubemask</span></tt> node you just simply can execute <tt class="docutils literal"><span class="pre">cubemask.cmdline</span></tt>. In this example this will give you the following output: <tt class="docutils literal"><span class="pre">blablabla</span></tt>
But it&#8217;s important that the interface isn&#8217;t defined as a node. Has to be without pe.Node....</p>
</div>
</div>
<div class="section" id="definition-of-functional-roi-workflow">
<h3>Definition of functional ROI workflow<a class="headerlink" href="#definition-of-functional-roi-workflow" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Initiation of the fROI extraction workflow</span>
<span class="n">fROIflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fROIflow&#39;</span><span class="p">)</span>
<span class="n">fROIflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="n">fROIWorkingdir</span>

<span class="c">#Connect up all components</span>
<span class="n">fROIflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">cubemask</span><span class="p">,</span> <span class="n">spheremask</span><span class="p">,[(</span><span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">spheremask</span><span class="p">,</span> <span class="n">tmapmask</span><span class="p">,[(</span><span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">tmapmask</span><span class="p">,[((</span><span class="s">&#39;tmaps&#39;</span><span class="p">,</span><span class="n">path2tmap</span><span class="p">),</span> <span class="s">&#39;op_string&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">infosource1</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">infosource2</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,[(</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span> <span class="s">&#39;contrast_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">tmapmask</span><span class="p">,</span> <span class="n">segstat</span><span class="p">,[(</span><span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="s">&#39;segmentation_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">segstat</span><span class="p">,[(</span><span class="s">&#39;contrast&#39;</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">segstat</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,[(</span><span class="s">&#39;summary_file&#39;</span><span class="p">,</span> <span class="s">&#39;@statistic&#39;</span><span class="p">)]),</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="run-the-pipeline-and-generate-the-graph">
<h3>Run the pipeline and generate the graph<a class="headerlink" href="#run-the-pipeline-and-generate-the-graph" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">fROIflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s">&#39;flat&#39;</span><span class="p">)</span>
<span class="n">fROIflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;n_procs&#39;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="visualization-of-the-functional-roi-pipeline">
<h3>Visualization of the functional ROI pipeline<a class="headerlink" href="#visualization-of-the-functional-roi-pipeline" title="Permalink to this headline">¶</a></h3>
<p>This graph of the <tt class="docutils literal"><span class="pre">hierarchical</span></tt> version shows the <tt class="docutils literal"><span class="pre">fROIflow</span></tt>:</p>
<img alt="_images/fROI_hierachical.png" src="_images/fROI_hierachical.png" style="width: 810px;" />
<p>This detailed graph of the <tt class="docutils literal"><span class="pre">flat</span></tt> version shows the <tt class="docutils literal"><span class="pre">fROIflow</span></tt>:</p>
<img alt="_images/fROI_detailed.png" src="_images/fROI_detailed.png" style="width: 1080px;" />
</div>
<div class="section" id="id4">
<h3>Summarizing the output in a cvs-file<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">path2aROIOut</span> <span class="o">=</span> <span class="n">experiment_dir</span><span class="o">+</span><span class="s">&#39;/results/&#39;</span><span class="o">+</span><span class="n">aROIOutput</span>

<span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&#39;coordinations:&#39;</span><span class="p">,</span><span class="n">centerOfROI</span><span class="p">,</span><span class="s">&#39;radius:&#39;</span><span class="p">,</span><span class="n">radius</span><span class="p">])</span>

<span class="k">for</span> <span class="n">contrast</span> <span class="ow">in</span> <span class="n">contrasts</span><span class="p">:</span>
    <span class="n">contrast</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">contrast</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&#39;contrast:&#39;</span><span class="p">,</span><span class="n">contrast</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>

        <span class="n">path2Sumfile</span> <span class="o">=</span> <span class="s">&#39;_contrast_id_&#39;</span><span class="o">+</span><span class="n">contrast</span><span class="o">+</span><span class="s">&#39;_subject_id_&#39;</span><span class="o">+</span><span class="n">subject</span>

        <span class="n">statFile</span> <span class="o">=</span> <span class="n">path2aROIOut</span> <span class="o">+</span> <span class="n">path2Sumfile</span> <span class="o">+</span> <span class="s">&#39;/summary.stats&#39;</span>

        <span class="c">#Get the data from the output file</span>
        <span class="n">dataFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">statFile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dataFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">dataFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">subject</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">]])</span>

    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path2aROIOut</span><span class="o">+</span><span class="s">&#39;/fROI_spherical&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">centerOfROI</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;_</span><span class="si">%s</span><span class="s">_result.csv&#39;</span><span class="o">%</span><span class="n">radius</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">outputFile</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">outputFile</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The code for this functional ROI pipeline can be found here: <a class="reference external" href="http://github.com/miykael/nipype-beginner-s-guide/blob/master/fROIpipeline.py.py">fROIpipeline.py</a></p>
</div>
</div>
<div class="section" id="folder-structure-after-froiflow">
<h3>Folder structure after <tt class="docutils literal"><span class="pre">fROIflow</span></tt><a class="headerlink" href="#folder-structure-after-froiflow" title="Permalink to this headline">¶</a></h3>
<p>After we&#8217;ve run the <strong>functional ROI pipeline</strong> our folder structure should look like this:</p>
<img alt="_images/fROI.png" src="_images/fROI.png" style="width: 810px;" />
<p>Additionally to the <tt class="docutils literal"><span class="pre">level2_output</span></tt> folder in <tt class="docutils literal"><span class="pre">~SOMEPATH/experiment/results/</span></tt> we now have the new folders:</p>
<ul class="simple">
<li><strong>workingdir_fROI</strong> folder that contains all the data that gets created from the <tt class="docutils literal"><span class="pre">fROIflow</span></tt> pipeline. As with all working directories, it  is <strong>highly recommended</strong> to delete this folder as soon as possible.</li>
<li><strong>fROI_output</strong> folder which is the datasink of the <strong>functional ROI pipeline</strong>. In this folder you&#8217;ll find the <tt class="docutils literal"><span class="pre">summary.stats</span></tt> file for the defined functional region for each contrast and subject</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you run the additonal python code that is at the end of the script, the summarization files that get created will be stored in <tt class="docutils literal"><span class="pre">~SOMEPATH/experiment/results/fROI_output</span></tt>.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="futureChapters.html" title="Ideas For Future Chapters"
             >next</a> |</li>
        <li class="right" >
          <a href="secondLevelExample.html" title="How To Build A Second Level Pipeline"
             >previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Michael Notter.
      Last updated on August 15, 2011.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
</div>

  </body>
</html>