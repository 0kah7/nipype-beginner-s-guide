

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nipype Beginner&#39;s Guide &mdash; Beginner&#39;s Guide to Nipype v0.4 v0.5 documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Beginner&#39;s Guide to Nipype v0.4 v0.5 documentation" href="index.html" />
    <link rel="next" title="How To Extract Regions Of Interest (ROIs)" href="regionOfInterest.html" />
    <link rel="prev" title="How To Build A First Level Pipeline" href="firstLevelExample.html" />
 
<meta name="keywords" content="nipype, python, guide">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24958678-1']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="index.html">
  <img src="_static/nipype-beginners-guide-banner-bg.png" alt="NIPY logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="regionOfInterest.html" title="How To Extract Regions Of Interest (ROIs)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="firstLevelExample.html" title="How To Build A First Level Pipeline"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How To Build A Second Level Pipeline</a><ul>
<li><a class="reference internal" href="#specify-condition-independent-parameters">Specify condition independent parameters</a><ul>
<li><a class="reference internal" href="#import-modules">Import modules</a></li>
<li><a class="reference internal" href="#define-experiment-specific-parameters">Define experiment specific parameters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#second-level-analysis-on-the-volume">Second level analysis on the volume</a><ul>
<li><a class="reference internal" href="#grab-the-data">Grab the data</a></li>
<li><a class="reference internal" href="#define-nodes">Define nodes</a></li>
<li><a class="reference internal" href="#establish-a-second-level-volume-pipeline">Establish a second level volume pipeline</a></li>
</ul>
</li>
<li><a class="reference internal" href="#second-level-analysis-on-the-surface">Second level analysis on the surface</a><ul>
<li><a class="reference internal" href="#id1">Grab the data</a></li>
<li><a class="reference internal" href="#id2">Define nodes</a></li>
<li><a class="reference internal" href="#establish-a-second-level-surface-pipeline">Establish a second level surface pipeline</a></li>
</ul>
</li>
<li><a class="reference internal" href="#store-results-in-a-common-datasink">Store results in a common Datasink</a></li>
<li><a class="reference internal" href="#run-pipelines">Run pipelines</a></li>
<li><a class="reference internal" href="#visualize-pipelines">Visualize pipelines</a><ul>
<li><a class="reference internal" href="#second-level-volume-pipeline">Second Level Volume Pipeline</a></li>
<li><a class="reference internal" href="#second-level-surface-pipeline">Second Level Surface Pipeline</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resulting-folder-structure">Resulting Folder Structure</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="firstLevelExample.html"
                        title="previous chapter">How To Build A First Level Pipeline</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="regionOfInterest.html"
                        title="next chapter">How To Extract Regions Of Interest (ROIs)</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/secondLevelExample.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-build-a-second-level-pipeline">
<h1>How To Build A Second Level Pipeline<a class="headerlink" href="#how-to-build-a-second-level-pipeline" title="Permalink to this headline">¶</a></h1>
<p>In this part you will learn how to do a <strong>second level analysis</strong> on the volume and the surface. We want combine both pipelines in a common parent workflow. Of course this would be possible, but it is also a advantage to be able to run the pipelines separately.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Before we can run the <strong>second level analysis</strong> on the volume we have to normalize the estimated volume contrasts from the first level pipeline into a common subject space. One method how you can achieve this will be covered in the chapter about ANTS.
This normalization isn&#8217;t required for a <strong>second level analysis</strong> on the surface. Because the second level surface analysis will be done with FreeSurfer, we can use the subject specific informations won from the recon-all process.</p>
</div>
<div class="section" id="specify-condition-independent-parameters">
<h2>Specify condition independent parameters<a class="headerlink" href="#specify-condition-independent-parameters" title="Permalink to this headline">¶</a></h2>
<p>It doesn&#8217;t matter if you are running you&#8217;re analysis only on the volume, on the surface or both. As always we&#8217;re beginning by importing the necessary modules and implementation of the experiment specific parameters.</p>
<div class="section" id="import-modules">
<h3>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nipype.interfaces.freesurfer</span> <span class="kn">as</span> <span class="nn">fs</span> <span class="c"># freesurfer</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">as</span> <span class="nn">nio</span>        <span class="c"># i/o routines</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.spm</span> <span class="kn">as</span> <span class="nn">spm</span>       <span class="c"># spm</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">as</span> <span class="nn">util</span>  <span class="c"># utility</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">as</span> <span class="nn">pe</span>       <span class="c"># pypeline engine</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-experiment-specific-parameters">
<h3>Define experiment specific parameters<a class="headerlink" href="#define-experiment-specific-parameters" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#to better access the parent folder of the experiment</span>
<span class="n">experiment_dir</span> <span class="o">=</span> <span class="s">&#39;~SOMEPATH/experiment&#39;</span>

<span class="c">#tell FreeSurfer where the recon-all output is at</span>
<span class="n">freesurfer_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/freesurfer_data&#39;</span>
<span class="n">fs</span><span class="o">.</span><span class="n">FSCommand</span><span class="o">.</span><span class="n">set_default_subjects_dir</span><span class="p">(</span><span class="n">freesurfer_dir</span><span class="p">)</span>

<span class="c">#list of subjectnames</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;subject1&#39;</span><span class="p">,</span> <span class="s">&#39;subject2&#39;</span><span class="p">,</span> <span class="s">&#39;subject3&#39;</span><span class="p">]</span>

<span class="c">#second level analysis pipeline specific components</span>
<span class="n">nameOfLevel2Out</span> <span class="o">=</span> <span class="s">&#39;level2_output&#39;</span>
<span class="n">numberOfContrasts</span> <span class="o">=</span> <span class="mi">5</span> <span class="c">#number of contrasts you specified in the first level analysis</span>
<span class="n">contrast_ids</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">numberOfContrasts</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c">#to create a list with value [1,2,3,4,5]</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you want to only analyze the 3rd and 4th contrasts, you could specify <tt class="docutils literal"><span class="pre">contrast_ids</span></tt> as <tt class="docutils literal"><span class="pre">range(3,5)</span></tt> which would create the list <tt class="docutils literal"><span class="pre">[3,4]</span></tt></p>
</div>
</div>
</div>
<div class="section" id="second-level-analysis-on-the-volume">
<h2>Second level analysis on the volume<a class="headerlink" href="#second-level-analysis-on-the-volume" title="Permalink to this headline">¶</a></h2>
<div class="section" id="grab-the-data">
<h3>Grab the data<a class="headerlink" href="#grab-the-data" title="Permalink to this headline">¶</a></h3>
<p>As always we first have to specify where the datagrabber node can find the data. Le&#8217;s assume that we have stored our normalized estimated volume contrasts at: <tt class="docutils literal"><span class="pre">'~SOMEPATH/experiment/results/level1_output/normcons/subject_name/'</span></tt>. This means the third contrast of the second subject would be at: <tt class="docutils literal"><span class="pre">'~SOMEPATH/experiment/results/level1_output/normcons/subject2/con_0001.nii'</span></tt></p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: DataGrabber - to collect all the con images for each contrast</span>
<span class="n">l2volSource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;con&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;l2volSource&quot;</span><span class="p">)</span>
<span class="n">path2normcons</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/results/level1_output/normcons/subject*/con_</span><span class="si">%04d</span><span class="s">.nii&#39;</span>
<span class="n">l2volSource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">path2normcons</span>
<span class="n">l2volSource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;con&#39;</span><span class="p">,</span><span class="n">contrast_ids</span><span class="p">)]</span> <span class="c"># iterate over all contrast images</span>
</pre></div>
</td></tr></table></div>
<p>You might be confused with the asterisk in <tt class="docutils literal"><span class="pre">l2volSource.inputs.template</span></tt> and that we didn&#8217;t iterated over the subjects. This is because of the nature of a second level analysis. We take all estimated contrasts of each subject at once into the analysis, therefore the asterisk. We only have to iterate the conditions e.g. the number of the contrasts.</p>
</div>
<div class="section" id="define-nodes">
<h3>Define nodes<a class="headerlink" href="#define-nodes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: OneSampleTTest - to perform an one sample t-test analysis</span>
<span class="n">oneSampleTTestVolDes</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">OneSampleTTestDesign</span><span class="p">(),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s">&quot;oneSampleTTestVolDes&quot;</span><span class="p">)</span>

<span class="c">#Node: EstimateModel - to estimate the model</span>
<span class="n">l2estimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">EstimateModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;l2estimate&quot;</span><span class="p">)</span>
<span class="n">l2estimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">estimation_method</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Classical&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="c">#Node: EstimateContrast - to estimate the contrast (in this example just one)</span>
<span class="n">l2conestimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">spm</span><span class="o">.</span><span class="n">EstimateContrast</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;l2conestimate&quot;</span><span class="p">)</span>
<span class="n">cont1</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Group&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;mean&#39;</span><span class="p">],[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">l2conestimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">cont1</span><span class="p">]</span>
<span class="n">l2conestimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">group_contrast</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c">#Node: Threshold - to threshold the estimated contrast</span>
<span class="n">l2threshold</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">spm</span><span class="o">.</span><span class="n">Threshold</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;l2threshold&quot;</span><span class="p">)</span>
<span class="n">l2threshold</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrast_index</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">l2threshold</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">use_fwe_correction</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">l2threshold</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">use_topo_fdr</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">l2threshold</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">extent_threshold</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c">#voxel threshold</span>
<span class="n">l2threshold</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">extent_fdr_p_threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="c">#cluster threshold (value is in -ln()): 1.301 = 0.05; 2 = 0.01; 3 = 0.001,</span>
<span class="n">l2threshold</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">height_threshold</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Of course you can all different kinds of statistical analysis. Another example beside a one sample t-test would be multiple regression analysis. Such a node would look this:</p>
<div class="last highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: MultipleRegressionDesign - to perform a multiple regression analysis</span>
<span class="n">multipleRegDes</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">MultipleRegressionDesign</span><span class="p">(),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s">&quot;multipleRegDes&quot;</span><span class="p">)</span>
<span class="c">#regressor1 and regressor2 for 3 subjects</span>
<span class="n">multipleRegDes</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">vector</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.30</span><span class="p">,</span><span class="mf">0.52</span><span class="p">,</span><span class="mf">1.75</span><span class="p">],</span>
                                         <span class="n">name</span><span class="o">=</span><span class="s">&#39;nameOfRegressor1&#39;</span><span class="p">),</span>
                                    <span class="nb">dict</span><span class="p">(</span><span class="n">vector</span><span class="o">=</span><span class="p">[</span><span class="mf">1.55</span><span class="p">,</span><span class="o">-</span><span class="mf">1.80</span><span class="p">,</span><span class="mf">0.77</span><span class="p">],</span>
                                         <span class="n">name</span><span class="o">=</span><span class="s">&#39;nameOfRegressor2&#39;</span><span class="p">)]</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="establish-a-second-level-volume-pipeline">
<h3>Establish a second level volume pipeline<a class="headerlink" href="#establish-a-second-level-volume-pipeline" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Create 2-level vol pipeline and connect up all components</span>
<span class="n">l2volflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;l2volflow&quot;</span><span class="p">)</span>
<span class="n">l2volflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/results/workingdir_l2vol&#39;</span>
<span class="n">l2volflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">l2volSource</span><span class="p">,</span><span class="n">oneSampleTTestVolDes</span><span class="p">,[(</span><span class="s">&#39;outfiles&#39;</span><span class="p">,</span><span class="s">&#39;in_files&#39;</span><span class="p">)]),</span>
                   <span class="p">(</span><span class="n">oneSampleTTestVolDes</span><span class="p">,</span><span class="n">l2estimate</span><span class="p">,[(</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">,</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">)]),</span>
                   <span class="p">(</span><span class="n">l2estimate</span><span class="p">,</span><span class="n">l2conestimate</span><span class="p">,[(</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">,</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">),</span>
                                              <span class="p">(</span><span class="s">&#39;beta_images&#39;</span><span class="p">,</span><span class="s">&#39;beta_images&#39;</span><span class="p">),</span>
                                              <span class="p">(</span><span class="s">&#39;residual_image&#39;</span><span class="p">,</span><span class="s">&#39;residual_image&#39;</span><span class="p">)</span>
                                              <span class="p">]),</span>
                   <span class="p">(</span><span class="n">l2conestimate</span><span class="p">,</span><span class="n">l2threshold</span><span class="p">,[(</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">,</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">),</span>
                                               <span class="p">(</span><span class="s">&#39;spmT_images&#39;</span><span class="p">,</span><span class="s">&#39;stat_image&#39;</span><span class="p">),</span>
                                               <span class="p">]),</span>
                   <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="second-level-analysis-on-the-surface">
<h2>Second level analysis on the surface<a class="headerlink" href="#second-level-analysis-on-the-surface" title="Permalink to this headline">¶</a></h2>
<p>An important difference between the format of the volume and the surface data is, that the surface data are img-files and are separated for both hemispheres. In contrast the volume data is in nifti-files which contain both hemispheres. This separation means that we have to iterate over the left (&#8216;lh&#8217;) and the right (&#8216;rh&#8217;) hemisphere.</p>
<div class="section" id="id1">
<h3>Grab the data<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>As mentioned above, our <strong>second level surface pipeline</strong> does have to iterate over the different contrasts <strong>and</strong> the left and right hemisphere. This can be done with the usual individually defined <tt class="docutils literal"><span class="pre">IdentityInterface</span></tt> node.</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: IdentityInterface - to iterate over contrasts and hemispheres</span>
<span class="n">l2surfinputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;contrasts&#39;</span><span class="p">,</span><span class="s">&#39;hemi&#39;</span><span class="p">]),</span>
                          <span class="n">name</span><span class="o">=</span><span class="s">&#39;l2surfinputnode&#39;</span><span class="p">)</span>
<span class="n">l2surfinputnode</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;contrasts&#39;</span><span class="p">,</span> <span class="n">contrast_ids</span><span class="p">),</span>
                             <span class="p">(</span><span class="s">&#39;hemi&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;lh&#39;</span><span class="p">,</span><span class="s">&#39;rh&#39;</span><span class="p">])]</span>
</pre></div>
</td></tr></table></div>
<p>Again we have to be aware about the structure of our data folder. We know from the <strong>first level analysis pipeline</strong> that our estimated surface contrasts are stored at: <tt class="docutils literal"><span class="pre">'~SOMEPATH/experiment/result/level1_output/'</span></tt>. This will be defined as <tt class="docutils literal"><span class="pre">base_directory</span></tt> of the datagrabber node.</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: DataGrabber - to collect contrast images and registration files</span>
<span class="n">l2surfSource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;con_id&#39;</span><span class="p">],</span>
                                                 <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;con&#39;</span><span class="p">,</span><span class="s">&#39;reg&#39;</span><span class="p">]),</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">&#39;l2surfSource&#39;</span><span class="p">)</span>
<span class="n">l2surfSource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/level1_output/&#39;</span>
<span class="n">l2surfSource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span>
<span class="n">l2surfSource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">field_template</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">con</span><span class="o">=</span><span class="s">&#39;surf_contrasts/_subject_id_*/con_</span><span class="si">%04d</span><span class="s">.img&#39;</span><span class="p">,</span>
                                          <span class="n">reg</span><span class="o">=</span><span class="s">&#39;bbregister/_subject_id_*/*.dat&#39;</span><span class="p">)</span>
<span class="n">l2surfSource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">con</span><span class="o">=</span><span class="p">[[</span><span class="s">&#39;con_id&#39;</span><span class="p">]],</span><span class="n">reg</span><span class="o">=</span><span class="p">[[]])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id2">
<h3>Define nodes<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Now that we have defined where our data comes from, we can start with implementing the nodes.</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: Merge - to merge contrast images and registration files</span>
<span class="n">merge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s">&#39;hstack&#39;</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;merge&#39;</span><span class="p">)</span>

<span class="c">#function to create a list of all subjects and the location of their specific files</span>
<span class="k">def</span> <span class="nf">ordersubjects</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">subj_list</span><span class="p">):</span>
    <span class="n">outlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subj_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">subj_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;/_subject_id_</span><span class="si">%s</span><span class="s">/&#39;</span><span class="o">%</span><span class="n">subject</span> <span class="ow">in</span> <span class="n">subj_file</span><span class="p">:</span>
                <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subj_file</span><span class="p">)</span>
                <span class="k">continue</span>
<span class="k">return</span> <span class="n">outlist</span>

<span class="c">#Node: MRISPreproc - to concatenate contrast images projected to fsaverage</span>
<span class="n">concat</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">MRISPreproc</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;concat&#39;</span><span class="p">)</span>
<span class="n">concat</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="s">&#39;fsaverage&#39;</span>
<span class="n">concat</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c">#the smoothing of the surface data happens here</span>

<span class="c">#function that transforms a given list into tuples</span>
<span class="k">def</span> <span class="nf">list2tuple</span><span class="p">(</span><span class="n">listoflist</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">listoflist</span><span class="p">]</span>

<span class="c">#Node: OneSampleTTest - to perform a one sample t-test on the surface</span>
<span class="n">oneSampleTTestSurfDes</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">OneSampleTTest</span><span class="p">(),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s">&#39;oneSampleTTestSurfDes&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="establish-a-second-level-surface-pipeline">
<h3>Establish a second level surface pipeline<a class="headerlink" href="#establish-a-second-level-surface-pipeline" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Create 2-level surf pipeline and connect up all components</span>
<span class="n">l2surfflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;l2surfflow&#39;</span><span class="p">)</span>
<span class="n">l2surfflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/results/workingdir_l2surf&#39;</span>
<span class="n">l2surfflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">l2surfinputnode</span><span class="p">,</span><span class="n">l2surfSource</span><span class="p">,[(</span><span class="s">&#39;contrasts&#39;</span><span class="p">,</span><span class="s">&#39;con_id&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">l2surfinputnode</span><span class="p">,</span><span class="n">concat</span><span class="p">,[(</span><span class="s">&#39;hemi&#39;</span><span class="p">,</span><span class="s">&#39;hemi&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">l2surfSource</span><span class="p">,</span><span class="n">merge</span><span class="p">,[((</span><span class="s">&#39;con&#39;</span><span class="p">,</span> <span class="n">ordersubjects</span><span class="p">,</span> <span class="n">subjects</span><span class="p">),</span><span class="s">&#39;in1&#39;</span><span class="p">),</span>
                                         <span class="p">((</span><span class="s">&#39;reg&#39;</span><span class="p">,</span> <span class="n">ordersubjects</span><span class="p">,</span> <span class="n">subjects</span><span class="p">),</span><span class="s">&#39;in2&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">merge</span><span class="p">,</span><span class="n">concat</span><span class="p">,[((</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">list2tuple</span><span class="p">),</span><span class="s">&#39;vol_measure_file&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">concat</span><span class="p">,</span><span class="n">oneSampleTTestSurfDes</span><span class="p">,[(</span><span class="s">&#39;out_file&#39;</span><span class="p">,</span><span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                    <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="store-results-in-a-common-datasink">
<h2>Store results in a common Datasink<a class="headerlink" href="#store-results-in-a-common-datasink" title="Permalink to this headline">¶</a></h2>
<p>If you want to store the data from the second level volume and surface pipeline at a common location you should use a <tt class="docutils literal"><span class="pre">datasink</span></tt> node. You can use the same <tt class="docutils literal"><span class="pre">datasink</span></tt> node for both pipelines because you aren&#8217;t running both pipelines in the same run.</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: Datasink - Create a datasink node to store important outputs</span>
<span class="n">l2datasink</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;l2datasink&quot;</span><span class="p">)</span>
<span class="n">l2datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/results&#39;</span>
<span class="n">l2datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">nameOfLevel2Out</span>

<span class="c">#integration of the datasink into the volume analysis pipeline</span>
<span class="n">l2volflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">l2conestimate</span><span class="p">,</span><span class="n">l2datasink</span><span class="p">,[(</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">,</span><span class="s">&#39;l2vol_contrasts.@spm_mat&#39;</span><span class="p">),</span>
                                              <span class="p">(</span><span class="s">&#39;spmT_images&#39;</span><span class="p">,</span><span class="s">&#39;l2vol_contrasts.@T&#39;</span><span class="p">),</span>
                                              <span class="p">(</span><span class="s">&#39;con_images&#39;</span><span class="p">,</span><span class="s">&#39;l2vol_contrasts.@con&#39;</span><span class="p">),</span>
                                              <span class="p">]),</span>
                   <span class="p">(</span><span class="n">l2threshold</span><span class="p">,</span><span class="n">l2datasink</span><span class="p">,[(</span><span class="s">&#39;thresholded_map&#39;</span><span class="p">,</span>
                                             <span class="s">&#39;vol_contrasts_thresh.@threshold&#39;</span><span class="p">)]),</span>
                   <span class="p">])</span>

<span class="c">#integration of the datasink into the surface analysis pipeline</span>
<span class="n">l2surfflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">oneSampleTTestSurfDes</span><span class="p">,</span><span class="n">l2datasink</span><span class="p">,[(</span><span class="s">&#39;sig_file&#39;</span><span class="p">,</span>
                                                        <span class="s">&#39;l2surf_contrasts.@sig_file&#39;</span><span class="p">)])])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="run-pipelines">
<h2>Run pipelines<a class="headerlink" href="#run-pipelines" title="Permalink to this headline">¶</a></h2>
<p>Now that we have set up both pipelines we are able to run them. Note that those lines of codes mean that the <strong>second level surface pipeline</strong> won&#8217;t be started before the <strong>second level volume pipeline</strong> has terminated.</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">l2volflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s">&#39;flat&#39;</span><span class="p">)</span>
<span class="n">l2volflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;n_procs&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

<span class="n">l2surfflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s">&#39;flat&#39;</span><span class="p">)</span>
<span class="n">l2surfflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;n_procs&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p>Now that everything has been executed you are able to take a look at your results. I recommend to use the following tools to use:</p>
<ul class="simple">
<li><strong>Matlab&#8217;s SPM fmri</strong> for the results from the contrast estimation on the volume stored in datasinkfolder <tt class="docutils literal"><span class="pre">l2vol_contrasts</span></tt></li>
<li><strong>FreeSurfer&#8217;s Freeview</strong> for the results from the threshold node stored in datasinkfolder <tt class="docutils literal"><span class="pre">l2vol_contrasts_thresh</span></tt>. Overlay the results on your normalization brain template</li>
<li><strong>FreeSurfer&#8217;s Freeview</strong> for the results from the contrast estimation on the surface stored in datasinkfolder <tt class="docutils literal"><span class="pre">l2surf_contrasts</span></tt>. Overlay the results on FreeSurfer&#8217;s normalization brain template (e.g. fsaverage)</li>
</ul>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The code for the second level pipeline on the volume and on the surface can be found here: <a class="reference external" href="http://github.com/miykael/nipype-beginner-s-guide/blob/master/secondlevelpipeline.py">secondlevelpipeline.py</a></p>
</div>
</div>
<div class="section" id="visualize-pipelines">
<h2>Visualize pipelines<a class="headerlink" href="#visualize-pipelines" title="Permalink to this headline">¶</a></h2>
<div class="section" id="second-level-volume-pipeline">
<h3>Second Level Volume Pipeline<a class="headerlink" href="#second-level-volume-pipeline" title="Permalink to this headline">¶</a></h3>
<p>This graph of the <tt class="docutils literal"><span class="pre">hierarchical</span></tt> version shows the <tt class="docutils literal"><span class="pre">l2volflow</span></tt>:</p>
<img alt="_images/l2vol_flat_hierarchical.png" src="_images/l2vol_flat_hierarchical.png" style="width: 640px;" />
<p>This detailed graph of the <tt class="docutils literal"><span class="pre">flat</span></tt> version shows the <tt class="docutils literal"><span class="pre">l2volflow</span></tt>:</p>
<img alt="_images/l2vol_flat_detailed.png" src="_images/l2vol_flat_detailed.png" style="width: 810px;" />
</div>
<div class="section" id="second-level-surface-pipeline">
<h3>Second Level Surface Pipeline<a class="headerlink" href="#second-level-surface-pipeline" title="Permalink to this headline">¶</a></h3>
<p>This graph of the <tt class="docutils literal"><span class="pre">hierarchical</span></tt> version shows the <tt class="docutils literal"><span class="pre">l2surfflow</span></tt>:</p>
<img alt="_images/l2surf_flat_hierarchical.png" src="_images/l2surf_flat_hierarchical.png" style="width: 640px;" />
<p>This detailed graph of the <tt class="docutils literal"><span class="pre">flat</span></tt> version shows the <tt class="docutils literal"><span class="pre">l2surfflow</span></tt>:</p>
<img alt="_images/l2surf_flat_detailed.png" src="_images/l2surf_flat_detailed.png" style="width: 810px;" />
</div>
</div>
<div class="section" id="resulting-folder-structure">
<h2>Resulting Folder Structure<a class="headerlink" href="#resulting-folder-structure" title="Permalink to this headline">¶</a></h2>
<p>After we&#8217;ve run the <strong>second level analysis pipeline</strong> on the volume and the surface our folder structure should look like this:</p>
<img alt="_images/secondlevel.png" src="_images/secondlevel.png" style="width: 810px;" />
<p>Additionally to the <tt class="docutils literal"><span class="pre">level1_output</span></tt> folder in <tt class="docutils literal"><span class="pre">~SOMEPATH/experiment/results/</span></tt> we now have the new folders:</p>
<ul>
<li><p class="first"><strong>workingdir_l2vol</strong> folder that contains all the data that gets created from the <tt class="docutils literal"><span class="pre">l2volflow</span></tt> pipeline. As with all working directories, it  is <strong>highly recommended</strong> to delete this folder as soon as possible.</p>
</li>
<li><p class="first"><strong>workingdir_l2surf</strong> folder that contains all the data that gets created from the <tt class="docutils literal"><span class="pre">l2surfflow</span></tt> pipeline. As with all working directories, it  is <strong>highly recommended</strong> to delete this folder as soon as possible.</p>
</li>
<li><p class="first"><strong>level2_output</strong> folder which is the datasink of the <strong>second level pipeline</strong>. It contains:</p>
<blockquote>
<ul class="simple">
<li><strong>l2vol_contrasts</strong> folder with the estimated volume contrasts and the SPM.mat file for each contrast</li>
<li><strong>l2vol_contrasts_thresh</strong> folder with a thresholded estimated volume contrasts file for each contrast</li>
<li><strong>l2surf_contrasts</strong> folder with the estimated surface contrast file for each hemisphere for each contrast</li>
</ul>
</blockquote>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="regionOfInterest.html" title="How To Extract Regions Of Interest (ROIs)"
             >next</a> |</li>
        <li class="right" >
          <a href="firstLevelExample.html" title="How To Build A First Level Pipeline"
             >previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.5 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Michael Notter.
      Last updated on August 17, 2011.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
</div>

  </body>
</html>