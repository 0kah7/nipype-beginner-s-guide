

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nipype Beginner&#39;s Guide &mdash; Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation" href="index.html" />
 
<meta name="keywords" content="nipype, python, guide">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24958678-1']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="index.html">
  <img src="_static/nipype-beginners-guide-banner-bg.png" alt="NIPY logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to use ANTS to create your own Normbraintemplate</a><ul>
<li><a class="reference internal" href="#title1">Title1</a></li>
<li><a class="reference internal" href="#write-pipeline-script">Write pipeline script</a><ul>
<li><a class="reference internal" href="#import-modules">Import modules</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/8_ANTS.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-use-ants-to-create-your-own-normbraintemplate">
<h1>How to use ANTS to create your own Normbraintemplate<a class="headerlink" href="#how-to-use-ants-to-create-your-own-normbraintemplate" title="Permalink to this headline">¶</a></h1>
<p>TEXT wasi meine</p>
<div class="section" id="title1">
<h2>Title1<a class="headerlink" href="#title1" title="Permalink to this headline">¶</a></h2>
<p>Text</p>
<ul>
<li><dl class="first docutils">
<dt><strong>All consuming pipeline:</strong></dt>
<dd><ul class="first last">
<li><p class="first">Infosource</p>
</li>
<li><p class="first">Datagrabber</p>
</li>
<li><dl class="first docutils">
<dt><strong>Metaworkflow:</strong></dt>
<dd><ul class="first last">
<li><p class="first">Inputnode (func, subject_id, session_info, contrasts)</p>
</li>
<li><dl class="first docutils">
<dt><strong>Preprocess pipeline:</strong></dt>
<dd><ul class="first last simple">
<li>SliceTiming</li>
<li>Realign</li>
<li>ArtifactDetect</li>
<li>BBRegister</li>
<li>Smooth</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>Volume analysis pipeline:</strong></dt>
<dd><ul class="first last simple">
<li>SpecifyModel</li>
<li>Level1Design</li>
<li>EstimateModel</li>
<li>EstimateContrast</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>Normalization pipeline:</strong></dt>
<dd><ul class="first last simple">
<li>MRIConvert</li>
<li>FreeSurferSource</li>
<li>Segment</li>
<li>ApplyVolTransform</li>
<li>Normalize</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">Datasink</p>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Below I&#8217;ve visualized the structure of our pipeline and most of the connections
between the nodes.</p>
<img alt="workflow.png" src="workflow.png" style="width: 600px;" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Some may ask  why we haven&#8217;t included the infosource, datagrabber and datasink
nodes into the metaworkflow.</p>
<p class="last">Because those nodes dependent highly on the paradigma specific parameters and
will change for every model we want to separat them from the metaworkflow which
will stay more or less the same for similar experiments. This does also give us
the opportunity to just import this metaworkflow from this script into a new
pipeline script and reuse it.</p>
</div>
</div>
<div class="section" id="write-pipeline-script">
<h2>Write pipeline script<a class="headerlink" href="#write-pipeline-script" title="Permalink to this headline">¶</a></h2>
<p>Now that we have defined how the structure of our pipeline and the connections
should be we can start with writing the pipeline script.</p>
<div class="section" id="import-modules">
<h3>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this headline">¶</a></h3>
<p>First we have to import all necessary modules.</p>
<div class="highlight-python"><pre>#!/bin/bash

export FREESURFER_HOME=/software/Freesurfer/5.0.0
source /software/Freesurfer/5.0.0/SetUpFreeSurfer.sh

#################################################################
# USER DEFINED VARIABLES (Necessary for the gragT1files function)

# Location of your freesurfer folder
SUBJECTS_DIR=/mindhive/gablab/u/mnotter/att_sens/freesurfer

# List of subjects which should be used for the creation of the template
SUBJECTS_LIST="asens_4 asens_5 asens_6 asens_7 asens_8 asens_9 asens_10 asens_12 asens_13 asens_14 asens_15 asens_16 asens_17 asens_18 asens_19 asens_20 asens_21"

#NOTE: If you don't want to use the T1-files from your recon-all output, comment line 808
#      Use last parameter (e.g. *_T1.nii.gz) to specify which T1 files from the current folder should be used instead

###################################################################################
# ORIGINAL buildtemplateparalle.sh SCRIPT WITH ALTERED DEFAULT VALUES AND FUNCTIONS
# Altered by Michael Notter, mnotter@mit.edu
#
# the altered defaults are:
# -c = 1     parallel computation with SGE qsub
# -i = 4     Iteration limit
# -m = 33x99x11      Max-iterations
# -s = CC    similarity metric
# -t = GR    transformation model
#
# Before it starts your iteration with your -i and -m value, a fast
# set with -i = 4 and -m = 10x10x0x0 gets created.
#
# If additionally created the function killingjobs, grabT1files and storingresults
# to save the main results in one folder.


export PATH=/software/ANTS-dev:$PATH
export ANTSPATH=/software/ANTS-dev/


function jobfnamepadding {

    files=`ls job*.sh`
    BASENAME1=`echo $files[1] | cut -d 'b' -f 1`

    for file in ${files}
      do

      if [ "${#file}" -eq "9" ]
          then
          BASENAME2=`echo $file | cut -d 'b' -f 2 `
          mv "$file" "${BASENAME1}b_000${BASENAME2}"

      elif [ "${#file}" -eq "10" ]
          then
          BASENAME2=`echo $file | cut -d 'b' -f 2 `
          mv "$file" "${BASENAME1}b_00${BASENAME2}"

      elif [ "${#file}" -eq "11" ]
          then
          BASENAME2=`echo $file | cut -d 'b' -f 2 `
          mv "$file" "${BASENAME1}b_0${BASENAME2}"
      fi
    done

}

function killingjobs {

    if [ $DOQSUB -eq 1 ] ; then

    echo "--------------------------------------------------------------------------------------"
    echo " Killing SGE jobs..."

    for job in $jobIDs
    do
       qdel $job
    done
    echo "--------------------------------------------------------------------------------------"

    fi

}

# GETS THE T1 FILES FROM YOUR FREESURFER FOLDER
function grabT1files {

    TARGETPOSTFIX=${IMAGESETVARIABLE#?}        # e.g. '_T1.nii.gz'
    TARGETPOSTFIX2=${TARGETPOSTFIX%.*.*}       # e.g. '_T1'

    # checks if the ants_template folder already exists
    if [ ! -d `pwd`/ants_template ]
    then
        mkdir -p `pwd`/ants_template
    fi

    cd `pwd`/ants_template

    if [ ! -f `pwd`/ants_template/$OUTPUTNAME'template.nii.gz' ]
    then

        # gets subject T1 files if they doesn't exist yet and converts them into nii format
        for subject in `echo $SUBJECTS_LIST`
        do
            if [ ! -f './'$subject$TARGETPOSTFIX ]
                then
                cp $SUBJECTS_DIR/$subject/mri/brain.mgz `pwd`/$subject$TARGETPOSTFIX2.mgz
                mri_convert `pwd`/$subject$TARGETPOSTFIX2.mgz `pwd`/$subject$TARGETPOSTFIX
                rm `pwd`/$subject$TARGETPOSTFIX2.mgz
            fi
        done

        #IMPORTANT: To update the template population
        IMAGESETVARIABLE=`ls *.nii.gz`

    fi

}


#Be aware that this function will delete all other files that exist in the current folder!!!
function storingresults {

    echo "--------------------------------------------------------------------------------------"
    echo " Storing results in folder results..."
    cd `pwd`/ants_template

    mkdir results
    mv *$TARGETPOSTFIX results/
    mv $OUTPUTNAME'template.nii.gz' results/

    echo " ...storing done."
    echo "--------------------------------------------------------------------------------------"

}



cleanup()
# example cleanup function
{

   [...]

   killingjobs
   storingresults

   [...]

}

MAXITERATIONS=33x99x11
LABELIMAGE=0 # initialize optional parameter
METRICTYPE=CC # initialize optional parameter
TRANSFORMATIONTYPE="GR" # initialize optional parameter
N3CORRECT=1 # initialize optional parameter
DOQSUB=1 # By default, buildtemplateparallel tries to do things in parallel
GRADIENTSTEP=0.25 # Gradient step size, smaller in magnitude means more smaller (more cautious) steps
ITERATIONLIMIT=4
CORES=2
TDIM=0
RIGID=0
RIGIDTYPE=" --do-rigid" # set to an empty string to use affine initialization
range=0
REGTEMPLATE=target
cpu_count=`cat /proc/cpuinfo | grep processor | wc -l`


##IF YOU DON'T WANT TO GRAB THE T1_FILES OUT OF YOUR FREESURFER FOLDER COMMENT THIS PART OUT
grabT1files
##

#if you want to keep the temporary files, comment this part out
killingjobs
storingresults</pre>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Michael Notter.
      Last updated on August 08, 2011.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
</div>

  </body>
</html>