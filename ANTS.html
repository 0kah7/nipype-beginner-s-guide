

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nipype Beginner&#39;s Guide &mdash; Beginner&#39;s Guide to Nipype v0.4 v0.6 documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Beginner&#39;s Guide to Nipype v0.4 v0.6 documentation" href="index.html" />
    <link rel="next" title="How To Extract Regions Of Interest (ROIs)" href="regionOfInterest.html" />
    <link rel="prev" title="How To Build A Second Level Pipeline" href="secondLevelExample.html" />
 
<meta name="keywords" content="nipype, python, guide">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24958678-1']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="index.html">
  <img src="_static/nipype-beginners-guide-banner-bg.png" alt="NIPY logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="regionOfInterest.html" title="How To Extract Regions Of Interest (ROIs)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="secondLevelExample.html" title="How To Build A Second Level Pipeline"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.6 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How To Use ANTS To Normalize Your Data</a><ul>
<li><a class="reference internal" href="#what-is-ants">What is ANTS?</a></li>
<li><a class="reference internal" href="#what-are-we-using-ants-for">What are we using ANTS for?</a></li>
<li><a class="reference internal" href="#ants-basics-you-should-be-aware-of">ANTS basics you should be aware of</a><ul>
<li><a class="reference internal" href="#i-o-data-formats-in-ants">I/O data formats in ANTS</a></li>
<li><a class="reference internal" href="#image-registration-with-ants">Image registration with ANTS</a></li>
<li><a class="reference internal" href="#ants-transformation-models">ANTS Transformation Models</a></li>
</ul>
</li>
<li><a class="reference internal" href="#what-do-the-scripts-do">What do the scripts do?</a><ul>
<li><a class="reference internal" href="#buildtemplateparallel-sh">buildtemplateparallel.sh</a><ul>
<li><a class="reference internal" href="#command">Command</a></li>
<li><a class="reference internal" href="#compulsory-arguments">Compulsory arguments</a></li>
<li><a class="reference internal" href="#optional-arguments">Optional arguments</a></li>
<li><a class="reference internal" href="#defaults-of-the-script">Defaults of the script</a></li>
<li><a class="reference internal" href="#output-of-the-script">Output of the script</a></li>
</ul>
</li>
<li><a class="reference internal" href="#antsintroduction-sh">antsIntroduction.sh</a><ul>
<li><a class="reference internal" href="#id5">Command</a></li>
<li><a class="reference internal" href="#id6">Compulsory arguments</a></li>
<li><a class="reference internal" href="#id7">Optional arguments</a></li>
<li><a class="reference internal" href="#id8">Defaults of the script</a></li>
<li><a class="reference internal" href="#id9">Output of the script</a></li>
</ul>
</li>
<li><a class="reference internal" href="#warpimagemultitransform">WarpImageMultiTransform</a><ul>
<li><a class="reference internal" href="#id10">Command</a></li>
<li><a class="reference internal" href="#id11">Compulsory arguments</a></li>
<li><a class="reference internal" href="#id12">Optional arguments</a></li>
<li><a class="reference internal" href="#id13">Output of the script</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-create-a-normtemplate-out-of-anatomical-images">How to create a normtemplate out of anatomical images</a><ul>
<li><a class="reference internal" href="#define-environment-parameters">Define environment parameters</a></li>
<li><a class="reference internal" href="#define-experiment-specific-parameters">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#write-the-main-script">Write the main script</a></li>
<li><a class="reference internal" href="#run-the-script">Run the script</a></li>
<li><a class="reference internal" href="#delete-unnecessary-output">Delete unnecessary output</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-normalize-anatomical-images-to-a-normtemplate">How to normalize anatomical images to a normtemplate</a><ul>
<li><a class="reference internal" href="#id14">Define environment parameters</a></li>
<li><a class="reference internal" href="#id15">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#id16">Write the main script</a></li>
<li><a class="reference internal" href="#id17">Run the script</a></li>
<li><a class="reference internal" href="#id18">Delete unnecessary output</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-normalize-functional-images-to-a-normtemplate">How to normalize functional images to a normtemplate</a><ul>
<li><a class="reference internal" href="#id19">Define environment parameters</a></li>
<li><a class="reference internal" href="#id20">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#id21">Write the main script</a></li>
<li><a class="reference internal" href="#id22">Run the script</a></li>
<li><a class="reference internal" href="#id23">Delete unnecessary output</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="secondLevelExample.html"
                        title="previous chapter">How To Build A Second Level Pipeline</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="regionOfInterest.html"
                        title="next chapter">How To Extract Regions Of Interest (ROIs)</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/ANTS.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-use-ants-to-normalize-your-data">
<h1>How To Use ANTS To Normalize Your Data<a class="headerlink" href="#how-to-use-ants-to-normalize-your-data" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-ants">
<h2>What is ANTS?<a class="headerlink" href="#what-is-ants" title="Permalink to this headline">¶</a></h2>
<p><strong>ANTS</strong> stands for Advanced Normalization Tools and is a very good software package that provides advanced tools for normalizing neuroimages, hence the name. It isn&#8217;t yet integrated into Nipype. So why should you care? Why not just normalize to a template from SPM, FreeSurfer or FSL?</p>
<img alt="_images/normvsnorm.png" src="_images/normvsnorm.png" style="width: 810px;" />
<p>Well if you look at the four normtemplates above it becomes quite obvious. From left to right are shown a MNI Talairach template from SPM, FreeSurfer and FSL. The fourth on the richt is an <strong>ANTS template</strong> made from 15 individual subject images. The normtemplate created from ANTS does not just look nicer, it is also important to know that the closer your normalization template is to your subject data the better!!! So the question turns to: Why aren&#8217;t you using <strong>ANTS</strong>?</p>
<p>Now that I hopefully have convinced you of the benefits of <strong>ANTS</strong> I will also show you where to get it. Actually, it&#8217;s quite simple. Either go to the <a class="reference external" href="http://picsl.upenn.edu/ANTS/download.php">download section</a> on the ANTS homepage or on a <strong>Linux</strong> system just download it in the software center. After that: you&#8217;re good to go!</p>
</div>
<div class="section" id="what-are-we-using-ants-for">
<h2>What are we using ANTS for?<a class="headerlink" href="#what-are-we-using-ants-for" title="Permalink to this headline">¶</a></h2>
<p>In this user guide we will be using <strong>ANTS</strong> to execute the following three tasks:</p>
<p><strong>Create a normtemplate out of anatomical images</strong></p>
<img alt="_images/subjects2normtemp.png" src="_images/subjects2normtemp.png" style="width: 810px;" />
<p>On the left you can see 15 individual anatomical images in subject space. ANTS built in 24 hours an awesome normtemplate out of them, shown on the right.</p>
<p><strong>Normalize your anatomical images to a normtemplate</strong></p>
<img alt="_images/subj2norm.png" src="_images/subj2norm.png" style="width: 610px;" />
<p>ANTS takes an anatomical image in subject space (left), normalizes it to a normtemplate (middle) and produces a subject specific anatomical image in template space (right), which looks actually just like the normtemplate. But the important output of this procedure is that ANTS stores the transformation data. This allows to transform anything of this subject from subject into template space.</p>
<p><strong>Normalize your functional images to a normtemplate</strong></p>
<img alt="_images/func2norm.png" src="_images/func2norm.png" style="width: 400px;" />
<p>On the right you can see anatomical and functional data of a subject in subject space and on the right the same data in template space.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Of course there is much more more that <strong>ANTS</strong> can offer than this. Normalizing your DTI data, project an area from your normtemplate (e.g. hippocampus) back into subject space or how to handle images of <a class="reference external" href="http://picsl.upenn.edu/ANTS/failure.php">subjects with severe neurodegeneration</a>. And the depth to which you can parameterize your normalization is too big to be covered in this beginner&#8217;s guide. So for more detailed explanation to the algorithms and for a wider knowledge about <strong>ANTS</strong>, please visit the <a class="reference external" href="http://picsl.upenn.edu/ANTS/">ANTS homepage</a>.</p>
</div>
</div>
<div class="section" id="ants-basics-you-should-be-aware-of">
<h2>ANTS basics you should be aware of<a class="headerlink" href="#ants-basics-you-should-be-aware-of" title="Permalink to this headline">¶</a></h2>
<p>Because the <a class="reference external" href="http://picsl.upenn.edu/ANTS/">ANTS homepage</a> already covers the basic knowledge very well, I more or less copied the content of this subsection from there, but still tried to summarize it to a short overview.</p>
<div class="section" id="i-o-data-formats-in-ants">
<h3>I/O data formats in ANTS<a class="headerlink" href="#i-o-data-formats-in-ants" title="Permalink to this headline">¶</a></h3>
<p><strong>ANTS</strong> can deal with 2D and 3D images and handle the following four data types:</p>
<ul class="simple">
<li>Nifti (.nii, .nii.gz)</li>
<li>Analyze (.hdr + .img / .img.gz)</li>
<li>MetaImage (.mha)</li>
<li>Other formats through itk::ImageFileWriter / itk::ImageFileWriter such as jpg, tiff, etc.</li>
</ul>
</div>
<div class="section" id="image-registration-with-ants">
<h3>Image registration with ANTS<a class="headerlink" href="#image-registration-with-ants" title="Permalink to this headline">¶</a></h3>
<p>There are two general applications of image registration:</p>
<ol class="arabic simple">
<li><strong>Transform labeled data from a template image space into an individual space</strong>. This strategy is important when appearance alone is not enough to locate a structure as, for example, in the case of hippocampus segmentation. The template provides a prediction of the hippocampus-amygdala boundary. (more to this topic <a class="reference external" href="http://picsl.upenn.edu/ANTS/tutorials/hipptutorial.php">here</a>)</li>
<li><strong>Instead of mapping template to individual, we map individual(s) to the template</strong> (”inverse” direction of the first). Voxel-based population studies of either functional or structural variables depend on mapping to a template space. The common coordinate system enables a statistical evaluation of the likelihood of consistent activation across a group or, in other contexts, the differences in anatomy between two groups.</li>
</ol>
<p>The second way of image registration will also be what  we will cover in this guide. The main challenge in image and brain mapping is defining the way in which images/anatomy are compared. There are two components to the comparison:</p>
<ol class="arabic simple">
<li>The <strong>shape transformation space</strong> defines the range of shape variation that will be allowed in the optimization (more to this <a class="reference external" href="http://picsl.upenn.edu/ANTS/templatetut/TransformationTutorial.php">here</a>).</li>
<li>The <strong>appearance similarity space</strong> defines the statistical assumptions that determine when one image is considered to appear similar to another (more to this <a class="reference external" href="http://picsl.upenn.edu/ANTS/metric.php">here</a>).</li>
</ol>
</div>
<div class="section" id="ants-transformation-models">
<h3>ANTS Transformation Models<a class="headerlink" href="#ants-transformation-models" title="Permalink to this headline">¶</a></h3>
<p><strong>ANTS</strong> provides a hierarchy of transformations with adjustable levels of complexity, regularization, degrees of freedom and behavior as optimizers. The simplest transformation model is the rigid and affine transform. The most complex and most flexible is a symmetric diffeomorphic transformation based on optimizing and integrating a time-varying velocity field. Computation time also increases with transformation model complexity, but most normalization needs may be met with under an hour of computation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">More information to affine, rigid, deformable registration and diffeomorphic transformations can be found at <strong>2.2 ANTS Transformation Models</strong> in the <strong>ants.pdf</strong> which can be found on the <a class="reference external" href="http://picsl.upenn.edu/ANTS/">ANTS homepage</a>.</p>
</div>
</div>
</div>
<div class="section" id="what-do-the-scripts-do">
<h2>What do the scripts do?<a class="headerlink" href="#what-do-the-scripts-do" title="Permalink to this headline">¶</a></h2>
<p>As always, before we can start writing the scripts we have to know what they actually do. For the tasks we want to cover in this user&#8217;s guide we need to understand the following three scripts:</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">buildtemplateparallel.sh</span></tt> to create a normtemplate out of anatomical images</li>
<li><tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> to normalize anatomical images (here called moving images) to a normtemplate (here called fixed images)</li>
<li><tt class="docutils literal"><span class="pre">WarpImageMultiTransform</span></tt> to normalize moving images (e.g. functionals) to a fixed image (e.g. normtemplate)</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you don&#8217;t want to know what the scripts do and you just want to use the default mode, skip this subsection. But as a result your normalization might not be the best one.</p>
</div>
<div class="section" id="buildtemplateparallel-sh">
<h3>buildtemplateparallel.sh<a class="headerlink" href="#buildtemplateparallel-sh" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">buildtemplateparallel.sh</span></tt> will make a template out of the input files we provide. This script builds a template iteratively and takes a long time to compute (e.g. for 8 iterations of 10-15 subjects using 4 cores you should expect 20h-30h computation time). Let&#8217;s now look at the command, the arguments and the output of the script.</p>
<div class="section" id="command">
<h4>Command<a class="headerlink" href="#command" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">bash</span> <span class="pre">~PATHTOANTS/buildtemplateparallel.sh</span> <span class="pre">-d</span> <span class="pre">ImageDimension</span> <span class="pre">-o</span> <span class="pre">OUTPREFIX</span> <span class="pre">&lt;other</span> <span class="pre">options&gt;</span> <span class="pre">&lt;images&gt;</span></tt></p>
</div>
<div class="section" id="compulsory-arguments">
<h4>Compulsory arguments<a class="headerlink" href="#compulsory-arguments" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><strong>-d</strong> ImageDimension: <tt class="docutils literal"><span class="pre">2</span></tt> or <tt class="docutils literal"><span class="pre">3</span></tt> (for 2 or 3 dimensional registration of single volume), <tt class="docutils literal"><span class="pre">4</span></tt> (for 3 dimensional registration of time-series; requires FSL)</li>
<li><strong>-o</strong> <tt class="docutils literal"><span class="pre">OUTPREFIX</span></tt>; A prefix that is prepended to all output files.</li>
<li><strong>&lt;images&gt;</strong> List of images in the current directory (e.g. <tt class="docutils literal"><span class="pre">*_T1.nii</span></tt> means that it takes all files which end with <tt class="docutils literal"><span class="pre">_T1.nii</span></tt> as input files). Should be at the end of the command and all files to be added to the template should be in the same directory.</li>
</ul>
</div>
<div class="section" id="optional-arguments">
<h4>Optional arguments<a class="headerlink" href="#optional-arguments" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><strong>-c</strong> Control for parallel computation. <tt class="docutils literal"><span class="pre">0</span></tt> = run serially, <tt class="docutils literal"><span class="pre">1</span></tt> = use SGE qsub, <tt class="docutils literal"><span class="pre">2</span></tt> = use PEXEC</p>
</li>
<li><p class="first"><strong>-g</strong> <strong>Gradient step size</strong>; smaller in magnitude results in more cautious steps</p>
</li>
<li><p class="first"><strong>-i</strong> <strong>Iteration limit</strong> for template construction</p>
</li>
<li><p class="first"><strong>-j</strong> <strong>Number of CPU cores</strong> to use</p>
</li>
<li><div class="first line-block">
<div class="line"><strong>-m</strong> <strong>Max-Iterations</strong> in form: JxKxL where</div>
<div class="line">J = max iterations at coarsest resolution (reduce by power of 2^2)</div>
<div class="line">K = middle resolution iterations (reduce by power of 2)</div>
<div class="line">L = fine resolution iterations (full resolution) !!this level takes much more time per iteration!!</div>
<div class="line">Adding an extra value before JxKxL (i.e. IxJxKxL) would add another iteration level.</div>
</div>
</li>
<li><p class="first"><strong>-n</strong> <strong>N3BiasFieldCorrection</strong> of moving image (<tt class="docutils literal"><span class="pre">0</span></tt> = off; <tt class="docutils literal"><span class="pre">1</span></tt> = on)</p>
</li>
<li><p class="first"><strong>-r</strong> Do <strong>rigid-body registration</strong> of inputs before creating template (<tt class="docutils literal"><span class="pre">0</span></tt> = off, <tt class="docutils literal"><span class="pre">1</span></tt> = on). Only useful when you do not have an initial template.</p>
</li>
<li><div class="first line-block">
<div class="line"><strong>-s</strong> Type of <strong>similarity metric</strong> used for registration.</div>
<div class="line">For <strong>intramodal</strong> image registration, use:</div>
<div class="line"><tt class="docutils literal"><span class="pre">CC</span></tt> = cross-correlation</div>
<div class="line"><tt class="docutils literal"><span class="pre">MI</span></tt> = mutual information</div>
<div class="line"><tt class="docutils literal"><span class="pre">PR</span></tt> = probability mapping</div>
<div class="line"><tt class="docutils literal"><span class="pre">MSQ</span></tt> = mean square difference</div>
<div class="line">For <strong>intermodal</strong> image registration, use:</div>
<div class="line"><tt class="docutils literal"><span class="pre">MI</span></tt> = mutual information</div>
<div class="line"><tt class="docutils literal"><span class="pre">PR</span></tt> = probability mapping</div>
</div>
</li>
<li><div class="first line-block">
<div class="line"><strong>-t</strong> Type of <strong>transformation model</strong> used for registration.</div>
<div class="line">For <strong>elastic</strong> image registration, use:</div>
<div class="line"><tt class="docutils literal"><span class="pre">EL</span></tt> = elastic transformation model (less deformation possible)</div>
<div class="line">For <strong>diffeomorphic</strong> image registration, use:</div>
<div class="line"><tt class="docutils literal"><span class="pre">SY</span></tt> = SyN with time with arbitrary number of time points in time discretization</div>
<div class="line"><tt class="docutils literal"><span class="pre">S2</span></tt> = SyN with time optimized specifically for 2 time points in the time discretization</div>
<div class="line"><tt class="docutils literal"><span class="pre">GR</span></tt> = Greedy SyN</div>
<div class="line"><tt class="docutils literal"><span class="pre">EX</span></tt> = Exponential</div>
<div class="line"><tt class="docutils literal"><span class="pre">DD</span></tt> = Diffeomorphic Demons style exponential mapping</div>
</div>
</li>
<li><p class="first"><strong>-z</strong> Use this this volume as the target of all inputs. When not used, the script will create an unbiased starting point by averaging all inputs.</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This information can also be seen by using the command <tt class="docutils literal"><span class="pre">bash</span> <span class="pre">buildtemplateparallel.sh</span> <span class="pre">--help</span></tt>.</p>
</div>
</div>
<div class="section" id="defaults-of-the-script">
<h4>Defaults of the script<a class="headerlink" href="#defaults-of-the-script" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Parallel mode: <tt class="docutils literal"><span class="pre">-c</span> <span class="pre">1</span></tt> - By default, buildtemplateparallel tries to do things in parallel</li>
<li>Gradient step size: <tt class="docutils literal"><span class="pre">-g</span> <span class="pre">0.25</span></tt> smaller in magnitude means more smaller (more cautious) steps</li>
<li>Number of iterations: <tt class="docutils literal"><span class="pre">-i</span> <span class="pre">4</span></tt></li>
<li>Number of cubes: <tt class="docutils literal"><span class="pre">-j</span> <span class="pre">2</span></tt></li>
<li>Max-Iteration: <tt class="docutils literal"><span class="pre">-m</span> <span class="pre">30x90x20</span></tt></li>
<li>N3BiasFieldCorrection: <tt class="docutils literal"><span class="pre">-n</span> <span class="pre">1</span></tt></li>
<li>Rigid-body registration: <tt class="docutils literal"><span class="pre">-r</span> <span class="pre">0</span></tt></li>
<li>Similarity metric: <tt class="docutils literal"><span class="pre">-s</span> <span class="pre">PR</span></tt></li>
<li>Transformation model: <tt class="docutils literal"><span class="pre">-t</span> <span class="pre">GR</span></tt></li>
</ul>
</div>
<div class="section" id="output-of-the-script">
<h4>Output of the script<a class="headerlink" href="#output-of-the-script" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">buildtemplateparallel.sh</span></tt> actually uses both other scripts <tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> (to create the needed input for WarpImageMultiTransform) and <tt class="docutils literal"><span class="pre">WarpImageMultiTransform</span></tt> (to map images from one space into another) to execute. The outcome stabilizes at around ten images and 8 iterations for most populations.</p>
<p>This script generates a lot of output considering that we are only interested in one output, the normtemplate. In the folder where you are running the script, additional folders will be created during execution, one for each iteration. The name for the folder with the result of the first iteration is called <strong>GR_iteration_0</strong> if your transformation model is <tt class="docutils literal"><span class="pre">GR</span></tt> and the folder of the forth iteration is called <strong>GR_iteration_3</strong>. Each of this folder contains the output of the <tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> script for each subject <strong>AND</strong> for the normtemplate.</p>
<p>Additionally to this folders the output of the current iteration level will be stored in the folder where you are running the script. So for two iterations with two subjects (s1 and s2) and a Prefix=PRE, the output of <tt class="docutils literal"><span class="pre">buildtemplateparallel.sh</span></tt> would be:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">s1T1.cfg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs1T1.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs2T1Warpxvec.nii.gz</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">s1T1.nii</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs1T1repaired.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs2T1Warpyvec.nii.gz</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">s2T1.cfg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs1T1Warpxvec.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs2T1Warpzvec.nii.gz</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">s2T1.nii</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs1T1Warpyvec.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREtemplateAffine.txt</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">GRiteration0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs1T1Warpzvec.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREtemplateInverseWarp.nii.gz</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">GRiteration1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs2T1Affine.txt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREtemplate.nii.gz</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">populationmean.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs2T1deformed.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREtemplatewarpxlog.txt</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">PREs1T1Affine.txt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs2T1InverseWarpxvec.nii.gz</span> <span class="pre">PREtemplatewarpxvec.nii.gz</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">PREs1T1deformed.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREs2T1InverseWarpyvec.nii.gz</span> <span class="pre">PREtemplatewarpylog.txt</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">PREs1T1InverseWarpxvec.nii.gz</span> <span class="pre">PREs2T1InverseWarpzvec.nii.gz</span> <span class="pre">PREtemplatewarpyvec.nii.gz</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">PREs1T1InverseWarpyvec.nii.gz</span> <span class="pre">PREs2T1.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREtemplatewarpzlog.txt</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">PREs1T1InverseWarpzvec.nii.gz</span> <span class="pre">PREs2T1repaired.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">PREtemplatewarpzvec.nii.gz</span></tt></div>
</div>
<p>The <strong>normtemplate</strong> you wanted to be build will be at the highest iteration level, in this case at <tt class="docutils literal"><span class="pre">~PATHTOEXECUTIONFOLDER/GR_iteration_1/PREtemplate.nii.gz</span></tt></p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Because this script generates <strong>a lot</strong> of output be sure to delete everything you don&#8217;t need!! One subject file of 16MB creates around 150MB output <strong>per</strong> iteration, leaving you with 12GB for 10 subjects and 8 iterations.</p>
</div>
</div>
</div>
<div class="section" id="antsintroduction-sh">
<h3>antsIntroduction.sh<a class="headerlink" href="#antsintroduction-sh" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> will perform an elastic or diffeomorphic transformation of the moving image space into the fixed image space. Let&#8217;s now look at the command, the arguments and the output of the script.</p>
<div class="section" id="id5">
<h4>Command<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">bash</span> <span class="pre">~PATHTOANTS/antsIntroduction.sh</span> <span class="pre">-d</span> <span class="pre">ImageDimension</span> <span class="pre">-r</span> <span class="pre">fixed.ext</span> <span class="pre">-i</span> <span class="pre">moving.ext</span> <span class="pre">&lt;other</span> <span class="pre">options&gt;</span></tt></p>
</div>
<div class="section" id="id6">
<h4>Compulsory arguments<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><strong>-d</strong> ImageDimension: <tt class="docutils literal"><span class="pre">2</span></tt> or <tt class="docutils literal"><span class="pre">3</span></tt> (for 2 or 3 Dimensional registration)</li>
<li><strong>-i</strong> Input image</li>
<li><strong>-r</strong> Reference image</li>
</ul>
</div>
<div class="section" id="id7">
<h4>Optional arguments<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><strong>-f</strong> Force script to proceed even if headers may be incompatible (<tt class="docutils literal"><span class="pre">0</span></tt> = no, <tt class="docutils literal"><span class="pre">1</span></tt> = yes). ANTS will perform a basic header sanity check. If you want to trust it, use -f 0.</p>
</li>
<li><p class="first"><strong>-l</strong> Labels-In-Fixed-Image-Space-To-Deform-To-Moving-Image. This maps a template labeled image to the target space. For instance for template-based segmentation. Applies the inverse warp to the labels to estimate the label positions in target space.</p>
</li>
<li><p class="first"><strong>-m</strong> the same as in buildtemplateparallel.sh</p>
</li>
<li><p class="first"><strong>-n</strong> the same as in buildtemplateparallel.sh</p>
</li>
<li><p class="first"><strong>-o</strong> the same as in buildtemplateparallel.sh</p>
</li>
<li><div class="first line-block">
<div class="line"><strong>-q</strong>  Perform a Quality Check of the result ( <tt class="docutils literal"><span class="pre">0</span></tt> = off ; <tt class="docutils literal"><span class="pre">1</span></tt> = on ). Calculates:</div>
<div class="line"><tt class="docutils literal"><span class="pre">-</span> <span class="pre">image</span> <span class="pre">similarity</span></tt>. <tt class="docutils literal"><span class="pre">0</span></tt> = intensity difference, <tt class="docutils literal"><span class="pre">1</span></tt> = correlation, <tt class="docutils literal"><span class="pre">2</span></tt> = mutual information</div>
<div class="line"><tt class="docutils literal"><span class="pre">-</span> <span class="pre">dice</span> <span class="pre">overlap</span></tt>. Dice Overlap is a standard measure for segmentation accuracy that shows a percentage of agreement between two segmentations.</div>
<div class="line"><tt class="docutils literal"><span class="pre">-</span> <span class="pre">min-dist-sum</span></tt> from the approximately segmented brain (3 tissues and background). Min-dist-sum is the minimum distance sum which is the total shortest distance between A and B evaluated over the object surfaces. This tells the overall euclidean disagreement between the boundaries of the labeled regions.</div>
</div>
</li>
<li><p class="first"><strong>-s</strong> the same as in buildtemplateparallel.sh</p>
</li>
<li><div class="first line-block">
<div class="line"><strong>-t</strong> Type of transformation model used for registration.</div>
<div class="line">For <strong>rigid</strong> image registration, use:</div>
<div class="line"><tt class="docutils literal"><span class="pre">RI</span></tt> = Purely rigid</div>
<div class="line"><tt class="docutils literal"><span class="pre">RA</span></tt> = Affine rigid</div>
<div class="line">For <strong>elastic</strong> and <strong>diffeomorphic</strong> the parameters are the same as in buildtemplateparallel.sh</div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This information can also be seen by using the command <tt class="docutils literal"><span class="pre">bash</span> <span class="pre">antsIntroduction.sh</span> <span class="pre">--help</span></tt>.</p>
</div>
</div>
<div class="section" id="id8">
<h4>Defaults of the script<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Ignore header warning: <tt class="docutils literal"><span class="pre">-f</span> <span class="pre">1</span></tt></li>
<li>Labels-In-Fixed-Image-Space-To-Deform-To-Moving-Image: <tt class="docutils literal"><span class="pre">-l</span> <span class="pre">0</span></tt></li>
<li>Max-Iteration: <tt class="docutils literal"><span class="pre">-m</span> <span class="pre">30x90x20</span></tt></li>
<li>N3BiasFieldCorrection: <tt class="docutils literal"><span class="pre">-n</span> <span class="pre">1</span></tt></li>
<li>ANTS Quality Check: <tt class="docutils literal"><span class="pre">-q</span> <span class="pre">0</span></tt></li>
<li>Similarity metric: <tt class="docutils literal"><span class="pre">-s</span> <span class="pre">PR</span></tt></li>
<li>Transformation model: <tt class="docutils literal"><span class="pre">-t</span> <span class="pre">GR</span></tt></li>
</ul>
</div>
<div class="section" id="id9">
<h4>Output of the script<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>The names and formats of the output files are both specified by <tt class="docutils literal"><span class="pre">-o</span> <span class="pre">option</span></tt>. For example, for in 3D with <tt class="docutils literal"><span class="pre">-o</span> <span class="pre">Prefix_.nii.gz</span></tt>, the output files are:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Prefix_Affine.txt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">Prefix_InverseWarpyvec.nii.gz</span>&nbsp; <span class="pre">Prefix_Warpxvec.nii.gz</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">Prefix_deformed.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">Prefix_InverseWarpzvec.nii.gz</span>&nbsp; <span class="pre">Prefix_Warpyvec.nii.gz</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">Prefix_InverseWarpxvec.nii.gz</span>&nbsp; <span class="pre">Prefix_repaired.nii.gz</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">Prefix_Warpzvec.nii.gz</span></tt></div>
</div>
<p>They can be categorized into:</p>
<ul class="simple">
<li><strong>Affine transform file:</strong> <tt class="docutils literal"><span class="pre">Prefix_Affine.txt</span></tt></li>
<li><strong>Warping deformation field:</strong> <tt class="docutils literal"><span class="pre">Prefix_Warpxvec.nii.gz</span></tt>, <tt class="docutils literal"><span class="pre">Prefix_Warpyvec.nii.gz</span></tt>, <tt class="docutils literal"><span class="pre">Prefix_Warpzvec.nii.gz</span></tt></li>
<li><strong>Inverse warping deformation field:</strong> <tt class="docutils literal"><span class="pre">Prefix_InverseWarpxvec.nii.gz</span></tt>, <tt class="docutils literal"><span class="pre">Prefix_InverseWarpyvec.nii.gz</span></tt>, <tt class="docutils literal"><span class="pre">Prefix_InverseWarpzvec.nii.gz</span></tt></li>
<li><strong>Inputfile:</strong> <tt class="docutils literal"><span class="pre">Prefix_repaired.nii.gz</span></tt></li>
<li><strong>Outputfile:</strong> <tt class="docutils literal"><span class="pre">Prefix_deformed.nii.gz</span></tt></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is important to note that <tt class="docutils literal"><span class="pre">Prefix_Affine.txt</span></tt>, <tt class="docutils literal"><span class="pre">Prefix_Warpxvec.nii.gz</span></tt>, <tt class="docutils literal"><span class="pre">Prefix_Warpyvec.nii.gz</span></tt>, <tt class="docutils literal"><span class="pre">Prefix_Warpzvec.nii.gz</span></tt>, <tt class="docutils literal"><span class="pre">Prefix_deformed.nii.gz</span></tt> are needed for the execution of <strong>WarpImageMultiTransform</strong></p>
</div>
</div>
</div>
<div class="section" id="warpimagemultitransform">
<h3>WarpImageMultiTransform<a class="headerlink" href="#warpimagemultitransform" title="Permalink to this headline">¶</a></h3>
<p>Actually both <tt class="docutils literal"><span class="pre">buildtemplateparallel.sh</span></tt> and <tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> use <tt class="docutils literal"><span class="pre">WarpImageMultiTransform</span></tt> during execution to warp an image (a so called moving image) from one space into a another space (a so called fixed space), in general a template space. Let&#8217;s now look at the command, the arguments and the output of the script.</p>
<div class="section" id="id10">
<h4>Command<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">WarpImageMultiTransform</span> <span class="pre">ImageDimension</span> <span class="pre">moving_image</span> <span class="pre">output_image</span>&nbsp; <span class="pre">-R</span> <span class="pre">reference_image</span> <span class="pre">SeriesOfTransformations</span> <span class="pre">&lt;other</span> <span class="pre">options&gt;</span></tt></p>
<p><strong>SeriesOfTransformations</strong> WarpImageMultiTransform can apply, via concatenation, an unlimited number of transformations to your data. Thus, SeriesOfTransformations may be  an Affine transform followed by a warp  another affine and then another warp. For example mapping a warped image into the reference_image domain by applying abcdWarpxvec.nii.gz/abcdWarpyvec.nii.gz/abcdWarpzvec.nii.gz and then abcdAffine.txt would need the following code:</p>
<p><tt class="docutils literal"><span class="pre">WarpImageMultiTransform</span> <span class="pre">3</span> <span class="pre">moving_image</span> <span class="pre">output_image</span> <span class="pre">-R</span> <span class="pre">reference_image</span> <span class="pre">abcdWarp.nii.gz</span> <span class="pre">abcdAffine.txt</span></tt></p>
</div>
<div class="section" id="id11">
<h4>Compulsory arguments<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><strong>ImageDimension:</strong> <tt class="docutils literal"><span class="pre">2</span></tt> or <tt class="docutils literal"><span class="pre">3</span></tt> (for 2 or 3 Dimensional registration)</li>
<li><strong>moving_image:</strong> the image to apply the transformation to (in our case the functional or in the case of <tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> the anatomical images)</li>
<li><strong>output_image:</strong> the resulting image (in our case the normtemplate). Prefixname &#8220;abcd&#8221; without any extension will use &#8220;.nii.gz&#8221; by default.</li>
</ul>
</div>
<div class="section" id="id12">
<h4>Optional arguments<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<ul>
<li><div class="first line-block">
<div class="line"><strong>-R</strong> reference_image space that you wish to warp INTO.</div>
<div class="line"><em>&#8211;tightest-bounding-box</em>: Computes the tightest bounding box using all the affine transformations. It will be overridden by -R reference_image if given.</div>
<div class="line"><em>&#8211;reslice-by-header</em>: equivalient to -i -mh, or -fh -i -mh if used together with -R. It uses the orientation matrix and origin encoded in the image file header.</div>
<div class="line">It can be used together with -R. This is typically not used together with any other transforms.</div>
</div>
</li>
<li><p class="first"><strong>&#8211;use-NN</strong> Use Nearest Neighbor Interpolation</p>
</li>
<li><p class="first"><strong>&#8211;use-BSpline</strong> Use 3rd order B-Spline Interpolation.</p>
</li>
<li><p class="first"><strong>-i</strong> will use the inversion of the following affine transform.</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This information can also be seen by using the command <tt class="docutils literal"><span class="pre">WarpImageMultiTransform</span> <span class="pre">--help</span></tt>.</p>
</div>
</div>
<div class="section" id="id13">
<h4>Output of the script<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">WarpImageMultiTransform</span></tt> does only create one output file with the name specified by <tt class="docutils literal"><span class="pre">output_image</span></tt>. But to execute, it also needs the following five files: <tt class="docutils literal"><span class="pre">Affine.txt</span></tt>, <tt class="docutils literal"><span class="pre">Warpxvec.nii.gz</span></tt>, <tt class="docutils literal"><span class="pre">Warpyvec.nii.gz</span></tt>, <tt class="docutils literal"><span class="pre">Warpzvec.nii.gz</span></tt> and <tt class="docutils literal"><span class="pre">deformed.nii.gz</span></tt></p>
</div>
</div>
</div>
<div class="section" id="how-to-create-a-normtemplate-out-of-anatomical-images">
<h2>How to create a normtemplate out of anatomical images<a class="headerlink" href="#how-to-create-a-normtemplate-out-of-anatomical-images" title="Permalink to this headline">¶</a></h2>
<p>Before we can use any other ANTS script we first have to create the normtemplate. So let&#8217;s start building the script that executes <tt class="docutils literal"><span class="pre">buildtemplateparallel.sh</span></tt>.</p>
<div class="section" id="define-environment-parameters">
<h3>Define environment parameters<a class="headerlink" href="#define-environment-parameters" title="Permalink to this headline">¶</a></h3>
<p>As always, let us first set the environment and everything else up, so that the script can actually run and use ANTS.</p>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c">#specify where ANTS is installed</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/software/ANTS:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">ANTSPATH</span><span class="o">=</span>/software/ANTS/
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-experiment-specific-parameters">
<h3>Define experiment specific parameters<a class="headerlink" href="#define-experiment-specific-parameters" title="Permalink to this headline">¶</a></h3>
<p>Now let us specify all the parameters we might want to change from run to run.</p>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#specify list of subjects</span>
<span class="nv">subjectList</span><span class="o">=</span><span class="s1">&#39;subject1 subject2 subject3&#39;</span>

<span class="c">#specify folder names</span>
<span class="nv">experimentDir</span><span class="o">=</span>~SOMEPATH/experiment            <span class="c">#parent folder</span>
<span class="nv">inputDir</span><span class="o">=</span><span class="nv">$experimentDir</span>/AnatomicalImages      <span class="c">#folder containing anatomical images</span>
<span class="nv">normtempOutDir</span><span class="o">=</span><span class="nv">$experimentDir</span>/data            <span class="c">#where the normtemp should be stored at</span>
<span class="nv">workingDir</span><span class="o">=</span><span class="nv">$experimentDir</span>/normtemp_workingDir <span class="c">#temporary dir</span>

<span class="c">#specify parameters for buildtemplateparallel.sh</span>
<span class="c">#compulsory arguments</span>
<span class="nv">ImageDimension</span><span class="o">=</span>3
<span class="nv">OutPrefix</span><span class="o">=</span><span class="s1">&#39;PREFIX&#39;</span>

<span class="c">#optional arguments</span>
<span class="nv">ParallelMode</span><span class="o">=</span>2
<span class="nv">GradientStep</span><span class="o">=</span><span class="s1">&#39;0.25&#39;</span>
<span class="nv">IterationLimit</span><span class="o">=</span>4
<span class="nv">Cores</span><span class="o">=</span>2
<span class="nv">MaxIteration</span><span class="o">=</span>30x90x20
<span class="nv">N3Correct</span><span class="o">=</span>1
<span class="nv">Rigid</span><span class="o">=</span>0
<span class="nv">MetricType</span><span class="o">=</span><span class="s1">&#39;PR&#39;</span>
<span class="nv">TransformationType</span><span class="o">=</span><span class="s1">&#39;GR&#39;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="write-the-main-script">
<h3>Write the main script<a class="headerlink" href="#write-the-main-script" title="Permalink to this headline">¶</a></h3>
<p>After all preparations are done, let us now write the main script.</p>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#If not created yet, let&#39;s create a new output folder</span>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$workingDir</span> <span class="o">]</span>
<span class="k">then</span>
<span class="k">   </span>mkdir -p <span class="nv">$workingDir</span>
<span class="k">fi</span>

<span class="c">#go into the folder where the script should be run</span>
<span class="nb">cd</span> <span class="nv">$workingDir</span>

<span class="c">#Let&#39;s get the input, the subject specific anatomical images. You might</span>
<span class="c"># have to alter this part a bit to satisfy the structure of your system</span>
<span class="c">#Assuming that the name of your subject specific anatomical image is</span>
<span class="c"># &#39;subjectname.nii&#39; the loop to grab the files would look something like this</span>

<span class="k">for </span>subj in <span class="nv">$subjectList</span>
<span class="k">do</span>
<span class="k">   </span>cp <span class="nv">$inputDir</span>/<span class="nv">$subj</span>.nii <span class="nv">$workingDir</span>/<span class="nv">$subj</span><span class="s2">&quot;_antsT1.nii&quot;</span>
<span class="k">done</span> <span class="c">#subj done</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you want to use your skull stripped freesurfer_data, use the following loop instead of the code above. Assuming that <tt class="docutils literal"><span class="pre">inputDir=$experimentDir/freesurfer_data</span></tt> is specified.</p>
<div class="last highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Add this code at the beginning of your script,</span>
<span class="c"># after the specification to where ANTS is installed</span>
<span class="nb">export </span><span class="nv">FREESURFER_HOME</span><span class="o">=</span>/software/Freesurfer/5.1.0
<span class="nb">source</span> <span class="nv">$FREESURFER_HOME</span>/SetUpFreeSurfer.sh

<span class="c">#This loop grabs your skull stripped anatomical files from your freesurfer folder</span>
<span class="k">for </span>subj in <span class="nv">$subjectList</span>
<span class="k">do</span>
<span class="k">   </span><span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;mri_convert $inputDir/$subj/mri/brain.mgz $workingDir/$subj_antsT1.nii&quot;</span>
   <span class="nb">echo</span> <span class="nv">$cmd</span> <span class="c">#state the command</span>
   <span class="nb">eval</span> <span class="nv">$cmd</span> <span class="c">#execute the command</span>
<span class="k">done</span> <span class="c">#subj done</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Now that everything is set up we can call <tt class="docutils literal"><span class="pre">buildtemplateparallel.sh</span></tt>.</p>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#assemble the command for the script from the input parameters defined above</span>
<span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;bash $ANTSPATH/buildtemplateparallel.sh -d $ImageDimension -c $ParallelMode \</span>
<span class="s2">     -g $GradientStep -i $IterationLimit -j $Cores -m $MaxIteration -n $N3Correct  \</span>
<span class="s2">     -r $Rigid -s $MetricType -t $TransformationType -o $OutPrefix *_antsT1.nii&quot;</span>

<span class="nb">echo</span> <span class="nv">$cmd</span> <span class="c">#state the command</span>
<span class="nb">eval</span> <span class="nv">$cmd</span> <span class="c">#execute the command</span>
</pre></div>
</td></tr></table></div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>If you are running <tt class="docutils literal"><span class="pre">buildtemplateparallel.sh</span></tt> in parallel it is very important to know that if you abort the execution or if it crashes by itself, be sure that all jobs are actually terminated. This is very important because if you don&#8217;t you probably will overload your system pretty fast. So if you run it with...</p>
<ul class="last simple">
<li><tt class="docutils literal"><span class="pre">-c</span> <span class="pre">1</span></tt> (SGE qsub) use <tt class="docutils literal"><span class="pre">qstat</span></tt> to see which job is still running and <tt class="docutils literal"><span class="pre">qdel</span> <span class="pre">NumberOfJob</span></tt> to terminate the job</li>
<li><tt class="docutils literal"><span class="pre">-c</span> <span class="pre">2</span></tt> (PEXEC) use <tt class="docutils literal"><span class="pre">top</span></tt> or <tt class="docutils literal"><span class="pre">htop</span></tt> to see which job is still running and terminate it with <tt class="docutils literal"><span class="pre">kill</span> <span class="pre">NumberOfJob</span></tt></li>
</ul>
</div>
</div>
<div class="section" id="run-the-script">
<h3>Run the script<a class="headerlink" href="#run-the-script" title="Permalink to this headline">¶</a></h3>
<p>Now that everything is done you can run the script from the terminal with <tt class="docutils literal"><span class="pre">bash</span> <span class="pre">ANTScreateNormtemp.sh</span></tt> and wait till it&#8217;s done.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The code for the creation of normtemplate out of your anatomical images can be found here: <a class="reference external" href="http://github.com/miykael/nipype-beginner-s-guide/blob/master/ANTScreateNormtemp.sh">ANTScreateNormtemp.sh</a></p>
</div>
</div>
<div class="section" id="delete-unnecessary-output">
<h3>Delete unnecessary output<a class="headerlink" href="#delete-unnecessary-output" title="Permalink to this headline">¶</a></h3>
<p>This part is optional, but because <tt class="docutils literal"><span class="pre">buildtemplateparallel</span></tt> creates <strong>a lot</strong> of output it is <strong>highly recommended</strong> to delete everything else than the normtemplate that you actually wanted.</p>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#move the normtemplate to a safe place</span>
<span class="nv">lastIterationFolder</span><span class="o">=</span><span class="k">${</span><span class="nv">TransformationType</span><span class="k">}</span>_iteration_<span class="k">$((</span><span class="nv">$IterationLimit</span><span class="o">-</span><span class="m">1</span><span class="k">))</span>
<span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;mv $workingDir/$lastIterationFolder/${OutPrefix}template.nii.gz \</span>
<span class="s2">        $normtempOutDir/normtemp.nii.gz&quot;</span>
<span class="nb">echo</span> <span class="nv">$cmd</span> <span class="c">#state the command</span>
<span class="nb">eval</span> <span class="nv">$cmd</span> <span class="c">#execute the command</span>

<span class="c">#delete the workingdir</span>
rm -rf <span class="nv">$workingDir</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="how-to-normalize-anatomical-images-to-a-normtemplate">
<h2>How to normalize anatomical images to a normtemplate<a class="headerlink" href="#how-to-normalize-anatomical-images-to-a-normtemplate" title="Permalink to this headline">¶</a></h2>
<p>Now that we have created a normtemplate, we are ready to normalize images from subject space into the normtemplate space. First we will write a script that uses <tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> to normalize anatomical images.</p>
<div class="section" id="id14">
<h3>Define environment parameters<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c">#specify where ANTS is installed</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/software/ANTS:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">ANTSPATH</span><span class="o">=</span>/software/ANTS/
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id15">
<h3>Define experiment specific parameters<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#specify list of subjects</span>
<span class="nv">subjectList</span><span class="o">=</span><span class="s1">&#39;subject1 subject2 subject3&#39;</span>

<span class="c">#specify folder names</span>
<span class="nv">experimentDir</span><span class="o">=</span>~SOMEPATH/experiment               <span class="c">#parent folder</span>
<span class="nv">inputDir</span><span class="o">=</span><span class="nv">$experimentDir</span>/AnatomicalImages         <span class="c">#folder containing anatomical images</span>
<span class="nv">templateName</span><span class="o">=</span><span class="nv">$experimentDir</span>/data/normtemp.nii.gz <span class="c">#path to and name of normtemplate</span>
<span class="nv">normAnatOutDir</span><span class="o">=</span><span class="nv">$experimentDir</span>/normAnat           <span class="c">#outputdir of normalized T1 files</span>

<span class="c">#specify parameters for antsIntroduction.sh</span>
<span class="c">#compulsory arguments</span>
<span class="nv">ImageDimension</span><span class="o">=</span>3
<span class="nv">OutPrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="nv">ReferenceImage</span><span class="o">=</span><span class="nv">$templateName</span>

<span class="c">#optional arguments</span>
<span class="nv">IgnoreHDRWarning</span><span class="o">=</span>1
<span class="nv">MaxIteration</span><span class="o">=</span>30x90x20
<span class="nv">N3Correct</span><span class="o">=</span>0
<span class="nv">QualityCheck</span><span class="o">=</span>0
<span class="nv">MetricType</span><span class="o">=</span><span class="s1">&#39;PR&#39;</span>
<span class="nv">TransformationType</span><span class="o">=</span><span class="s1">&#39;GR&#39;</span>
</pre></div>
</td></tr></table></div>
<p>In this script we also want to have the option to specify if already existing output files should be overwritten or not. This is useful if you had to abort an earlier run.</p>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Do you want to overwrite existing output files? (1 = yes, 0 = no)</span>
<span class="nv">overwrite</span><span class="o">=</span>0
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id16">
<h3>Write the main script<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#If not created yet, let&#39;s create a new output folder</span>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$normAnatOutDir</span> <span class="o">]</span>
<span class="k">then</span>
<span class="k">   </span>mkdir -p <span class="nv">$normAnatOutDir</span>
<span class="k">fi</span>

<span class="c">#go into the folder where the script should be run</span>
<span class="nb">cd</span> <span class="nv">$normAnatOutDir</span>

<span class="c">#go through all subjects</span>
<span class="k">for </span>subj in <span class="nv">$subjectList</span>
<span class="k">do</span>

   <span class="c">#if anatomy of the subject wasn&#39;t normalized yet or if overwrite was set to 1=yes</span>
   <span class="c"># the antsIntroduction script gets executed</span>
   <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$normAnatOutDir</span>/<span class="nv">$OutPrefix$subj</span><span class="s2">&quot;deformed.nii.gz&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nv">$overwrite</span> <span class="o">==</span> 1 <span class="o">]</span>
   <span class="k">then</span>
      <span class="c">#assemble the command for the script from the input parameters defined above</span>
      <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;bash $ANTSPATH/antsIntroduction.sh -d $ImageDimension -r $ReferenceImage \</span>
<span class="s2">                -i $inputDir/$subj.nii -o $normAnatOutDir/$OutPrefix$subj \</span>
<span class="s2">                -f $IgnoreHDRWarning -m $MaxIteration -n $N3Correct -q $QualityCheck \</span>
<span class="s2">                -s $MetricType -t $TransformationType&quot;</span>
      <span class="nb">echo</span> <span class="nv">$cmd</span> <span class="c">#state the command</span>
      <span class="nb">eval</span> <span class="nv">$cmd</span> <span class="c">#execute the command</span>
   <span class="k">else</span>
<span class="k">      </span><span class="nb">echo</span> -e <span class="s2">&quot;NOTICE: ${OutPrefix}${subj}deformed.nii.gz does already exist! \</span>
<span class="s2">                       Skipping to next subject.&quot;</span>
   <span class="k">fi</span>
<span class="k">done</span> <span class="c">#subj done</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id17">
<h3>Run the script<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>Now that everything is done you can run the script from the terminal with <tt class="docutils literal"><span class="pre">bash</span> <span class="pre">ANTSnormalizeAnat.sh</span></tt> and wait till it&#8217;s done.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The code for the normalization of your anatomical images to a normtemplate can be found here: <a class="reference external" href="http://github.com/miykael/nipype-beginner-s-guide/blob/master/ANTSnormalizeAnat.sh">ANTSnormalizeAnat.sh</a></p>
</div>
</div>
<div class="section" id="id18">
<h3>Delete unnecessary output<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<p>This part is optional, but again <strong>highly recommended</strong>. <tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> creates for each subject file of 16MB an output of 140MB. So after you&#8217;ve used the output of this script for the normalization of your functional data, be sure to delete it.</p>
<p>The script will create additional output that you best delete manually. Specifically at the location of your fixed image (e.g. normtemplate) an inverse version of the normtemplate and at the location of your moving image (e.g. subject anatomy) a cfg-file with the name of the subject anatomy name can be found.</p>
</div>
</div>
<div class="section" id="how-to-normalize-functional-images-to-a-normtemplate">
<h2>How to normalize functional images to a normtemplate<a class="headerlink" href="#how-to-normalize-functional-images-to-a-normtemplate" title="Permalink to this headline">¶</a></h2>
<p>After <tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> has created the necessary output for the normalization of the functional data, we are ready to write the script that uses <tt class="docutils literal"><span class="pre">WarpImageMultiTransform</span></tt>.</p>
<div class="section" id="id19">
<h3>Define environment parameters<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c">#specify where ANTS is installed</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/software/ANTS:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">ANTSPATH</span><span class="o">=</span>/software/ANTS/

<span class="c">#specify where FreeSurfer is installed</span>
<span class="nb">export </span><span class="nv">FREESURFER_HOME</span><span class="o">=</span>/software/Freesurfer/5.1.0
<span class="nb">source</span> <span class="nv">$FREESURFER_HOME</span>/SetUpFreeSurfer.sh
</pre></div>
</td></tr></table></div>
<p>The setting of the FreeSurfer environment is needed for the usage of <tt class="docutils literal"><span class="pre">mri_convert</span></tt> later on.</p>
</div>
<div class="section" id="id20">
<h3>Define experiment specific parameters<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#specify list of subjects</span>
<span class="nv">subjectList</span><span class="o">=</span><span class="s1">&#39;subject1 subject2 subject3&#39;</span>

<span class="c">#specify list of contrasts. (empty = all contrasts will be normalized</span>
<span class="nv">contrastList</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="c">#specify folder names</span>
<span class="nv">experimentDir</span><span class="o">=</span>~SOMEPATH/experiment               <span class="c">#parent folder</span>
<span class="nv">inputDir</span><span class="o">=</span><span class="nv">$experimentDir</span>/result/vol_contrasts     <span class="c">#folder containing functional images</span>
<span class="nv">templateName</span><span class="o">=</span><span class="nv">$experimentDir</span>/data/normtemp.nii.gz <span class="c">#path to and name of normtemplate</span>
<span class="nv">normAnatDir</span><span class="o">=</span><span class="nv">$experimentDir</span>/normAnat              <span class="c">#outputdir of normalized T1 images</span>
<span class="nv">funcOutDir</span><span class="o">=</span><span class="nv">$inputDir</span>                             <span class="c">#outputdir of normalized functional images</span>

<span class="c">#Do you want to overwrite existing output files? (1 = yes, 0 = no)</span>
<span class="nv">overwrite</span><span class="o">=</span>0
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id21">
<h3>Write the main script<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#If not created yet, let&#39;s create a new output folder</span>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$funcOutDir</span> <span class="o">]</span>
<span class="k">then</span>
<span class="k">   </span>mkdir -p <span class="k">${</span><span class="nv">funcOutDir</span><span class="k">}</span>
<span class="k">fi</span>

<span class="c">#go through all subjects</span>
<span class="k">for </span>subj in <span class="nv">$subjectList</span>
<span class="k">do</span>

   <span class="c">#If not created yet, let&#39;s create a subject specific folder</span>
   <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$funcOutDir</span>/<span class="nv">$subj</span> <span class="o">]</span>
   <span class="k">then</span>
<span class="k">      </span>mkdir <span class="k">${</span><span class="nv">funcOutDir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>
   <span class="k">fi</span>

   <span class="c">#If not created yet, let&#39;s create a folder for the normalized cons</span>
   <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$funcOutDir</span>/<span class="nv">$subj</span>/normcons <span class="o">]</span>
   <span class="k">then</span>
<span class="k">      </span>mkdir -p <span class="nv">$funcOutDir</span>/<span class="nv">$subj</span>/normcons
   <span class="k">fi</span>

   <span class="c">#If not created yet, let&#39;s create a folder for the normalized spmTs</span>
   <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$funcOutDir</span>/<span class="nv">$subj</span>/normspmTs <span class="o">]</span>
   <span class="k">then</span>
<span class="k">      </span>mkdir -p <span class="nv">$funcOutDir</span>/<span class="nv">$subj</span>/normspmTs
   <span class="k">fi</span>

   <span class="c">#checks if all necessary output of antsIntroduction.sh exists</span>
   <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$normAnatDir</span>/<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>deformed.nii.gz <span class="o">]</span> <span class="o">||</span>
      <span class="o">[</span> ! -e <span class="nv">$normAnatDir</span>/<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>Warpxvec.nii.gz <span class="o">]</span> <span class="o">||</span>
      <span class="o">[</span> ! -e <span class="nv">$normAnatDir</span>/<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>Warpyvec.nii.gz <span class="o">]</span> <span class="o">||</span>
      <span class="o">[</span> ! -e <span class="nv">$normAnatDir</span>/<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>Warpzvec.nii.gz <span class="o">]</span> <span class="o">||</span>
      <span class="o">[</span> ! -e <span class="nv">$normAnatDir</span>/<span class="k">${</span><span class="nv">subj</span><span class="k">}</span>Affine.txt <span class="o">]</span>
   <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> -e <span class="s2">&quot;NOTICE: A necessary ANTS output file of subject ${subj} was not found.\</span>
<span class="s2">                       Skipping to next subject.&quot;</span>
      <span class="k">continue</span>
<span class="k">   fi</span>
</pre></div>
</td></tr></table></div>
<p>Now we need to know which contrasts we want to normalize. If you have specified a list above, the following part will be skipped, but if it was left empty = <tt class="docutils literal"><span class="pre">''</span></tt> this code will create a list containing the numbers numbers of all contrasts stored in <tt class="docutils literal"><span class="pre">inputDir</span></tt>.</p>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre>   <span class="c">#create a list that contains numbers of contrasts if not specified above</span>
   <span class="k">if</span> <span class="o">[</span> <span class="nv">$contrastList</span><span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="o">]</span>
   <span class="k">then</span>
<span class="k">      </span><span class="nv">contrast</span><span class="o">=</span><span class="sb">`</span>ls <span class="nv">$inputDir</span>/<span class="nv">$subj</span>/con_*.img<span class="sb">`</span>
      <span class="nv">con_ID</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
      <span class="k">for </span>con in <span class="nv">$contrast</span>
      <span class="k">do</span>
<span class="k">         </span><span class="nv">length</span><span class="o">=</span><span class="k">${#</span><span class="nv">con</span><span class="k">}</span>
         <span class="nv">ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$con</span> | cut -c <span class="k">$((</span><span class="nv">$length</span><span class="o">-</span><span class="m">7</span><span class="k">))</span>-<span class="k">$((</span><span class="nv">$length</span><span class="o">-</span><span class="m">4</span><span class="k">))</span><span class="sb">`</span>
         <span class="nv">con_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">con_ID</span><span class="k">}</span><span class="s1">&#39; &#39;</span><span class="nv">$ID</span>
      <span class="k">done</span> <span class="c">#con done</span>
   <span class="k">else</span>
<span class="k">      </span><span class="nv">con_ID</span><span class="o">=</span><span class="nv">$contrastList</span>
   <span class="k">fi</span>
</pre></div>
</td></tr></table></div>
<p>Now that <tt class="docutils literal"><span class="pre">con_ID</span></tt> has a value like <tt class="docutils literal"><span class="pre">'0001</span> <span class="pre">0002</span> <span class="pre">0003'</span></tt> we are ready to go through the specified contrasts and normalize them.</p>
<div class="highlight-sh"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre>   <span class="c">#go through all contrasts</span>
   <span class="k">for </span>ID in <span class="nv">$con_ID</span>
   <span class="k">do</span>

      <span class="c">#to normalize &#39;con&#39; and &#39;spmT&#39; files</span>
      <span class="k">for </span><span class="nb">type </span>in con spmT
      <span class="k">do</span>

         <span class="c">#specify input image and name of normalized output image</span>
         <span class="nv">InImg</span><span class="o">=</span><span class="nv">$inputDir</span>/<span class="nv">$subj</span>/<span class="k">${</span><span class="nv">type</span><span class="k">}</span><span class="s2">&quot;_&quot;</span><span class="k">${</span><span class="nv">ID</span><span class="k">}</span>.img
         <span class="nv">OutNii</span><span class="o">=</span><span class="nv">$funcOutDir</span>/<span class="nv">$subj</span>/norm<span class="k">${</span><span class="nv">type</span><span class="k">}</span><span class="s2">&quot;s/ants_&quot;</span><span class="k">${</span><span class="nv">type</span><span class="k">}</span><span class="s2">&quot;_&quot;</span><span class="k">${</span><span class="nv">ID</span><span class="k">}</span>.nii

         <span class="c">#checks if input image exists</span>
         <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$InImg</span> <span class="o">]</span>
         <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> -e <span class="s2">&quot;NOTICE: Cannot find ${type}_${ID}.img of subject ${subj}&quot;</span>
            <span class="k">continue</span>
<span class="k">         fi</span>

         <span class="c">#contrast will be normalized if contrast wasn&#39;t normalized yet</span>
         <span class="c"># or if overwrite was set to 1=yes</span>
         <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$OutNii</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nv">$overwrite</span> <span class="o">==</span> 1 <span class="o">]</span>
         <span class="k">then</span>

            <span class="c">#assemble the command for the conversion of img to nii</span>
            <span class="nv">cmd1</span><span class="o">=</span><span class="s2">&quot;mri_convert &quot;</span><span class="k">${</span><span class="nv">InImg</span><span class="k">}</span><span class="s2">&quot; &quot;</span><span class="k">${</span><span class="nv">OutNii</span><span class="k">}</span>

            <span class="c">#assemble the command for the normalization</span>
            <span class="nv">cmd2</span><span class="o">=</span><span class="s2">&quot;WarpImageMultiTransform 3 ${OutNii} ${OutNii} \</span>
<span class="s2">                     -R $normAnatDir/${subj}deformed.nii.gz \</span>
<span class="s2">                     $normAnatDir/${subj}Warp.nii.gz \</span>
<span class="s2">                     $normAnatDir/${subj}Affine.txt&quot;</span>
            <span class="nb">eval</span> <span class="nv">$cmd1</span> <span class="c">#execute cmd1</span>
            <span class="nb">eval</span> <span class="nv">$cmd2</span> <span class="c">#execute cmd2</span>
         <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> -e <span class="s2">&quot;NOTICE: ${OutNii} already exists. Skipping to next contrast.&quot;</span>
         <span class="k">fi</span>

<span class="k">      done</span> <span class="c">#type done</span>
   <span class="k">done</span> <span class="c">#ID done</span>
<span class="k">done</span> <span class="c">#subj done</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id22">
<h3>Run the script<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<p>Now that everything is done you can run the script from the terminal with bash ANTSnormalizeFunc.sh and wait till it’s done.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The code for the normalization of your functional images to a normtemplate can be found here: <a class="reference external" href="http://github.com/miykael/nipype-beginner-s-guide/blob/master/ANTSnormalizeFunc.sh">ANTSnormalizeFunc.sh</a></p>
</div>
</div>
<div class="section" id="id23">
<h3>Delete unnecessary output<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p>Luckily this script doesn&#8217;t create any kind of waste. But as said before, if you know that you don&#8217;t need the output of <tt class="docutils literal"><span class="pre">antsIntroduction.sh</span></tt> make sure to delete it and free some space.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="regionOfInterest.html" title="How To Extract Regions Of Interest (ROIs)"
             >next</a> |</li>
        <li class="right" >
          <a href="secondLevelExample.html" title="How To Build A Second Level Pipeline"
             >previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.6 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Michael Notter.
      Last updated on September 12, 2011.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
</div>

  </body>
</html>