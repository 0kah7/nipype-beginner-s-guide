

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nipype Beginner&#39;s Guide &mdash; Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation" href="index.html" />
 
<meta name="keywords" content="nipype, python, guide">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24958678-1']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="index.html">
  <img src="_static/nipype-beginners-guide-banner-bg.png" alt="NIPY logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to extract region of interest (ROI)</a><ul>
<li><a class="reference internal" href="#anatomical-vs-functional-roi">Anatomical vs. Functional ROI</a><ul>
<li><a class="reference internal" href="#anatomical-roi">Anatomical ROI</a></li>
<li><a class="reference internal" href="#functional-roi">Functional ROI</a></li>
</ul>
</li>
<li><a class="reference internal" href="#anatomical-roi-pipeline">Anatomical ROI Pipeline</a><ul>
<li><a class="reference internal" href="#import-modules">Import modules</a></li>
<li><a class="reference internal" href="#define-experiment-specific-parameters">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#define-aroi-specific-parameters">Define aROI specific parameters</a></li>
<li><a class="reference internal" href="#define-of-nodes">Define of Nodes</a></li>
<li><a class="reference internal" href="#definition-of-anatomical-roi-workflow">Definition of anatomical ROI workflow</a></li>
<li><a class="reference internal" href="#run-pipeline-and-generate-graph">Run pipeline and generate graph</a></li>
<li><a class="reference internal" href="#summarizing-the-output-in-a-cvs-file">Summarizing the output in a cvs-file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#functional-roi-pipeline">Functional ROI Pipeline</a><ul>
<li><a class="reference internal" href="#id2">Import modules</a></li>
<li><a class="reference internal" href="#id3">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#define-froi-specific-parameters">Define fROI specific parameters</a></li>
<li><a class="reference internal" href="#definition-of-nodes">Definition of Nodes</a></li>
<li><a class="reference internal" href="#definition-of-functional-roi-workflow">Definition of functional ROI workflow</a></li>
<li><a class="reference internal" href="#run-the-pipeline-and-generate-the-graph">Run the pipeline and generate the graph</a></li>
<li><a class="reference internal" href="#id4">Summarizing the output in a cvs-file</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/regionOfInterest.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-extract-region-of-interest-roi">
<h1>How to extract region of interest (ROI)<a class="headerlink" href="#how-to-extract-region-of-interest-roi" title="Permalink to this headline">¶</a></h1>
<p>In this part we will learn how to extract statistical data from a strictly specified region or in other words our <strong>region of interest (ROI)</strong>.</p>
<div class="section" id="anatomical-vs-functional-roi">
<h2>Anatomical vs. Functional ROI<a class="headerlink" href="#anatomical-vs-functional-roi" title="Permalink to this headline">¶</a></h2>
<p>We will learn how to extract anatomical and functional ROIs, two ways of extraction which differ mostly by the definition of the ROI-region.</p>
<div class="section" id="anatomical-roi">
<h3>Anatomical ROI<a class="headerlink" href="#anatomical-roi" title="Permalink to this headline">¶</a></h3>
<p>The region of anatomical ROIs is as the name implies defined by the anatomical structure of the brain. Such definition of anatomical regions and there segmentation is often stored in so called atlas. A well know atlas which is used by <strong>Nipype</strong> as default is the <strong>FreeSurfer Color Table</strong>, which can be found <a class="reference external" href="http://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT">here</a>.</p>
<p>This color table subdivides the brain in different anatomical regions. With the FreeSurfer Color Table you can differentiate between gray matter and white matter areas, between a general specification that divides the brain into +30 regions (the <strong>2005</strong> region specification) or a more detailed specification category that divides the brain into +200 regions (the <strong>2009</strong> region specification)</p>
<p><strong>Visualization of 2005 Segmentation</strong></p>
<img alt="_images/2005segmentation.png" src="_images/2005segmentation.png" style="width: 200px;" />
<p><strong>Visualization of 2009 Segmentation</strong></p>
<img alt="_images/2009segmentation.png" src="_images/2009segmentation.png" style="width: 200px;" />
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">If you want to explore those regions by ourself I recommend to open a <strong>FreeSurfer</strong> capable viewing tool and overlay the <tt class="docutils literal"><span class="pre">fsaverage</span></tt> file with an annotation-file. More information how this is done can be found here: <strong>MISSING_LINK</strong></p>
</div>
</div>
<div class="section" id="functional-roi">
<h3>Functional ROI<a class="headerlink" href="#functional-roi" title="Permalink to this headline">¶</a></h3>
<p>The region of functional ROIs is solely defined by what point in &#8220;brain&#8221;-space you are interested in. You&#8217;re region of interest is most likely where there is a peak or interesting activation in your functional data, hence its name. The specification of the region can be done in different ways. Some may want to look at a cubic region with the point of interest as its center. Others want to extract a spherical region around a point of interest. And this is exactly what we will be doing in this script.</p>
<p><strong>Visualization of a functional ROI</strong></p>
<p>Here you can see a spherical region with radius 3 voxel around the point [a,b,c] in xxxxx-space.</p>
<img alt="_images/functionalROI.png" src="_images/functionalROI.png" style="width: 200px;" />
</div>
</div>
<div class="section" id="anatomical-roi-pipeline">
<h2>Anatomical ROI Pipeline<a class="headerlink" href="#anatomical-roi-pipeline" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s now begin with the creation of an <strong>anatomical ROI pipeline</strong>.</p>
<div class="section" id="import-modules">
<h3>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>                                    <span class="c"># system functions</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.freesurfer</span> <span class="kn">as</span> <span class="nn">fs</span>    <span class="c"># freesurfer</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">as</span> <span class="nn">nio</span>           <span class="c"># i/o routines</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">as</span> <span class="nn">util</span>     <span class="c"># utility</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">as</span> <span class="nn">pe</span>          <span class="c"># pypeline engine</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-experiment-specific-parameters">
<h3>Define experiment specific parameters<a class="headerlink" href="#define-experiment-specific-parameters" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#to better access the parent folder of the experiment</span>
<span class="n">experiment_dir</span> <span class="o">=</span> <span class="s">&#39;~SOMEPATH/experiment&#39;</span>

<span class="c">###   # Tell freesurfer what subjects directory to use</span>
<span class="c">###   subjects_dir = experiment_dir + &#39;/freesurfer_data&#39;</span>
<span class="c">###   fs.FSCommand.set_default_subjects_dir(subjects_dir)</span>

<span class="c">#dirnames for anatomical ROI pipeline</span>
<span class="n">aROIWorkingdir</span> <span class="o">=</span> <span class="s">&#39;/result/aROI_workingdir&#39;</span> <span class="c">#location and name of workingdir</span>
<span class="n">aROIOutput</span> <span class="o">=</span> <span class="s">&#39;result/aROI_Output&#39;</span>         <span class="c">#location and name of aROI datasink</span>
<span class="n">l1contrastDir</span> <span class="o">=</span> <span class="s">&#39;level1_output&#39;</span>            <span class="c">#name of first level datasink</span>

<span class="c">#list of subjectnames</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;subject1&#39;</span><span class="p">,</span> <span class="s">&#39;subject2&#39;</span><span class="p">,</span> <span class="s">&#39;subject3&#39;</span><span class="p">]</span>

<span class="c">#list of contrastnumbers the pipeline should consider</span>
<span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;01&#39;</span><span class="p">,</span><span class="s">&#39;02&#39;</span><span class="p">,</span><span class="s">&#39;03&#39;</span><span class="p">,</span><span class="s">&#39;04&#39;</span><span class="p">,</span><span class="s">&#39;05&#39;</span><span class="p">]</span>

<span class="c">###   #name of the first session from the first level pipeline</span>
<span class="c">###   nameOfFirstSession = &#39;func1&#39;</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The name of the first session is necessary, because the bbregister file from the first level pipeline contains the name of the first session in its name. E.g. if the first condition is named <tt class="docutils literal"><span class="pre">func1</span></tt>, than the name of the bbregister file for the first subject would be: <tt class="docutils literal"><span class="pre">meanafunc1_bbreg_subject1.dat')</span></tt></p>
</div>
</div>
<div class="section" id="define-aroi-specific-parameters">
<h3>Define aROI specific parameters<a class="headerlink" href="#define-aroi-specific-parameters" title="Permalink to this headline">¶</a></h3>
<p>As mentioned above we are using the FreeSurfer Color Table to define the anatomical regions. This table can be found <a class="reference external" href="http://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT">here</a>. Let&#8217;s assume that we want to extract the following regions:</p>
<ul class="simple">
<li>id: 1001 ; region xxxxxx ; from coding part 2005</li>
<li>id: 2001 ; region xxxxxx ; from coding part 2005</li>
<li>id: 1030 ; region xxxxxx ; from coding part 2005</li>
<li>id: 2030 ; region xxxxxx ; from coding part 2005</li>
<li>id: 11 ; region xxxxxx ; from coding part 2009</li>
<li>id: 50 ; region xxxxxx ; from coding part 2009</li>
<li>id: 12 ; region xxxxxx ; from coding part 2009</li>
<li>id: 51 ; region xxxxxx ; from coding part 2009</li>
<li>id: 11104 ; region xxxxxx ; from coding part 2009</li>
<li>id: 12104 ; region xxxxxx ; from coding part 2009</li>
</ul>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Specification of the regions from the 2005 and 2009 part of the FreeSurfer Color Table</span>
<span class="n">ROIregions2005</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;1001&#39;</span><span class="p">,</span><span class="s">&#39;2001&#39;</span><span class="p">,</span><span class="s">&#39;1030&#39;</span><span class="p">,</span><span class="s">&#39;2030&#39;</span><span class="p">]</span>
<span class="n">ROIregions2009</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;11&#39;</span><span class="p">,</span><span class="s">&#39;50&#39;</span><span class="p">,</span><span class="s">&#39;12&#39;</span><span class="p">,</span><span class="s">&#39;51&#39;</span><span class="p">,</span><span class="s">&#39;11104&#39;</span><span class="p">,</span><span class="s">&#39;12104&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-of-nodes">
<h3>Define of Nodes<a class="headerlink" href="#define-of-nodes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: IdentityInterface - to iterate over subjects and contrasts</span>
<span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">]),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">&#39;inputnode&#39;</span><span class="p">)</span>
<span class="n">inputnode</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjects</span><span class="p">),</span>
                       <span class="p">(</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">)]</span>
</pre></div>
</td></tr></table></div>
<p>As always, it is important to be aware about the structure and the names of the data we want to grab. In this case we want to grab the subject specific contrasts and bbregister file from the first level pipeline. For example the second contrast for the third subject can be found at: <tt class="docutils literal"><span class="pre">'~SOMEPATH/experiment/result/level1_output/vol_contrast/_subject_id_subject3/con0002.img'</span></tt> and the bbregister file for the first subject can be found at: <tt class="docutils literal"><span class="pre">'~SOMEPATH/experiment/result/level1_output/bbregister/_subject_id_subject1/meanafunc1_bbreg_subject1.dat'</span></tt>
Knowing this, we can build our <tt class="docutils literal"><span class="pre">datagrabber</span></tt> node as follows:</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: DataGrabber - to grab the input data</span>
<span class="n">datasource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">],</span>
                                               <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;contrast&#39;</span><span class="p">,</span><span class="s">&#39;bb_id&#39;</span><span class="p">]),</span>
                     <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;datasource&#39;</span><span class="p">)</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;result/&#39;</span> <span class="o">+</span> <span class="n">l1contrastDir</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s">&#39;/</span><span class="si">%s</span><span class="s">/_subject_id_</span><span class="si">%s</span><span class="s">/</span><span class="si">%s%s%s</span><span class="s">&#39;</span>

<span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">contrast</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;vol_contrasts&#39;</span><span class="p">,</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;con_00&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span><span class="s">&#39;.img&#39;</span><span class="p">]],</span>
            <span class="n">bb_id</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;bbregister&#39;</span><span class="p">,</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;meana&#39;</span><span class="o">+</span><span class="n">nameOfFirstSession</span><span class="o">+</span><span class="s">&#39;_bbreg_&#39;</span><span class="p">,</span>
                      <span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;.dat&#39;</span><span class="p">]])</span>

<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="n">info</span>
</pre></div>
</td></tr></table></div>
<p>Let&#8217;s now continue with the implementation of the other nodes we need for our <strong>anatomical ROI pipeline</strong>.</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: FreeSurferSource - to grab FreeSurfer files from the recon-all process</span>
<span class="n">fssource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">FreeSurferSource</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fssource&#39;</span><span class="p">)</span>
<span class="n">fssource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">subjects_dir</span>

<span class="c">#Node: MRIConvert - to convert files from FreeSurfer format into nifti format</span>
<span class="n">MRIconversion</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">MRIConvert</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;MRIconversion&#39;</span><span class="p">)</span>
<span class="n">MRIconversion</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_type</span> <span class="o">=</span> <span class="s">&#39;nii&#39;</span>

<span class="c">#Node: ApplyVolTransform - to transform contrasts into anatomical space</span>
<span class="c">#                          creates &#39;con_*.anat.bb.mgh&#39; files</span>
<span class="n">transformation</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">ApplyVolTransform</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;transformation&#39;</span><span class="p">)</span>
<span class="n">transformation</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fs_target</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">transformation</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s">&#39;nearest&#39;</span>
</pre></div>
</td></tr></table></div>
<p>As you know we want to extract some regions from the 2005 and some from the 2009 segmentation classification. But if you
look at the mandatory inputs of the <tt class="docutils literal"><span class="pre">SegStats</span></tt> node you will see that we have to specify a value for <tt class="docutils literal"><span class="pre">segment_id</span></tt>
and one for <tt class="docutils literal"><span class="pre">segmentation_file</span></tt>. Because we specified the list of segmentation ids separately for the 2005 and 2009 part, we have to specify
two</p>
<p>###möglich wäre es natürlich auch iteration zu machen
wieso mach ich überhauüt separation???
chönt mer ned alles grad i 1 liste inetue?</p>
<p>segment_id
aparc_aseg
segmentation_file =  segmentation volume path</p>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: SegStats2005 - to extract specified regions from the 2005 part of the color table</span>
<span class="n">segmentation2005</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">SegStats</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;segmentation2005&#39;</span><span class="p">)</span>
<span class="n">segmentation2005</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">color_table_file</span> <span class="o">=</span> <span class="s">&#39;/software/Freesurfer/5.1.0/FreeSurferColorLUT.txt&#39;</span>
<span class="n">segmentation2005</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">segment_id</span> <span class="o">=</span> <span class="n">ROIregions2005</span> <span class="c">#2005 segmentation ids</span>

<span class="c">#Node: SegStats2009 - to extract specified regions from the 2009 part of the color table</span>
<span class="n">segmentation2009</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">SegStats</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;segmentation2009&#39;</span><span class="p">)</span>
<span class="n">segmentation2009</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">color_table_file</span> <span class="o">=</span> <span class="s">&#39;/software/Freesurfer/5.1.0/FreeSurferColorLUT.txt&#39;</span>
<span class="n">segmentation2009</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">segment_id</span> <span class="o">=</span> <span class="n">ROIregions2009</span> <span class="c">#2009 segmentation ids</span>

<span class="k">def</span> <span class="nf">getVersion</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">in_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">in_file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you don&#8217;t define a list of segmentation ids (input: <tt class="docutils literal"><span class="pre">segment_id</span></tt>) the pipeline would just extract all possible regions. This is not bad but would just take a while.</p>
</div>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: Datasink - Creates a datasink node to store important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;datasink&quot;</span><span class="p">)</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">aROIOutput</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="definition-of-anatomical-roi-workflow">
<h3>Definition of anatomical ROI workflow<a class="headerlink" href="#definition-of-anatomical-roi-workflow" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Initiation of the ROI extraction workflow</span>
<span class="n">aROIflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;aROIflow&#39;</span><span class="p">)</span>
<span class="n">aROIflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="n">aROIWorkingdir</span>

<span class="c">#Connect up all components</span>
<span class="n">aROIflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">),</span>
                                          <span class="p">(</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span> <span class="s">&#39;contrast_id&#39;</span><span class="p">),</span>
                                          <span class="p">]),</span>
                  <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">fssource</span><span class="p">,[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">fssource</span><span class="p">,</span> <span class="n">segmentation2005</span><span class="p">,[((</span><span class="s">&#39;aparc_aseg&#39;</span><span class="p">,</span><span class="n">getVersion</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#39;segmentation_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">fssource</span><span class="p">,</span> <span class="n">segmentation2009</span><span class="p">,[((</span><span class="s">&#39;aparc_aseg&#39;</span><span class="p">,</span><span class="n">getVersion</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s">&#39;segmentation_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">MRIconversion</span><span class="p">,[(</span><span class="s">&#39;contrast&#39;</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">MRIconversion</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,[(</span><span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="s">&#39;source_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,[(</span><span class="s">&#39;bb_id&#39;</span><span class="p">,</span> <span class="s">&#39;reg_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">transformation</span><span class="p">,</span> <span class="n">segmentation2005</span><span class="p">,[(</span><span class="s">&#39;transformed_file&#39;</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">transformation</span><span class="p">,</span> <span class="n">segmentation2009</span><span class="p">,[(</span><span class="s">&#39;transformed_file&#39;</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">segmentation2005</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,[(</span><span class="s">&#39;summary_file&#39;</span><span class="p">,</span> <span class="s">&#39;segstat&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">segmentation2009</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,[(</span><span class="s">&#39;summary_file&#39;</span><span class="p">,</span> <span class="s">&#39;segstat2009&#39;</span><span class="p">)]),</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="run-pipeline-and-generate-graph">
<h3>Run pipeline and generate graph<a class="headerlink" href="#run-pipeline-and-generate-graph" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">aROIflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s">&#39;flat&#39;</span><span class="p">)</span>
<span class="n">aROIflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;n_procs&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p><strong>Visualization of anatomical ROI pipeline</strong></p>
<img alt="_images/aROIgraph.png" src="_images/aROIgraph.png" style="width: 200px;" />
</div>
<div class="section" id="summarizing-the-output-in-a-cvs-file">
<h3>Summarizing the output in a cvs-file<a class="headerlink" href="#summarizing-the-output-in-a-cvs-file" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">for</span> <span class="n">contrast</span> <span class="ow">in</span> <span class="n">contrasts</span><span class="p">:</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15000</span><span class="p">):</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;LABEL&#39;</span><span class="p">])</span>

    <span class="n">subjectNumber</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>

        <span class="c">#Find the location of the two output files</span>
        <span class="n">statsFile</span> <span class="o">=</span> <span class="n">experiment_dir</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">aROIOutput</span> <span class="o">+</span><span class="s">&#39;/segstat/_contrast_id_&#39;</span><span class="o">+</span><span class="n">contrast</span><span class="o">+</span><span class="s">&#39;/_subject_id_&#39;</span><span class="o">+</span><span class="n">subject</span><span class="o">+</span><span class="s">&#39;/summary.stats&#39;</span>
        <span class="n">statsFile2009</span> <span class="o">=</span> <span class="n">experiment_dir</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">aROIOutput</span> <span class="o">+</span><span class="s">&#39;/segstat2009/_contrast_id_&#39;</span><span class="o">+</span><span class="n">contrast</span><span class="o">+</span><span class="s">&#39;/_subject_id_&#39;</span><span class="o">+</span><span class="n">subject</span><span class="o">+</span><span class="s">&#39;/summary.stats&#39;</span>

        <span class="c">#Get the data from the two output files</span>
        <span class="n">dataFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">statsFile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dataFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">dataFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">dataFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">statsFile2009</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">data2009</span> <span class="o">=</span> <span class="n">dataFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">dataFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c">#to check where the data starts</span>
        <span class="k">def</span> <span class="nf">findStartOfData</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">datafile</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">line</span>

        <span class="n">tempresult</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">findStartOfData</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">tempresult</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="nb">float</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">5</span><span class="p">])])</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data2009</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">findStartOfData</span><span class="p">(</span><span class="n">data2009</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">data2009</span><span class="p">[</span><span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">tempresult</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="nb">float</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">5</span><span class="p">])])</span>

        <span class="n">tempresult</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tempresult</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tempresult</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">==</span> <span class="n">tempresult</span><span class="p">[</span><span class="n">line</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempresult</span><span class="p">[</span><span class="n">line</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;LABEL&#39;</span><span class="p">:</span>
               <span class="n">output</span><span class="p">[</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">output</span><span class="p">[</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ROI</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">subjectNumber</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span>
               <span class="n">ROI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">subjectNumber</span> <span class="o">+=</span> <span class="mi">1</span>


    <span class="n">output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,[</span><span class="s">&#39;SegId&#39;</span><span class="p">,</span><span class="s">&#39;StructName&#39;</span><span class="p">])</span>
    <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">ROI</span> <span class="k">for</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">if</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;LABEL&#39;</span><span class="p">]</span>


    <span class="kn">import</span> <span class="nn">csv</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">aROIOutput</span> <span class="o">+</span><span class="s">&#39;/ROI_&#39;</span><span class="o">+</span><span class="n">contrast</span><span class="o">+</span><span class="s">&#39;_result.csv&#39;</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">outputFile</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">outputFile</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The code for this anatomical ROI pipeline can be found here: <a class="reference external" href="http://github.com/miykael/nipype-beginner-s-guide/blob/master/aROIpipeline.py.py">aROIpipeline.py</a></p>
</div>
</div>
</div>
<div class="section" id="functional-roi-pipeline">
<h2>Functional ROI Pipeline<a class="headerlink" href="#functional-roi-pipeline" title="Permalink to this headline">¶</a></h2>
<p>As said before, the most important difference to the extraction of an antomical ROI is that the region of interest isn&#8217;t predifined by some atlas.
We define the region we are interested in solely by a point in &#8220;brain&#8221;-space and by a the radius of a sphere around this point. The procedure to this is quite simple:</p>
<ol class="arabic simple">
<li>define a point of interest and create a sphere around it</li>
<li>overlay this sphere on to a subject</li>
<li>extract the data from this sphere</li>
</ol>
<p>Our <strong>functional ROI pipeline</strong> does almost exactly this. The only difference is that we have to divide the first step into some smaller substeps:
a. Take a subject specific contrast, multiply all voxels by 0 and add the value 1 to each. This leads  to a contrast file where all voxels have the value 1
b. Define a cubic area around your point of interest (this is done by defining a corner of the cube and the length of its sides)
c. Take this cubic region in &#8220;brain&#8221;-space where all voxel in the cube have values 1 and all outside this region have the value 0 and smooth this cube to a sphere</p>
<p>A visualization of those steps would look like this:</p>
<p><strong>Step A</strong></p>
<img alt="_images/fROIsubstepA.png" src="_images/fROIsubstepA.png" style="width: 200px;" />
<p><strong>Step B</strong></p>
<img alt="_images/fROIsubstepB.png" src="_images/fROIsubstepB.png" style="width: 200px;" />
<p><strong>Step C</strong></p>
<img alt="_images/fROIsubstepC.png" src="_images/fROIsubstepC.png" style="width: 200px;" />
<p>Let&#8217;s now begin with the creation of a <strong>functional ROI pipeline</strong>.</p>
<div class="section" id="id2">
<h3>Import modules<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>                                    <span class="c"># system functions</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.freesurfer</span> <span class="kn">as</span> <span class="nn">fs</span>    <span class="c"># freesurfer</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">as</span> <span class="nn">nio</span>           <span class="c"># i/o routines</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">as</span> <span class="nn">util</span>     <span class="c"># utility</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">as</span> <span class="nn">pe</span>          <span class="c"># pypeline engine</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.fsl</span> <span class="kn">as</span> <span class="nn">fsl</span>          <span class="c"># fsl module</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id3">
<h3>Define experiment specific parameters<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#to better access the parent folder of the experiment</span>
<span class="n">experiment_dir</span> <span class="o">=</span> <span class="s">&#39;~SOMEPATH/experiment&#39;</span>

<span class="c">#dirnames for functional ROI pipeline</span>
<span class="n">fROIWorkingdir</span> <span class="o">=</span> <span class="s">&#39;/result/fROI_workingdir&#39;</span> <span class="c">#location and name of workingdir</span>
<span class="n">fROIOutput</span> <span class="o">=</span> <span class="s">&#39;result/fROI_Output&#39;</span>          <span class="c">#location and name of fROI datasink</span>

<span class="c">#list of subjectnames</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;subject1&#39;</span><span class="p">,</span> <span class="s">&#39;subject2&#39;</span><span class="p">,</span> <span class="s">&#39;subject3&#39;</span><span class="p">]</span>

<span class="c">#list of contrastnumbers the pipeline should consider</span>
<span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;01&#39;</span><span class="p">,</span><span class="s">&#39;02&#39;</span><span class="p">,</span><span class="s">&#39;03&#39;</span><span class="p">,</span><span class="s">&#39;04&#39;</span><span class="p">,</span><span class="s">&#39;05&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-froi-specific-parameters">
<h3>Define fROI specific parameters<a class="headerlink" href="#define-froi-specific-parameters" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#define the coordination of point of interest</span>
<span class="n">centerOfROI</span> <span class="o">=</span> <span class="p">[</span><span class="mi">183</span><span class="p">,</span><span class="mi">134</span><span class="p">,</span><span class="mi">136</span><span class="p">]</span>

<span class="c">#define the diameter of the sphere of interest</span>
<span class="n">diameter</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c">#calculates the beginning corner of the cubic ROI</span>
<span class="n">corner</span> <span class="o">=</span> <span class="p">[</span><span class="n">centerOfROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">diameter</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
          <span class="n">centerOfROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">diameter</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
          <span class="n">centerOfROI</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">diameter</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="definition-of-nodes">
<h3>Definition of Nodes<a class="headerlink" href="#definition-of-nodes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Node: IdentityInterface - to iterate over subjects and contrasts</span>
<span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">]),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">&#39;inputnode&#39;</span><span class="p">)</span>
<span class="n">inputnode</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjects</span><span class="p">),</span>
                       <span class="p">(</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">)]</span>


<span class="c">#Node: DataGrabber - To grab the input data</span>
<span class="n">datasource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">],</span>
                                               <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;contrast&#39;</span><span class="p">]),</span>
                     <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;datasource&#39;</span><span class="p">)</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;result/&#39;</span> <span class="o">+</span> <span class="n">l1contrastDir</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s">&#39;/</span><span class="si">%s</span><span class="s">/normcons/con_</span><span class="si">%04d</span><span class="s">_ants.nii&#39;</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">contrast</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;contrast_id&#39;</span><span class="p">]])</span>

<span class="c">#Node: ImageMaths - to create the cubic ROI with value 1</span>
<span class="n">cubemask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cubemask&quot;</span><span class="p">)</span>
<span class="n">cubemask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s">&#39;-mul 0 -add 1 -roi </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> 0 1&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">diameter</span><span class="p">,</span><span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">diameter</span><span class="p">,</span><span class="n">corner</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">diameter</span><span class="p">)</span>
<span class="n">cubemask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_data_type</span> <span class="o">=</span> <span class="s">&#39;float&#39;</span>
<span class="n">cubemask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">&#39;/mindhive/gablab/u/mnotter/att_sens/asens_normbrains_diff/</span><span class="si">%s</span><span class="s">/normcons/con_</span><span class="si">%04d</span><span class="s">_ants.nii&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">contrasts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c">#Node: ImageMaths - to smooth the cubic ROI to a sphere</span>
<span class="n">spheremask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;spheremask&quot;</span><span class="p">)</span>
<span class="n">spheremask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s">&#39;-kernel sphere </span><span class="si">%d</span><span class="s"> -fmean -thr 0.0000010000 -bin&#39;</span><span class="o">%</span><span class="n">diameter</span>
<span class="n">spheremask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_data_type</span> <span class="o">=</span> <span class="s">&#39;float&#39;</span>

<span class="c">#Node: SegStats - to extract the statistic from a given segmentation</span>
<span class="n">segstat</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">SegStats</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;segstat&#39;</span><span class="p">)</span>

<span class="c">#Node: Datasink - Create a datasink node to store important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;datasink&quot;</span><span class="p">)</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">fROIOutput</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are interested in what command actually will be executed by the <tt class="docutils literal"><span class="pre">cubemask</span></tt> node you just simply can execute <tt class="docutils literal"><span class="pre">cubemask.cmdline</span></tt>. In this example this will give you the following output: <tt class="docutils literal"><span class="pre">blablabla</span></tt></p>
</div>
</div>
<div class="section" id="definition-of-functional-roi-workflow">
<h3>Definition of functional ROI workflow<a class="headerlink" href="#definition-of-functional-roi-workflow" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#Initiation of the fROI extraction workflow</span>
<span class="n">fROIflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fROIflow&#39;</span><span class="p">)</span>
<span class="n">fROIflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="n">fROIWorkingdir</span>

<span class="c">#Connect up all components</span>
<span class="n">fROIflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">cubemask</span><span class="p">,</span> <span class="n">spheremask</span><span class="p">,[(</span><span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">infosource1</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">infosource2</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,[(</span><span class="s">&#39;contrast_id&#39;</span><span class="p">,</span> <span class="s">&#39;contrast_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">spheremask</span><span class="p">,</span> <span class="n">segstat</span><span class="p">,[(</span><span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="s">&#39;segmentation_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">segstat</span><span class="p">,[(</span><span class="s">&#39;contrast&#39;</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">segstat</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,[(</span><span class="s">&#39;summary_file&#39;</span><span class="p">,</span> <span class="s">&#39;@statistic&#39;</span><span class="p">)]),</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="run-the-pipeline-and-generate-the-graph">
<h3>Run the pipeline and generate the graph<a class="headerlink" href="#run-the-pipeline-and-generate-the-graph" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">fROIflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s">&#39;flat&#39;</span><span class="p">)</span>
<span class="n">fROIflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;n_procs&#39;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id4">
<h3>Summarizing the output in a cvs-file<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&#39;coordinations:&#39;</span><span class="p">,</span><span class="n">centerOfROI</span><span class="p">,</span><span class="s">&#39;diameter:&#39;</span><span class="p">,</span><span class="n">diameter</span><span class="p">])</span>

<span class="k">for</span> <span class="n">contrast</span> <span class="ow">in</span> <span class="n">contrasts</span><span class="p">:</span>
    <span class="n">contrast</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">contrast</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&#39;contrast:&#39;</span><span class="p">,</span><span class="n">contrast</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>

        <span class="n">statFile</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">fROIOutput</span> <span class="o">+</span> <span class="s">&#39;/_contrast_id_&#39;</span><span class="o">+</span><span class="n">contrast</span><span class="o">+</span><span class="s">&#39;/_subject_id_&#39;</span><span class="o">+</span><span class="n">subject</span><span class="o">+</span><span class="s">&#39;/summary.stats&#39;</span>

        <span class="c">#Get the data from the output file</span>
        <span class="n">dataFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">statFile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dataFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">dataFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">subject</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">49</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">]])</span>

    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fROIOutput</span><span class="o">+</span><span class="s">&#39;/fROI_spherical&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">centerOfROI</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;_</span><span class="si">%s</span><span class="s">_result.csv&#39;</span><span class="o">%</span><span class="n">diameter</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">outputFile</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">outputFile</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The code for this functional ROI pipeline can be found here: <a class="reference external" href="http://github.com/miykael/nipype-beginner-s-guide/blob/master/fROIpipeline.py.py">fROIpipeline.py</a></p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.3 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Michael Notter.
      Last updated on August 10, 2011.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
</div>

  </body>
</html>