

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nipype Beginner&#39;s Guide &mdash; Beginner&#39;s Guide to Nipype v0.4 v0.2 documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Beginner&#39;s Guide to Nipype v0.4 v0.2 documentation" href="index.html" />
    <link rel="next" title="Under construction" href="underConstruction.html" />
    <link rel="prev" title="Prepare Data for Nipype" href="preparedata.html" /> 
  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="index.html">
  <img src="_static/nipype-beginners-guide-banner-bg.png" alt="NIPY logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="underConstruction.html" title="Under construction"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="preparedata.html" title="Prepare Data for Nipype"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Example of a first level analysis pipeline</a><ul>
<li><a class="reference internal" href="#define-structure-of-your-pipeline">Define structure of your pipeline</a></li>
<li><a class="reference internal" href="#write-your-pipeline-script">Write your pipeline script</a><ul>
<li><a class="reference internal" href="#import-modules">Import modules</a></li>
<li><a class="reference internal" href="#define-experiment-specific-parameters">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#define-a-pipeline-for-the-preprocess">Define a pipeline for the preprocess</a></li>
<li><a class="reference internal" href="#define-a-pipeline-for-the-volume-analysis">Define a pipeline for the volume analysis</a></li>
<li><a class="reference internal" href="#define-a-framework-workflow-that-contains-the-preprocess-and-the-volume-analysis">Define a framework workflow that contains the preprocess and the volume analysis</a></li>
<li><a class="reference internal" href="#define-infosource-datagrabber-and-datasink">Define infosource, datagrabber and datasink</a></li>
<li><a class="reference internal" href="#define-contrasts-and-model-specification">Define contrasts and model specification</a></li>
<li><a class="reference internal" href="#define-the-meta-pipeline">Define the meta pipeline</a></li>
<li><a class="reference internal" href="#run-the-pipeline-and-generate-the-graph">Run the pipeline and generate the graph</a></li>
</ul>
</li>
<li><a class="reference internal" href="#visualization-of-the-metaflow">Visualization of the metaflow</a><ul>
<li><a class="reference internal" href="#basic-graph">Basic graph</a></li>
<li><a class="reference internal" href="#detailed-graph">Detailed graph</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="preparedata.html"
                        title="previous chapter">Prepare Data for Nipype</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="underConstruction.html"
                        title="next chapter">Under construction</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/firstLevelExample.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="example-of-a-first-level-analysis-pipeline">
<h1>Example of a first level analysis pipeline<a class="headerlink" href="#example-of-a-first-level-analysis-pipeline" title="Permalink to this headline">¶</a></h1>
<p>This is an example of a simple first level analysis pipeline. This pipeline takes the raw nifti data, does some preprocessing (e.g. realignment and smoothing) which is followed by the estimation of the concrete model.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The normalization of the results to a common template will not be coverd by this chapter. A brief instruction on how to normalize your date with ANTS will be given in a latter chapter.</p>
</div>
<div class="section" id="define-structure-of-your-pipeline">
<h2>Define structure of your pipeline<a class="headerlink" href="#define-structure-of-your-pipeline" title="Permalink to this headline">¶</a></h2>
<p>The best way to build your own pipeline is first to think about the workflow the data should go through. In this example we want to first run some preprocessing like <cite>SliceTiming</cite>, <cite>Realignment</cite>, <cite>ArtifactDetection</cite>, <cite>BBRegister</cite> and <cite>Smoothing</cite>. Additionally we also want to take the subject specific aseg file from the freesurfer folder, binarize it and dialte it to create a mask for the level1desing. All this will be accommodate in a <strong>preprocess pipeline</strong>. After that we want to estimate a concrete model by running first <cite>SpecifyModel</cite>, create a <cite>Level1Design</cite>, <cite>EstimateModel</cite> and finally <cite>EstimateContrast</cite>. This will be done in a <strong>volume analysis pipeline</strong>.</p>
<p>The preprocess and the volume analysis pipeline together with the inputnode, will create the basic <strong>framework workflow</strong>. And this framework workflow will be connected to the infosource, the datagrabber and the datasink by a higher workflow, I&#8217;d like to call <strong>meta workflow</strong>. Visualized this pipeline would look like the following:</p>
<img alt="_images/metaworkflow.png" class="align-center" src="_images/metaworkflow.png" style="width: 1080px;" />
<p>The connections between the nodes will make more sense once we look at the inputs a given node needs. Some may also ask why we haven&#8217;t included the infosource, datagrabber and datasink nodes into the frameflow? The reason is that those nodes dependent highly on the paradigma specific parameters and will change for every model/experiment. That&#8217;s why we want to separat them from the framework workflow which will stay more or less the same for similar experiments. This does also give us the opportunity to just import this framework workflow into a new pipeline script.</p>
</div>
<div class="section" id="write-your-pipeline-script">
<h2>Write your pipeline script<a class="headerlink" href="#write-your-pipeline-script" title="Permalink to this headline">¶</a></h2>
<p>Now that we have defined how the structure of our pipeline and the connections between them should be we can start with writing the pipeline script.</p>
<div class="section" id="import-modules">
<h3>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this headline">¶</a></h3>
<p>First we have to import all necessary modules.</p>
<div class="highlight-py"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>                                    <span class="c"># system functions</span>
<span class="kn">import</span> <span class="nn">nipype.algorithms.modelgen</span> <span class="kn">as</span> <span class="nn">model</span>   <span class="c"># model generation</span>
<span class="kn">import</span> <span class="nn">nipype.algorithms.rapidart</span> <span class="kn">as</span> <span class="nn">ra</span>      <span class="c"># artifact detection</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.freesurfer</span> <span class="kn">as</span> <span class="nn">fs</span>    <span class="c"># freesurfer</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">as</span> <span class="nn">nio</span>           <span class="c"># i/o routines</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.spm</span> <span class="kn">as</span> <span class="nn">spm</span>          <span class="c"># spm</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">as</span> <span class="nn">util</span>     <span class="c"># utility</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">as</span> <span class="nn">pe</span>          <span class="c"># pypeline engine</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">as</span> <span class="nn">base</span>        <span class="c"># base routines</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.fsl.maths</span> <span class="kn">as</span> <span class="nn">math</span>   <span class="c">#for dilating of the mask</span>
</pre></div>
</div>
</div>
<div class="section" id="define-experiment-specific-parameters">
<h3>Define experiment specific parameters<a class="headerlink" href="#define-experiment-specific-parameters" title="Permalink to this headline">¶</a></h3>
<p>I suggest to keep things that change often between versions, models, experiments like subject names, output folders and name of functional runs at one place so that they can be accessed more easily in case you want to change them.</p>
<div class="highlight-py"><div class="highlight"><pre><span class="c">#To better access the parent folder of the experiment</span>
<span class="n">experiment_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

<span class="c">#name of the subjects, functional fiels and output folders</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;subject1&#39;</span><span class="p">,</span><span class="s">&#39;subject2&#39;</span><span class="p">,</span><span class="s">&#39;subject3&#39;</span><span class="p">]</span>
<span class="n">sessions</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;func1&#39;</span><span class="p">,</span><span class="s">&#39;func2&#39;</span><span class="p">]</span>
<span class="n">nameOflevel1Out</span> <span class="o">=</span> <span class="s">&#39;results/level1_output&#39;</span>
<span class="n">nameOfWorkingdir</span> <span class="o">=</span> <span class="s">&#39;/results/workingdir&#39;</span>

<span class="c"># Tell freesurfer what subjects directory to use</span>
<span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="s">&#39;/freesurfer_data&#39;</span>
<span class="n">fs</span><span class="o">.</span><span class="n">FSCommand</span><span class="o">.</span><span class="n">set_default_subjects_dir</span><span class="p">(</span><span class="n">subjects_dir</span><span class="p">)</span>
</pre></div>
</div>
<p>Those specification mean that the name of the subjectfolders are &#8220;subject1&#8221;, &#8220;subject2&#8221; and &#8220;subject3&#8221; and that each of those folders contain a &#8220;func1.nii&#8221; and &#8220;func2.nii&#8221; file which represents the nifti files for the first and the second functional run. But the exact structure will be defined with the datagrabber node.</p>
</div>
<div class="section" id="define-a-pipeline-for-the-preprocess">
<h3>Define a pipeline for the preprocess<a class="headerlink" href="#define-a-pipeline-for-the-preprocess" title="Permalink to this headline">¶</a></h3>
<p>We first define the preprocess pipeline with a node for slicetiming, realingment, artifaction detection, bbregister and smoothing.</p>
<div class="highlight-py"><div class="highlight"><pre><span class="c">#Initiation of the preprocess workflow</span>
<span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;preproc&#39;</span><span class="p">)</span>

<span class="c">#Node: Slicetiming</span>
<span class="n">sliceTiming</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">SliceTiming</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;sliceTiming&quot;</span><span class="p">)</span>
<span class="n">sliceTiming</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="mi">28</span>
<span class="n">sliceTiming</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">time_repetition</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">sliceTiming</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">time_acquisition</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">/</span><span class="mi">28</span>
<span class="n">sliceTiming</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>      <span class="c">#for bottom up slicing</span>
<span class="c">#sliceTiming.inputs.slice_order = range(28,0,-1)    #for top down slicing</span>
<span class="n">sliceTiming</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c">#Node: Realign - for motion correction and to register all images to the mean image</span>
<span class="n">realign</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">Realign</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;realign&quot;</span><span class="p">)</span>
<span class="n">realign</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">register_to_mean</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c">#Node: Artifact Detection - to determine which of the images in the functional</span>
<span class="c">#      series are outliers based on deviations in intensity or movement.</span>
<span class="n">art</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">ArtifactDetect</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;art&quot;</span><span class="p">)</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">norm_threshold</span>       <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">zintensity_threshold</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mask_type</span>            <span class="o">=</span> <span class="s">&#39;file&#39;</span>
<span class="n">art</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parameter_source</span>     <span class="o">=</span> <span class="s">&#39;SPM&#39;</span>

<span class="c">#Node: BBRegister - to coregister the mean functional image generated by realign</span>
<span class="c">#      to the subjects&#39; surfaces.</span>
<span class="n">bbregister</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">BBRegister</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;bbregister&#39;</span><span class="p">)</span>
<span class="n">bbregister</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="s">&#39;fsl&#39;</span>
<span class="n">bbregister</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrast_type</span> <span class="o">=</span> <span class="s">&#39;t2&#39;</span>

<span class="c">#Node: Smooth - The volume smoothing option performs a standard SPM smoothing</span>
<span class="n">volsmooth</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">Smooth</span><span class="p">(),</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;volsmooth&quot;</span><span class="p">)</span>
<span class="n">volsmooth</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c">#Node: FreeSurferSource - The get specifc files from the freesurfer folder</span>
<span class="n">fssource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">FreeSurferSource</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fssource&#39;</span><span class="p">)</span>
<span class="n">fssource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">subjects_dir</span>

<span class="c">#Node: Binarize -  to binarize the aseg file for the dilation</span>
<span class="n">binarize</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">Binarize</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;binarize&#39;</span><span class="p">)</span>
<span class="n">binarize</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">binarize</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_type</span> <span class="o">=</span> <span class="s">&#39;nii&#39;</span>

<span class="c">#Node: DilateImage - to dilate the binarized aseg file and use it as a mask</span>
<span class="n">dilate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">DilateImage</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;dilate&#39;</span><span class="p">)</span>
<span class="n">dilate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="s">&#39;max&#39;</span>
<span class="n">dilate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s">&#39;NIFTI&#39;</span>

<span class="c">#Connect up the preprocessing components</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">sliceTiming</span><span class="p">,</span> <span class="n">realign</span><span class="p">,[(</span><span class="s">&#39;timecorrected_files&#39;</span><span class="p">,</span> <span class="s">&#39;in_files&#39;</span><span class="p">)]),</span>
                 <span class="p">(</span><span class="n">realign</span><span class="p">,</span> <span class="n">bbregister</span><span class="p">,[(</span><span class="s">&#39;mean_image&#39;</span><span class="p">,</span> <span class="s">&#39;source_file&#39;</span><span class="p">)]),</span>
                 <span class="p">(</span><span class="n">realign</span><span class="p">,</span> <span class="n">volsmooth</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;realigned_files&#39;</span><span class="p">,</span> <span class="s">&#39;in_files&#39;</span><span class="p">)]),</span>
                 <span class="p">(</span><span class="n">realign</span><span class="p">,</span> <span class="n">art</span><span class="p">,[(</span><span class="s">&#39;realignment_parameters&#39;</span><span class="p">,</span><span class="s">&#39;realignment_parameters&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s">&#39;mean_image&#39;</span><span class="p">,</span> <span class="s">&#39;mask_file&#39;</span><span class="p">),</span>
                                <span class="p">]),</span>
                 <span class="p">(</span><span class="n">volsmooth</span><span class="p">,</span><span class="n">art</span><span class="p">,[(</span><span class="s">&#39;smoothed_files&#39;</span><span class="p">,</span><span class="s">&#39;realigned_files&#39;</span><span class="p">),</span>
                                 <span class="p">]),</span>
                 <span class="p">(</span><span class="n">fssource</span><span class="p">,</span> <span class="n">binarize</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;aseg&#39;</span><span class="p">,</span><span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                 <span class="p">(</span><span class="n">binarize</span><span class="p">,</span> <span class="n">dilate</span><span class="p">,[(</span><span class="s">&#39;binary_file&#39;</span><span class="p">,</span><span class="s">&#39;in_file&#39;</span><span class="p">)]),</span>
                 <span class="p">(</span><span class="n">realign</span><span class="p">,</span> <span class="n">art</span><span class="p">,[(</span><span class="s">&#39;realignment_parameters&#39;</span><span class="p">,</span><span class="s">&#39;realignment_parameters&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s">&#39;mean_image&#39;</span><span class="p">,</span><span class="s">&#39;mask_file&#39;</span><span class="p">),</span>
                                <span class="p">]),</span>
              <span class="p">])</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are wondering how we knew which parameters to specify and which connections to establish. It is simple: Define or connect all mandatory inputs for each node. All the other optional inputs can be defined as you please and more importantly as your model demands. For more informations go to <a class="reference external" href="http://www.mit.edu/~satra/nipype-nightly/interfaces/index.html">Interfaces and Algorithms</a>.</p>
</div>
</div>
<div class="section" id="define-a-pipeline-for-the-volume-analysis">
<h3>Define a pipeline for the volume analysis<a class="headerlink" href="#define-a-pipeline-for-the-volume-analysis" title="Permalink to this headline">¶</a></h3>
<p>We than define the pipeline for the volume analysis with a node for model specification, first level design, parameter estimation and contrast estimation.</p>
<div class="highlight-py"><div class="highlight"><pre><span class="c">#Initiation of the volume analysis workflow</span>
<span class="n">volanalysis</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;volanalysis&#39;</span><span class="p">)</span>

<span class="c">#Node: SpecifyModel - Generate SPM-specific design information</span>
<span class="n">modelspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">SpecifySparseModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span> <span class="s">&quot;modelspec&quot;</span><span class="p">)</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_units</span>             <span class="o">=</span> <span class="s">&#39;secs&#39;</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">time_repetition</span>         <span class="o">=</span> <span class="mf">8.</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">high_pass_filter_cutoff</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">model_hrf</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">scale_regressors</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">scan_onset</span> <span class="o">=</span> <span class="mf">4.</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stimuli_as_impulses</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">time_acquisition</span> <span class="o">=</span> <span class="mf">2.</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">use_temporal_deriv</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">volumes_in_cluster</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c">#Node: Level1Design - Generate a first level SPM.mat file for analysis</span>
<span class="n">level1design</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">Level1Design</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span> <span class="s">&quot;level1design&quot;</span><span class="p">)</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">bases</span>              <span class="o">=</span> <span class="p">{</span><span class="s">&#39;hrf&#39;</span><span class="p">:{</span><span class="s">&#39;derivs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]}}</span>
<span class="c">#level1design.inputs.bases              = {&#39;fir&#39;:{&#39;length&#39;:3, &#39;order&#39; : 1}}</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">timing_units</span>       <span class="o">=</span> <span class="s">&#39;secs&#39;</span>
<span class="n">level1design</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interscan_interval</span> <span class="o">=</span> <span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">time_repetition</span>

<span class="c">#Node: EstimateModel - to determine the parameters of the model</span>
<span class="n">level1estimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">spm</span><span class="o">.</span><span class="n">EstimateModel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;level1estimate&quot;</span><span class="p">)</span>
<span class="n">level1estimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">estimation_method</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Classical&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="c">#Node: EstimateContrast - to estimate the first level contrasts we define later</span>
<span class="n">contrastestimate</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">spm</span><span class="o">.</span><span class="n">EstimateContrast</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;contrastestimate&quot;</span><span class="p">)</span>

<span class="c">#Connect up the volume analysis components</span>
<span class="n">volanalysis</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">modelspec</span><span class="p">,</span><span class="n">level1design</span><span class="p">,[(</span><span class="s">&#39;session_info&#39;</span><span class="p">,</span><span class="s">&#39;session_info&#39;</span><span class="p">)]),</span>
                     <span class="p">(</span><span class="n">level1design</span><span class="p">,</span><span class="n">level1estimate</span><span class="p">,[(</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">,</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">)]),</span>
                     <span class="p">(</span><span class="n">level1estimate</span><span class="p">,</span><span class="n">contrastestimate</span><span class="p">,[(</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">,</span><span class="s">&#39;spm_mat_file&#39;</span><span class="p">),</span>
                                                       <span class="p">(</span><span class="s">&#39;beta_images&#39;</span><span class="p">,</span><span class="s">&#39;beta_images&#39;</span><span class="p">),</span>
                                                       <span class="p">(</span><span class="s">&#39;residual_image&#39;</span><span class="p">,</span>
                                                        <span class="s">&#39;residual_image&#39;</span><span class="p">)]),</span>
                     <span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="define-a-framework-workflow-that-contains-the-preprocess-and-the-volume-analysis">
<h3>Define a framework workflow that contains the preprocess and the volume analysis<a class="headerlink" href="#define-a-framework-workflow-that-contains-the-preprocess-and-the-volume-analysis" title="Permalink to this headline">¶</a></h3>
<p>As we planed at the beginning we now want to integrate those two pipelines into a bigger framework workflow and want to add an inputnode that feeds these pipelines with parameters.</p>
<div class="highlight-py"><div class="highlight"><pre><span class="c">#Initiation of the framework workflow</span>
<span class="n">frameflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;frameflow&#39;</span><span class="p">)</span>

<span class="c">#Node: Inputnode - For this workflow the only necessary inputs are the functional</span>
<span class="c">#      images, a freesurfer subject id corresponding to recon-all processed data,</span>
<span class="c">#      the session information for the functional runs and the contrasts to be evaluated.</span>
<span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">,</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span>
                                                             <span class="s">&#39;session_info&#39;</span><span class="p">,</span><span class="s">&#39;contrasts&#39;</span><span class="p">]),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">&#39;inputnode&#39;</span><span class="p">)</span>

<span class="c">#Connect up the components into an integrated workflow.</span>
<span class="n">frameflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">inputnode</span><span class="p">,</span><span class="n">preproc</span><span class="p">,[(</span><span class="s">&#39;func&#39;</span><span class="p">,</span><span class="s">&#39;sliceTiming.in_files&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;bbregister.subject_id&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;fssource.subject_id&#39;</span><span class="p">),</span>
                                       <span class="p">]),</span>
                   <span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="n">volanalysis</span><span class="p">,[(</span><span class="s">&#39;session_info&#39;</span><span class="p">,</span><span class="s">&#39;modelspec.subject_info&#39;</span><span class="p">),</span>
                                            <span class="p">(</span><span class="s">&#39;contrasts&#39;</span><span class="p">,</span><span class="s">&#39;contrastestimate.contrasts&#39;</span><span class="p">),</span>
                                            <span class="p">]),</span>
                   <span class="p">(</span><span class="n">preproc</span><span class="p">,</span> <span class="n">volanalysis</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;realign.realignment_parameters&#39;</span><span class="p">,</span>
                                            <span class="s">&#39;modelspec.realignment_parameters&#39;</span><span class="p">),</span>
                                           <span class="p">(</span><span class="s">&#39;volsmooth.smoothed_files&#39;</span><span class="p">,</span>
                                            <span class="s">&#39;modelspec.functional_runs&#39;</span><span class="p">),</span>
                                           <span class="p">(</span><span class="s">&#39;art.outlier_files&#39;</span><span class="p">,</span>
                                            <span class="s">&#39;modelspec.outlier_files&#39;</span><span class="p">),</span>
                                           <span class="p">(</span><span class="s">&#39;dilate.out_file&#39;</span><span class="p">,</span><span class="s">&#39;level1design.mask_image&#39;</span><span class="p">),</span>
                                           <span class="p">])</span>
                   <span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="define-infosource-datagrabber-and-datasink">
<h3>Define infosource, datagrabber and datasink<a class="headerlink" href="#define-infosource-datagrabber-and-datasink" title="Permalink to this headline">¶</a></h3>
<p>We now have to create the infosource that defines the subjectlist, the datagrabber that grabbs the input and the datasink which defines where we want to store the important output at.</p>
<div class="highlight-py"><div class="highlight"><pre><span class="c">#Node: Infosource - we use IdentityInterface to creat our own node, to specify</span>
<span class="c">#      the list of subjects the pipeline should be executed on</span>
<span class="n">infosource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">]),</span>
                     <span class="n">name</span><span class="o">=</span><span class="s">&quot;infosource&quot;</span><span class="p">)</span>
<span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjects</span><span class="p">)</span>

<span class="c">#Node: DataGrabber - To grab the input data</span>
<span class="n">datasource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">],</span>
                                               <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">,</span> <span class="s">&#39;struct&#39;</span><span class="p">]),</span>
                     <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;datasource&#39;</span><span class="p">)</span>

<span class="c">#Define the main folder where the data is stored at and define the structure of it</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s">&#39;data/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.nii&#39;</span>

<span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="p">[[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">sessions</span><span class="p">]],</span>
            <span class="n">struct</span><span class="o">=</span><span class="p">[[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;struct&#39;</span><span class="p">]])</span>

<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="n">info</span>

<span class="c">#Node: Datasink - Create a datasink node to store important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;datasink&quot;</span><span class="p">)</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">experiment_dir</span>

<span class="c">#Define where the datasink input should be stored at</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">nameOflevel1Out</span>
</pre></div>
</div>
</div>
<div class="section" id="define-contrasts-and-model-specification">
<h3>Define contrasts and model specification<a class="headerlink" href="#define-contrasts-and-model-specification" title="Permalink to this headline">¶</a></h3>
<p>We now set up the model specific components like contrasts, names of conditions, parametric modulators onset, duration of a trial etc.</p>
<div class="highlight-py"><div class="highlight"><pre><span class="c">#Names of the conditions</span>
<span class="n">namesOfConditions</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;basic&#39;</span><span class="p">,</span><span class="s">&#39;condition1&#39;</span><span class="p">,</span><span class="s">&#39;condition2&#39;</span><span class="p">,</span><span class="s">&#39;condition3&#39;</span><span class="p">]</span>

<span class="c">#Define different contrasts</span>
<span class="n">cont1</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;basic vs. conditions&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="n">namesOfConditions</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cont2</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;all vs. condition1&#39;</span><span class="p">,</span>  <span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="n">namesOfConditions</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cont3</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;all vs. condition2&#39;</span><span class="p">,</span>  <span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="n">namesOfConditions</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cont4</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;all vs. condition3&#39;</span><span class="p">,</span>  <span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="n">namesOfConditions</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cont5</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;session1 vs session2&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="n">namesOfConditions</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c">#store all contrasts into a list...</span>
<span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">cont1</span><span class="p">,</span> <span class="n">cont2</span><span class="p">,</span> <span class="n">cont3</span><span class="p">,</span> <span class="n">cont4</span><span class="p">,</span> <span class="n">cont5</span><span class="p">]</span>

<span class="c">#...and feed those contrasts to the inputnode filed &#39;contrasts&#39;</span>
<span class="n">frameflow</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputnode</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="n">contrasts</span>

<span class="c">#Function: Subjectinfo - This function returns subject-specific information about</span>
<span class="c">#          the experimental paradigm. This is used by the SpecifyModel function</span>
<span class="c">#          to create the information necessary to generate an SPM design matrix.</span>
<span class="k">def</span> <span class="nf">subjectinfo</span><span class="p">(</span><span class="n">subject_id</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="n">Bunch</span>

    <span class="n">namesOfConditions</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;basic&#39;</span><span class="p">,</span><span class="s">&#39;condition1&#39;</span><span class="p">,</span><span class="s">&#39;condition2&#39;</span><span class="p">,</span><span class="s">&#39;condition3&#39;</span><span class="p">]</span>

    <span class="c">#Onset Times in seconds</span>
    <span class="n">onsetTimes</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mf">49.6</span><span class="p">,</span><span class="mf">66.1</span><span class="p">,</span><span class="mf">74.1</span><span class="p">,</span><span class="mf">97.6</span><span class="p">,</span><span class="mf">113.6</span><span class="p">,</span><span class="mf">122.2</span><span class="p">,</span><span class="mf">130.2</span><span class="p">,</span><span class="mf">137.2</span><span class="p">,</span><span class="mf">153.7</span><span class="p">,</span><span class="mf">169.2</span><span class="p">,</span>
                   <span class="mf">185.7</span><span class="p">,</span><span class="mf">201.8</span><span class="p">,</span><span class="mf">290.4</span><span class="p">,</span><span class="mf">313.4</span><span class="p">,</span><span class="mf">321.4</span><span class="p">,</span><span class="mf">377.5</span><span class="p">,</span><span class="mf">401.5</span><span class="p">,</span><span class="mi">410</span><span class="p">,</span><span class="mf">418.6</span><span class="p">,</span><span class="mf">442.1</span><span class="p">,</span><span class="mf">473.6</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">17.5</span><span class="p">,</span><span class="mf">82.1</span><span class="p">,</span><span class="mf">89.6</span><span class="p">,</span><span class="mf">145.2</span><span class="p">,</span><span class="mf">225.3</span><span class="p">,</span><span class="mf">242.3</span><span class="p">,</span><span class="mf">281.4</span><span class="p">,</span><span class="mf">426.6</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">26</span><span class="p">,</span><span class="mf">162.2</span><span class="p">,</span><span class="mf">209.3</span><span class="p">,</span><span class="mf">249.3</span><span class="p">,</span><span class="mf">265.9</span><span class="p">,</span><span class="mf">205.4</span><span class="p">,</span><span class="mf">450.1</span><span class="p">,</span><span class="mi">386</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">34</span><span class="p">,</span><span class="mf">273.4</span><span class="p">,</span><span class="mf">329.5</span><span class="p">,</span><span class="mf">338.5</span><span class="p">,</span><span class="mi">354</span><span class="p">,</span><span class="mi">362</span><span class="p">,</span><span class="mi">370</span><span class="p">,</span><span class="mf">466.4</span><span class="p">]</span>
                  <span class="p">]</span>

    <span class="c">#Define the parametric modulators</span>
    <span class="n">para_modu</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">Bunch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;target2&#39;</span><span class="p">,</span><span class="s">&#39;target3&#39;</span><span class="p">],</span> <span class="n">poly</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]],</span>
                       <span class="n">param</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span>
                 <span class="n">Bunch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;target2&#39;</span><span class="p">,</span><span class="s">&#39;target3&#39;</span><span class="p">],</span> <span class="n">poly</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]],</span>
                       <span class="n">param</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span>
                 <span class="n">Bunch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;target2&#39;</span><span class="p">,</span><span class="s">&#39;target3&#39;</span><span class="p">],</span> <span class="n">poly</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]],</span>
                       <span class="n">param</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]),</span>
                 <span class="p">]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">#We add the model specific parameters twice to the output list because we</span>
    <span class="c">#have 2 functional runs which were performed identical.</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Bunch</span><span class="p">(</span><span class="n">conditions</span><span class="o">=</span><span class="n">namesOfConditions</span><span class="p">,</span>
                            <span class="n">onsets</span><span class="o">=</span><span class="n">onsetTimes</span><span class="p">,</span>
                            <span class="n">durations</span><span class="o">=</span><span class="p">[[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">namesOfConditions</span><span class="p">],</span>
                            <span class="n">amplitudes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">tmod</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">pmod</span><span class="o">=</span><span class="n">para_modu</span><span class="p">,</span>
                            <span class="n">regressor_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">regressors</span><span class="o">=</span><span class="bp">None</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">output</span>  <span class="c">#this output will later be returned to inputnode.session_info</span>
</pre></div>
</div>
</div>
<div class="section" id="define-the-meta-pipeline">
<h3>Define the meta pipeline<a class="headerlink" href="#define-the-meta-pipeline" title="Permalink to this headline">¶</a></h3>
<p>After setting up all the nodes, parameters and subpipelines, we now want to creat the pipeline that contains everything. The one that gets executed at the end.</p>
<div class="highlight-py"><div class="highlight"><pre><span class="c">#Initiation of the metaflow</span>
<span class="n">metaflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;metaflow&quot;</span><span class="p">)</span>

<span class="c">#Define where the workingdir of the metaflow should be stored at</span>
<span class="n">metaflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">experiment_dir</span> <span class="o">+</span> <span class="n">nameOfWorkingdir</span>

<span class="c">#Connect up all components</span>
<span class="n">metaflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="n">frameflow</span><span class="p">,[(</span><span class="s">&#39;func&#39;</span><span class="p">,</span><span class="s">&#39;inputnode.func&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">infosource</span><span class="p">,</span><span class="n">frameflow</span><span class="p">,[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span><span class="s">&#39;inputnode.subject_id&#39;</span><span class="p">),</span>
                                         <span class="p">((</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjectinfo</span><span class="p">),</span>
                                           <span class="s">&#39;inputnode.session_info&#39;</span><span class="p">),</span>
                                         <span class="p">]),</span>
                  <span class="p">(</span><span class="n">frameflow</span><span class="p">,</span><span class="n">datasink</span><span class="p">,[(</span><span class="s">&#39;preproc.bbregister.out_reg_file&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;bbregister&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s">&#39;volanalysis.contrastestimate.spm_mat_file&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;vol_contrasts.@spm_mat&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s">&#39;volanalysis.contrastestimate.spmT_images&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;vol_contrasts.@T&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s">&#39;volanalysis.contrastestimate.con_images&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;vol_contrasts.@con&#39;</span><span class="p">),</span>
                                       <span class="p">])</span>
                  <span class="p">])</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some may wonder what the <tt class="docutils literal"><span class="pre">&#64;spm_mat</span></tt>, <tt class="docutils literal"><span class="pre">&#64;T</span></tt> and <tt class="docutils literal"><span class="pre">&#64;con</span></tt> cause in the connection between the <strong>frameflow</strong> and the <strong>datasink</strong>. This specification means that all the <tt class="docutils literal"><span class="pre">spm_mat_file</span></tt>, <tt class="docutils literal"><span class="pre">spmT_images</span></tt> and <tt class="docutils literal"><span class="pre">con_images</span></tt> files all get saved into the same <strong>datasink</strong> folder with the name <tt class="docutils literal"><span class="pre">vol_contrasts</span></tt>. The <tt class="docutils literal"><span class="pre">.&#64;id</span></tt> just specifies an identifier for the saving process.</p>
</div>
</div>
<div class="section" id="run-the-pipeline-and-generate-the-graph">
<h3>Run the pipeline and generate the graph<a class="headerlink" href="#run-the-pipeline-and-generate-the-graph" title="Permalink to this headline">¶</a></h3>
<p>Finally, after everything is set up correctly we can run the pipeline and let it draw the two graphs.</p>
<div class="highlight-py"><div class="highlight"><pre><span class="c">#Run the analysis pipeline and create the two graphs that visually represents the workflow.</span>
<span class="n">metaflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s">&#39;flat&#39;</span><span class="p">)</span>
<span class="n">metaflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;n_procs&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="visualization-of-the-metaflow">
<h2>Visualization of the metaflow<a class="headerlink" href="#visualization-of-the-metaflow" title="Permalink to this headline">¶</a></h2>
<p>Here are now the basic and the detailed graph of this example of our meta pipeline. Both graphs were created with the graph2use parameter set to &#8216;flat&#8217;. The coloring was done additionally to underline the structure of the whole workflow.</p>
<div class="section" id="basic-graph">
<h3>Basic graph<a class="headerlink" href="#basic-graph" title="Permalink to this headline">¶</a></h3>
<p>The basic graph showes how the nodes are connected to each other.</p>
<img alt="_images/graph_first_basic.png" class="align-center" src="_images/graph_first_basic.png" style="width: 1080px;" />
</div>
<div class="section" id="detailed-graph">
<h3>Detailed graph<a class="headerlink" href="#detailed-graph" title="Permalink to this headline">¶</a></h3>
<p>The detailed graph shows how the different inputs and outputs of each individual nodes are connected to each other.</p>
<img alt="_images/graph_first_detailed.png" class="align-center" src="_images/graph_first_detailed.png" style="width: 1080px;" />
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="underConstruction.html" title="Under construction"
             >next</a> |</li>
        <li class="right" >
          <a href="preparedata.html" title="Prepare Data for Nipype"
             >previous</a> |</li>
        <li><a href="index.html">Beginner&#39;s Guide to Nipype v0.4 v0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Michael Notter.
      Last updated on August 04, 2011.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.1.
    </div>
  </body>
</html>